<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Next Trip Card — Proto V8</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,1,0" rel="stylesheet">
<style>
  :root {
    --font: 'Source Sans 3', 'Source Sans Pro', sans-serif;
    --black: #00050A; --white: #FFFFFF;
    --blue-50: #F2FBFF; --blue-75: #E5F8FF; --blue-100: #CCEEFE;
    --blue-200: #99DDFE; --blue-300: #66CBFD; --blue-400: #33BAFD;
    --blue-500: #00A9FC; --blue-600: #0087CA; --blue-700: #006597; --blue-800: #004465;
    --green-50: #F4FDFA; --green-100: #D3F7EC; --green-200: #A7EFD9;
    --green-500: #22D7A1; --green-600: #1BAC81; --green-700: #148161;
    --red-50: #FFF6F7; --red-100: #FFDADD; --red-400: #FF6C79; --red-500: #FF4757;
    --orange-50: #FFF4EE; --orange-100: #FFE8DD; --orange-500: #FF8D54; --orange-600: #CC7143;
    --yellow-50: #FFFCF2; --yellow-500: #FFBE00;
    --grey-50: #F8FAFF; --grey-75: #EEF0F5; --grey-100: #E4E6EB;
    --grey-200: #D0D2D7; --grey-300: #B2B4B9; --grey-400: #9EA0A5;
    --grey-500: #808287; --grey-600: #6C6E73; --grey-700: #4E5055;
    --grey-800: #3A3C41; --grey-900: #1C1E23;
    --radius-xs: 12px; --radius-sm: 24px; --radius-pill: 9999px;
    --stroke-sm: 1px; --stroke-md: 1.5px; --stroke-lg: 2.5px;
    --shadow-card: 4px 4px 16px rgba(228,230,235,0.4);
    --shadow-accent: 0 4px 20px rgba(0,169,252,0.15);
    --ease: cubic-bezier(0.4, 0, 0.2, 1);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--white); color: var(--black); line-height: 1.5; padding: 0 16px 16px; -webkit-font-smoothing: antialiased; }

  /* ===== Demo Controls ===== */
  .demo-controls { max-width: 960px; margin: 0 auto 12px; padding: 10px 14px; background: var(--white); border-radius: var(--radius-xs); border: var(--stroke-sm) solid var(--grey-100); display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
  .demo-controls label { font-size: 10px; font-weight: 700; color: var(--grey-500); text-transform: uppercase; letter-spacing: 0.5px; }
  .demo-controls button { padding: 3px 9px; border: var(--stroke-md) solid var(--grey-100); border-radius: 7px; background: var(--white); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; color: var(--grey-700); font-family: var(--font); }
  .demo-controls button:hover { background: var(--grey-50); border-color: var(--grey-200); }
  .demo-controls button.active { background: var(--black); color: var(--white); border-color: var(--black); }
  .demo-controls .sep { width: 1px; height: 18px; background: var(--grey-100); margin: 0 3px; }
  .demo-controls select { padding: 3px 7px; border: var(--stroke-md) solid var(--grey-100); border-radius: 7px; font-size: 10px; background: var(--white); color: var(--grey-700); font-family: var(--font); }

  /* ===== Trip Card shell ===== */
  .trip-card { max-width: 640px; margin: 0 auto; background: none; border: none; border-radius: 0; overflow: visible; transition: all 0.3s var(--ease); box-shadow: none; }
  .trip-card:has(.stepper-bold) { max-width: 900px; }
  .card-inner { padding: 18px 22px 14px; }

  /* ===== Header ===== */
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .header-left { flex: 1; min-width: 0; }
  .headline-row { display: flex; align-items: center; gap: 8px; }
  .state-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; background: var(--grey-300); }
  .state-upcoming .state-dot { background: var(--blue-400); }
  .state-imminent .state-dot { background: var(--blue-500); animation: pulse-dot 2s ease-in-out infinite; }
  .state-in_transit .state-dot { background: var(--blue-500); animation: pulse-dot 1.5s ease-in-out infinite; }
  .state-between_segments .state-dot { background: var(--green-500); }
  .state-trip_ending .state-dot { background: var(--green-500); }
  @keyframes pulse-dot { 0%,100%{ box-shadow:0 0 0 0 rgba(0,169,252,0.4); } 50%{ box-shadow:0 0 0 5px rgba(0,169,252,0); } }
  .headline { font-size: 17px; font-weight: 700; color: var(--black); line-height: 1.2; }
  .state-imminent .headline, .state-in_transit .headline { color: var(--blue-800); }
  .state-trip_ending .headline { color: var(--green-700); }
  .co-travelers { font-size: 11px; color: var(--grey-500); margin-top: 1px; margin-left: 17px; }
  .header-link { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: var(--grey-500); text-decoration: none; padding: 5px 10px; border-radius: 7px; border: var(--stroke-md) solid var(--grey-100); transition: all 0.15s; white-space: nowrap; flex-shrink: 0; margin-left: 12px; font-family: var(--font); }
  .header-link:hover { background: var(--grey-50); border-color: var(--grey-200); color: var(--black); }

  /* ===== Stepper ===== */
  .stepper { display: flex; align-items: flex-start; margin-bottom: 14px; }
  .stepper.hidden { display: none; }
  .stepper-step { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; padding: 3px 0; border-radius: 10px; transition: all 0.2s; }
  .stepper-step:hover { background: var(--grey-50); }
  .stepper-step.active:hover { background: var(--blue-50); }
  .stepper-step.completed { opacity: 0.5; }
  .stepper-step.completed:hover { opacity: 0.8; background: var(--grey-50); }
  .stepper-step.completed.viewing { opacity: 0.85; }
  .stepper-dot-row { display: flex; align-items: center; width: 100%; position: relative; height: 34px; }
  .stepper-dot { width: 30px; height: 30px; border-radius: 50%; border: 2.5px solid var(--grey-200); background: var(--white); position: relative; z-index: 2; flex-shrink: 0; margin: 0 auto; transition: all 0.3s var(--ease); display: flex; align-items: center; justify-content: center; font-size: 15px; }
  .stepper-step.completed .stepper-dot { background: var(--green-500); border-color: var(--green-500); }
  .stepper-step.active .stepper-dot { border-color: var(--blue-500); background: var(--blue-500); width: 34px; height: 34px; box-shadow: 0 0 0 4px rgba(0,169,252,0.12); }
  .stepper-check { color: var(--white); font-size: 12px; font-weight: 800; }
  .stepper-line { position: absolute; top: 50%; left: calc(50% + 18px); right: calc(-50% + 18px); height: 3px; background: var(--grey-100); transform: translateY(-50%); z-index: 1; border-radius: 3px; }
  .stepper-step:last-child .stepper-line { display: none; }
  .stepper-step.completed .stepper-line { background: var(--green-500); }
  .stepper-step.active.transit .stepper-line { overflow: hidden; }
  .stepper-step.active.transit .stepper-line::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, var(--blue-500) 40%, var(--grey-100) 60%); animation: transit-slide 2.5s ease-in-out infinite; }
  @keyframes transit-slide { 0%{ transform:translateX(-60%); } 100%{ transform:translateX(60%); } }
  .stepper-label { font-size: 12px; font-weight: 700; color: var(--grey-700); margin-top: 6px; text-align: center; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; padding: 0 4px; }
  .stepper-date { font-size: 10px; color: var(--grey-400); margin-top: 2px; text-align: center; font-weight: 500; }
  .stepper-step.completed .stepper-label { color: var(--grey-400); text-decoration: line-through; text-decoration-color: var(--grey-300); }
  .stepper-step.completed .stepper-date { color: var(--grey-300); }
  .stepper-step.active .stepper-label { color: var(--blue-700); }
  .stepper-step.active .stepper-date { color: var(--blue-500); }

  /* ===== Modern Stepper (dark/bold mode) — no heavy bg, dark dots on white card ===== */
  .stepper.stepper-dark { margin-bottom: 10px; }
  .stepper.stepper-dark .stepper-step:hover { background: var(--grey-50); }
  .stepper.stepper-dark .stepper-step.active:hover { background: var(--blue-50); }
  .stepper.stepper-dark .stepper-step.completed { opacity: 0.55; }
  .stepper.stepper-dark .stepper-step.completed:hover { opacity: 0.8; }
  .stepper.stepper-dark .stepper-dot-row { height: 38px; }
  .stepper.stepper-dark .stepper-dot { width: 26px; height: 26px; background: var(--grey-800); border: none; transition: all 0.35s var(--ease); }
  .stepper.stepper-dark .stepper-dot .material-symbols-rounded { font-size: 14px; color: rgba(255,255,255,0.85); }
  .stepper.stepper-dark .stepper-step.completed .stepper-dot { background: var(--green-500); }
  .stepper.stepper-dark .stepper-step.completed .stepper-dot .material-symbols-rounded { font-size: 13px; color: #fff; }
  .stepper.stepper-dark .stepper-step.active .stepper-dot { width: 36px; height: 36px; background: var(--blue-500); box-shadow: 0 0 0 4px rgba(0,169,252,0.15); }
  .stepper.stepper-dark .stepper-step.active .stepper-dot .material-symbols-rounded { font-size: 18px; color: #fff; }
  .stepper.stepper-dark .stepper-line { background: var(--grey-100); height: 2px; left: calc(50% + 15px); right: calc(-50% + 15px); }
  .stepper.stepper-dark .stepper-step.completed .stepper-line { background: var(--green-200); }
  .stepper.stepper-dark .stepper-step.active.transit .stepper-line::after { background: linear-gradient(90deg, var(--blue-400) 40%, var(--grey-100) 60%); }
  .stepper.stepper-dark .stepper-label { color: var(--grey-700); font-size: 11px; }
  .stepper.stepper-dark .stepper-step.active .stepper-label { color: var(--blue-700); font-size: 12px; font-weight: 800; }
  .stepper.stepper-dark .stepper-date { color: var(--grey-400); font-size: 9px; }
  .stepper.stepper-dark .stepper-step.active .stepper-date { color: var(--blue-500); }
  .stepper.stepper-dark .stepper-step.completed .stepper-label { color: var(--grey-400); }
  .stepper.stepper-dark .stepper-step.completed .stepper-date { color: var(--grey-300); }
  .stepper-status { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: var(--blue-500); text-align: center; margin-top: 1px; opacity: 0.8; }
  .stepper-step.completed .stepper-status { color: var(--green-500); }

  /* ===== Bold Stepper — expanded active, graceful rest ===== */
  .stepper.stepper-bold { gap: 0; align-items: flex-start; }
  .stepper.stepper-bold .stepper-step { flex: 0.85; transition: flex 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s; min-width: 0; }
  .stepper.stepper-bold .stepper-step.active { flex: 1.4; }
  /* Inactive: readable but quieter */
  .stepper.stepper-bold .stepper-step:not(.active) { opacity: 0.55; }
  .stepper.stepper-bold .stepper-step:not(.active):hover { opacity: 0.95; }
  .stepper.stepper-bold .stepper-step:not(.active) .stepper-label { font-size: 10.5px; -webkit-line-clamp: 1; }
  .stepper.stepper-bold .stepper-step:not(.active) .stepper-date { font-size: 8.5px; opacity: 0.7; }
  .stepper.stepper-bold .stepper-step:not(.active) .stepper-status { display: none; }
  /* Active: prominent dot + text */
  .stepper.stepper-bold .stepper-step.active .stepper-dot { width: 42px; height: 42px; box-shadow: 0 0 0 5px rgba(0,169,252,0.12), 0 2px 10px rgba(0,169,252,0.18); }
  .stepper.stepper-bold .stepper-step.active .stepper-dot .material-symbols-rounded { font-size: 21px; }
  .stepper.stepper-bold .stepper-step.active .stepper-dot-row { height: 46px; }
  .stepper.stepper-bold .stepper-step.active .stepper-label { font-size: 13px; font-weight: 800; }
  .stepper.stepper-bold .stepper-step.active .stepper-date { font-size: 10px; font-weight: 700; }
  /* Completed inactive: softer */
  .stepper.stepper-bold .stepper-step.completed:not(.active) { opacity: 0.38; }
  .stepper.stepper-bold .stepper-step.completed:not(.active):hover { opacity: 0.7; }
  /* Bold lines — each step draws its own half-segments (no cross-step overflow) */
  .stepper.stepper-bold .stepper-line { display: none; }
  .stepper.stepper-bold .stepper-step::before,
  .stepper.stepper-bold .stepper-step::after {
    content: ''; position: absolute;
    top: 22px; /* 3px pad + 19px (center of 38px inactive dot-row) */
    height: 2px; background: var(--grey-100);
    transform: translateY(-50%); z-index: 0; pointer-events: none;
  }
  .stepper.stepper-bold .stepper-step::before { left: 0; right: calc(50% + 14px); }
  .stepper.stepper-bold .stepper-step::after { left: calc(50% + 14px); right: 0; }
  .stepper.stepper-bold .stepper-step:first-child::before { display: none; }
  .stepper.stepper-bold .stepper-step:last-child::after { display: none; }
  /* Active step: bigger dot → adjust line gap */
  .stepper.stepper-bold .stepper-step.active::before { right: calc(50% + 22px); }
  .stepper.stepper-bold .stepper-step.active::after { left: calc(50% + 22px); }
  /* Completed step: green lines */
  .stepper.stepper-bold .stepper-step.completed::before,
  .stepper.stepper-bold .stepper-step.completed::after { background: var(--green-200); }
  .stepper.stepper-bold .stepper-step.completed + .stepper-step::before { background: var(--green-200); }
  /* Transit animation on active right segment */
  .stepper.stepper-bold .stepper-step.active.transit::after {
    background: linear-gradient(90deg, var(--blue-500) 40%, var(--grey-100) 60%);
    background-size: 250% 100%; animation: bold-transit 2.5s ease-in-out infinite;
  }
  @keyframes bold-transit { 0% { background-position: 100% 0; } 100% { background-position: 0% 0; } }

  /* ===== Bold Desktop — 2-column vertical stepper layout ===== */
  @media (min-width: 641px) {
    /* Grid: header full-width, stepper left, etape right */
    .card-inner:has(.stepper-bold) {
      display: grid;
      grid-template-columns: 220px 1fr;
      grid-template-rows: auto 1fr;
      gap: 0 12px;
      padding: 14px 16px 10px;
    }
    .card-inner:has(.stepper-bold) > .card-header { grid-column: 1 / -1; margin-bottom: 6px; }
    .card-inner:has(.stepper-bold) > .stepper { grid-row: 2; grid-column: 1; align-self: center; }
    .card-inner:has(.stepper-bold) > [id^="etape-"] { grid-row: 2; grid-column: 2; align-self: center; }

    /* Stepper becomes vertical column */
    .stepper.stepper-bold {
      flex-direction: column;
      align-items: stretch;
      gap: 0;
      overflow: visible;
      margin-bottom: 0;
    }
    /* Each step: dot left, text right */
    .stepper.stepper-bold .stepper-step {
      display: grid;
      grid-template-columns: auto 1fr;
      grid-template-rows: auto auto auto;
      gap: 0 10px;
      align-items: center;
      flex: none;
      padding: 8px 6px;
      border-radius: 8px;
    }
    .stepper.stepper-bold .stepper-step.active { flex: none; }
    .stepper.stepper-bold .stepper-dot-row {
      grid-column: 1; grid-row: 1 / -1;
      width: auto; height: auto;
      display: flex; align-items: center; justify-content: center;
    }
    .stepper.stepper-bold .stepper-label {
      grid-column: 2; grid-row: 1;
      text-align: left; margin-top: 0; padding: 0;
      font-size: 12px; font-weight: 700; -webkit-line-clamp: 2;
    }
    .stepper.stepper-bold .stepper-step.active .stepper-label { font-size: 13px; font-weight: 800; }
    .stepper.stepper-bold .stepper-date {
      grid-column: 2; grid-row: 2;
      text-align: left; margin-top: 1px;
      font-size: 11px; font-weight: 600; opacity: 1; color: var(--grey-500);
    }
    .stepper.stepper-bold .stepper-step.active .stepper-date { font-size: 11px; font-weight: 700; color: var(--blue-500); }
    .stepper.stepper-bold .stepper-step:not(.active) .stepper-date { font-size: 11px; opacity: 0.85; }
    .stepper.stepper-bold .stepper-status {
      grid-column: 2; grid-row: 3;
      text-align: left;
    }

    /* Vertical connecting lines (override horizontal pseudo-elements) */
    .stepper.stepper-bold .stepper-step::before,
    .stepper.stepper-bold .stepper-step::after {
      width: 2px; height: auto;
      left: calc(6px + 13px); /* padding-left + half of 26px dot */
      top: auto; bottom: auto; right: auto;
      transform: none;
    }
    .stepper.stepper-bold .stepper-step::before {
      top: 0; bottom: calc(50% + 14px);
      left: calc(6px + 13px); right: auto;
    }
    .stepper.stepper-bold .stepper-step::after {
      top: calc(50% + 14px); bottom: 0;
      left: calc(6px + 13px); right: auto;
    }
    .stepper.stepper-bold .stepper-step:first-child::before { display: none; }
    .stepper.stepper-bold .stepper-step:last-child::after { display: none; }
    /* Active bigger dot (42px) → adjust line gap */
    .stepper.stepper-bold .stepper-step.active::before {
      bottom: calc(50% + 22px); left: calc(6px + 13px); right: auto;
    }
    .stepper.stepper-bold .stepper-step.active::after {
      top: calc(50% + 22px); left: calc(6px + 13px); right: auto;
    }
    /* Vertical transit animation */
    .stepper.stepper-bold .stepper-step.active.transit::after {
      background: linear-gradient(180deg, var(--blue-500) 40%, var(--grey-100) 60%);
      background-size: 100% 250%;
      animation: bold-transit-v 2.5s ease-in-out infinite;
    }
    /* Desktop: only pill + nav buttons are clickable */
    .bpb.tappable .bpb-action-pill,
    .bpb .leg-action-center .bpb-action-pill { cursor: pointer; }
    .bpb .bpb-action-pill:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
    .bpb .bpb-action-pill:active { transform: scale(0.97); }
    /* Bold desktop: prev/next chevrons in header row */
    .bold-nav { display: inline-flex; align-items: center; gap: 4px; margin-left: auto; flex-shrink: 0; }
    .bold-nav-btn { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.45); cursor: pointer; transition: all 0.15s; font-family: var(--font); padding: 0; }
    .bold-nav-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); color: rgba(255,255,255,0.85); }
    .bold-nav-btn:disabled { opacity: 0.2; pointer-events: none; }
    .bold-nav-btn .material-symbols-rounded { font-size: 16px; line-height: 1; }
    .bold-nav-label { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.35); min-width: 24px; text-align: center; }
  }
  @keyframes bold-transit-v { 0% { background-position: 0 100%; } 100% { background-position: 0 0%; } }

  /* ===== Mobile carousel (native scroll-snap) ===== */
  .etape-carousel {
    display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain;
    scrollbar-width: none; gap: 12px; margin: 0 -16px; padding: 0 16px;
  }
  .etape-carousel::-webkit-scrollbar { display: none; }
  .etape-carousel .etape-slide {
    flex: 0 0 calc(100% - 16px); scroll-snap-align: start; min-width: 0;
    min-height: 200px; display: flex; flex-direction: column; justify-content: center;
  }

  /* ===== Étape wrapper ===== */
  .etape-content { transition: all 0.3s var(--ease); }
  .etape-content.is-past { opacity: 0.5; filter: grayscale(0.3); }
  .etape-content.is-past:hover { opacity: 0.7; }
  .etape-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
  .etape-tag { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: var(--radius-pill); }
  .etape-tag.next { background: var(--blue-100); color: var(--blue-800); }
  .etape-tag.current { background: var(--blue-200); color: var(--blue-800); }
  .etape-tag.done { background: var(--green-100); color: var(--green-700); }
  .etape-tag.past { background: var(--grey-75); color: var(--grey-500); }
  .etape-tag.future { background: var(--grey-75); color: var(--grey-600); }

  /* ===== Shared étape card container ===== */
  .ecard { border: 1px solid rgba(130,155,220,0.20); border-radius: 12px; overflow: hidden; margin-bottom: 8px; background: linear-gradient(165deg, #f4f7ff 0%, #e2e8f6 30%, #edf2ff 55%, #dfe6f5 75%, #f0f4fe 100%); box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 3px 14px rgba(90,120,200,0.08); }

  /* ===== Transport — Boarding Pass ===== */
  .bp { position: relative; border: 1px solid rgba(130,155,220,0.20); border-radius: 14px; background: linear-gradient(165deg, #f4f7ff 0%, #e2e8f6 30%, #edf2ff 55%, #dfe6f5 75%, #f0f4fe 100%); margin-bottom: 6px; overflow: visible; box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 3px 14px rgba(90,120,200,0.08); }
  .bp-head { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px 6px; }
  .bp-carrier { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 700; color: var(--black); }
  .bp-carrier-icon { font-size: 15px; }
  .bp-carrier-sub { font-size: 11px; font-weight: 500; color: var(--grey-500); }
  .bp-date { font-size: 11px; font-weight: 600; color: var(--grey-500); }
  /* Calendar date icon (éphéméride) */
  .date-icon { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 8px; background: var(--grey-75); border: 1.5px solid var(--grey-200); flex-shrink: 0; }
  .date-icon-day { font-size: 16px; font-weight: 800; color: var(--black); line-height: 1; }
  .date-icon-month { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--blue-600); line-height: 1; margin-top: 1px; }
  /* Tear line + poinçons */
  .bp-tear { position: relative; border-top: 1.5px dashed var(--grey-200); margin: 0 12px; }
  .bp-tear::before, .bp-tear::after { content: ''; position: absolute; top: -10px; width: 20px; height: 20px; border-radius: 50%; background: var(--grey-50); border: 1.5px solid var(--grey-50); z-index: 2; }
  .bp-tear::before { left: -23px; }
  .bp-tear::after { right: -23px; }
  .state-imminent .bp-tear::before, .state-imminent .bp-tear::after { background: var(--grey-50); border-color: var(--grey-50); }
  .state-in_transit .bp-tear::before, .state-in_transit .bp-tear::after { background: var(--grey-50); border-color: var(--grey-50); }
  .state-trip_ending .bp-tear::before, .state-trip_ending .bp-tear::after { background: var(--grey-50); border-color: var(--grey-50); }
  /* Route row */
  .bp-route { display: flex; align-items: flex-start; padding: 10px 14px 6px; gap: 8px; }
  .bp-point { flex: 1; min-width: 0; }
  .bp-point.arr { text-align: right; }
  .bp-time { font-size: 26px; font-weight: 800; color: var(--black); letter-spacing: -1px; line-height: 1; }
  .bp-time .day-offset { font-size: 11px; font-weight: 700; color: var(--orange-500); vertical-align: super; margin-left: 1px; letter-spacing: 0; }
  .is-past .bp-time { color: var(--grey-400); }
  .bp-loc { font-size: 11px; font-weight: 700; color: var(--black); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bp-sub { font-size: 10px; color: var(--grey-600); margin-top: 1px; }
  /* Arrow center */
  .bp-mid { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 8px; min-width: 60px; }
  .bp-arrow-line { width: 100%; height: 2px; background: var(--grey-200); position: relative; border-radius: 1px; }
  .bp-arrow-line::before, .bp-arrow-line::after { content: ''; position: absolute; top: 50%; width: 6px; height: 6px; border-radius: 50%; background: var(--grey-300); transform: translateY(-50%); }
  .bp-arrow-line::before { left: 0; }
  .bp-arrow-line::after { right: 0; }
  .bp-dur { font-size: 10px; font-weight: 600; color: var(--grey-500); white-space: nowrap; margin-top: 3px; }
  /* (info row replaced by .bp-tags above) */
  /* Connection badge (between separate boarding passes) */
  .bp-conn-between { display: flex; align-items: center; justify-content: center; flex-shrink: 0; align-self: center; }
  .bp-conn-chip { display: flex; align-items: center; gap: 3px; padding: 4px 10px; background: var(--orange-50); border: 1px solid var(--orange-100); border-radius: 8px; font-size: 10px; font-weight: 700; color: var(--orange-600); white-space: nowrap; }
  .bp-conn-where { font-size: 9px; font-weight: 500; color: var(--grey-600); white-space: nowrap; text-align: center; }
  .bp-luggage { font-size: 11px; color: var(--grey-500); padding: 2px 0 4px; }
  /* (seat badge styles merged into .bp-tag above) */
  /* Info tags (unified card-style badges: seat, train#, platform, fare, PNR) */
  .bp-tags { display: flex; flex-wrap: wrap; gap: 12px; padding: 4px 14px 8px; align-items: center; }
  .bp-tag-group { display: inline-flex; flex-wrap: wrap; gap: 5px; align-items: center; }
  .bp-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--grey-50); border: 1px solid var(--grey-100); border-radius: 8px; font-size: 11px; color: var(--grey-700); }
  .bp-tag-label { font-size: 9px; font-weight: 600; color: var(--grey-500); text-transform: uppercase; letter-spacing: 0.3px; }
  .bp-tag-value { font-size: 14px; font-weight: 800; color: var(--black); letter-spacing: -0.3px; }
  .bp-tag-value.sm { font-size: 11px; font-weight: 700; letter-spacing: 0; }
  .bp-tag.accent { background: var(--blue-50); border-color: var(--blue-100); }
  .bp-tag.accent .bp-tag-label { color: var(--blue-500); }
  .bp-tag.accent .bp-tag-value { color: var(--blue-800); }
  .bp-tag.warm { background: var(--orange-50); border-color: var(--orange-100); }
  .bp-tag.warm .bp-tag-label { color: var(--orange-500); }
  .bp-tag.warm .bp-tag-value { color: var(--orange-600); }

  /* ===== DARK + BOLD shared base (both use .bpb) ===== */
  .bpb { position: relative; border-radius: 16px; background: linear-gradient(145deg, #1E2330 0%, #262D3F 100%); margin-bottom: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06); }
  .bpb.bpb-navy { background: linear-gradient(145deg, #141B2D 0%, #1C2541 100%); }
  .bpb-head { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 14px 0; gap: 8px; }
  .bpb-carrier { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.9); min-width: 0; flex: 1; overflow: hidden; }
  .bpb-carrier .bp-carrier-icon { font-size: 14px; }
  .bpb-carrier .bp-carrier-sub { color: rgba(255,255,255,0.7); font-size: 10px; font-weight: 500; }
  .bpb .date-icon { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.15); }
  .bpb .date-icon-day { color: #fff; }
  .bpb .date-icon-month { color: rgba(255,255,255,0.7); }
  .bpb-head-right { text-align: right; flex-shrink: 0; }
  .bpb-date { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.85); margin-right: 6px; }
  .bpb-num { font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.9); display: block; letter-spacing: -0.2px; }
  .bpb-ref { font-size: 9px; font-weight: 600; color: rgba(255,255,255,0.45); display: block; margin-top: 2px; }
  .bpb-route { display: flex; align-items: center; padding: 6px 14px 8px; gap: 6px; }
  .bpb-hero { flex: 1; min-width: 0; }
  .bpb-hero.arr { text-align: right; }
  .bpb-code { font-size: 28px; font-weight: 800; color: #FFFFFF; letter-spacing: -1px; line-height: 1; }
  .bpb-code .day-offset { font-size: 13px; font-weight: 700; color: rgba(255,141,84,0.8); vertical-align: super; margin-left: 1px; letter-spacing: 0; }
  .bpb-time { font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.8); margin-top: 3px; }
  .bpb-name { font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px; font-weight: 500; }
  .bpb-mid { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 70px; }
  .bpb-mid-row { display: flex; align-items: center; width: calc(100% + 24px); margin: 0 -12px; }
  .bpb-mid-line { flex: 1; height: 2px; background: rgba(255,255,255,0.25); position: relative; border-radius: 1px; }
  .bpb-mid-line:first-child::before, .bpb-mid-line:last-child::after { content: ''; position: absolute; top: 50%; width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.35); transform: translateY(-50%); }
  .bpb-mid-line:first-child::before { left: 0; }
  .bpb-mid-line:last-child::after { right: 0; }
  .bpb-mid-badge { display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin: 0 6px; gap: 4px; white-space: nowrap; background: none; border: none; }
  .bpb-mid-badge .material-symbols-rounded { font-size: 15px; color: rgba(255,255,255,0.45); line-height: 1; }
  .bpb-mid-badge .mid-label { font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.55); letter-spacing: -0.2px; }
  .bpb-dur { font-size: 10px; font-weight: 700; color: rgba(255,200,120,0.85); padding: 4px 14px 2px; display: flex; align-items: center; gap: 4px; }
  .bpb-dur .material-symbols-rounded { font-size: 14px; color: rgba(255,180,80,0.9); }
  .bpb-action-pill { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; margin-top: 3px; border-radius: 6px; font-size: 9px; font-weight: 800; background: rgba(255,255,255,0.20); color: rgba(255,255,255,0.85); border: 1px solid rgba(255,255,255,0.25); letter-spacing: 0.6px; text-transform: uppercase; font-family: var(--font); white-space: nowrap; transition: transform 0.15s, box-shadow 0.15s; }
  .bpb-action-pill svg { width: 10px; height: 10px; fill: currentColor; }
  .bpb-action-pill .material-symbols-rounded { font-size: 12px; line-height: 1; }
  .bpb-action-pill.deferred { opacity: 0.85; }
  .bpb .bp-tags { padding: 2px 14px 12px; justify-content: space-between; }
  .bpb .bp-tag { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.12); padding: 3px 10px; border-radius: 6px; gap: 8px; }
  .bpb .bp-tag > div { display: flex; align-items: baseline; gap: 4px; }
  .bpb .bp-tag-label { color: rgba(255,255,255,0.65); font-size: 8px; }
  .bpb .bp-tag-value { color: #fff; font-size: 13px; }
  .bpb .bp-tag.accent { background: rgba(0,169,252,0.15); border-color: rgba(0,169,252,0.22); }
  .bpb .bp-tag.accent .bp-tag-label { color: var(--blue-400); }
  .bpb .bp-tag.accent .bp-tag-value { color: var(--blue-200); }
  .bpb .bp-tag.warm { background: rgba(255,141,84,0.12); border-color: rgba(255,141,84,0.2); }
  .bpb .bp-tag.warm .bp-tag-label { color: var(--orange-500); }
  .bpb .bp-tag.warm .bp-tag-value { color: #FFB088; }
  .bpb .bp-doc { border-color: rgba(255,255,255,0.06); padding: 6px 14px 8px; }
  .bpb .bp-doc-loc { color: rgba(255,255,255,0.65); border-color: rgba(255,255,255,0.15); }
  .bpb .bp-doc-loc:hover { color: #fff; background: rgba(255,255,255,0.06); }
  .bpb .bp-doc-btn.deferred { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.5); }
  .bpb .bp-doc-wallet { color: #fff; background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.12); }
  .dark-conn .bp-conn-chip, .bold-conn .bp-conn-chip { background: rgba(255,141,84,0.12); border-color: rgba(255,141,84,0.2); color: #FFB088; }
  .dark-conn .bp-conn-where, .bold-conn .bp-conn-where { color: rgba(255,255,255,0.55); }
  .bp-transit.dark-transit, .bp-transit.bold-transit { background: rgba(0,169,252,0.1); color: var(--blue-300); border-radius: 10px; }
  .bp-transit.dark-transit strong, .bp-transit.bold-transit strong { color: var(--blue-200); }
  .bp-luggage.luggage-dark { color: rgba(255,255,255,0.45); }
  /* Connection info bar below route in leg card */
  .leg-conn-bar { display: flex; flex-wrap: wrap; gap: 6px; padding: 4px 14px 6px; align-items: center; }
  .leg-conn-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: rgba(255,141,84,0.12); border: 1px solid rgba(255,141,84,0.2); border-radius: 6px; font-size: 10px; font-weight: 700; color: rgba(255,180,100,0.9); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .leg-conn-chip { background: rgba(255,141,84,0.08); border-color: rgba(255,141,84,0.15); color: #cc5500; }
  .leg-conn-chip .material-symbols-rounded { font-size: 12px; line-height: 1; }
  /* Leg card — seat/gate info in mid zone (accent to stand out) */
  .leg-mid-seat { font-size: 12px; font-weight: 800; color: rgba(120,200,255,0.95); text-align: center; margin-top: 3px; white-space: nowrap; letter-spacing: 0.3px; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .leg-mid-seat { color: var(--blue-600); }
  /* Leg card — same layout as direct, just smaller */
  .bpb-leg .bpb-code { font-size: 22px; }
  .bpb-leg .bpb-time { font-size: 11px; }
  .bpb-leg .bpb-name { font-size: 10px; }
  .bpb-leg .bpb-route { padding: 6px 14px; }
  .bpb-leg .bpb-head { padding: 10px 14px 2px; }
  .bpb-leg { padding-bottom: 10px; }
  .bpb-leg .bp-tags { padding: 1px 14px 2px; }
  /* Leg card — date label per segment when date changes */
  .leg-seg-date { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.5); padding: 2px 14px 0; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .leg-seg-date { color: var(--grey-500); }
  /* Leg card — connection chip centered on separator line */
  .bpb-leg .leg-conn-bar { position: relative; border-top: none; margin: 2px 14px; padding: 0; justify-content: center; }
  .bpb-leg .leg-conn-bar::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.08); }
  .bpb-leg .leg-conn-chip { position: relative; z-index: 1; background: #262d3f; }
  .bpb-navy .leg-conn-chip { background: #1a2138; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-leg .leg-conn-bar::before { background: var(--grey-200); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-leg .leg-conn-chip { background: #edeef2; }
  /* Inline action pill — centered in card */
  .leg-action-center { text-align: center; padding: 6px 14px 10px; }
  .card-voucher-row { text-align: center; padding: 6px 14px; }
  /* Hotel dark card */
  .htd-title { font-size: 15px; font-weight: 700; color: #fff; line-height: 1.3; overflow: hidden; text-decoration: none; border: none; outline: none; }
  .bpb.tappable { -webkit-tap-highlight-color: transparent; outline: none; }
  .htd-title .stars { color: var(--yellow-500); font-size: 12px; margin-left: 2px; }
  .htd-sub-row { padding: 2px 14px 4px; }
  .htd-sub { font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.4; }
  .htd-dates { display: flex; align-items: flex-start; padding: 8px 14px; border-top: 1px solid rgba(255,255,255,0.06); }
  .htd-date { flex: 1; }
  .htd-date.arr { text-align: right; }
  .htd-date-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.55); }
  .htd-date-time { font-size: 30px; font-weight: 800; color: #fff; letter-spacing: -0.8px; line-height: 1; margin-top: 3px; }
  .htd-date-day { font-size: 12px; color: rgba(255,255,255,0.65); margin-top: 4px; font-weight: 600; }
  .htd-hero { display: flex; flex-direction: column; }
  .htd-hero .bpb-name { order: -1; margin-top: 0; margin-bottom: 3px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
  .htd-hero.arr { align-items: flex-end; }
  .htd-code { font-size: 16px !important; font-weight: 800 !important; letter-spacing: -0.3px !important; white-space: nowrap; }
  .htd-mid { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 2px 0; min-width: 50px; }
  .htd-logistics { padding: 6px 14px 10px; border-top: 1px solid rgba(255,255,255,0.06); }
  .htd-log-item { font-size: 11px; color: rgba(255,255,255,0.7); line-height: 1.7; display: flex; align-items: center; gap: 6px; }
  .htd-log-item strong { color: rgba(255,255,255,0.85); font-weight: 700; }
  /* Hotel bold — compact horizontal date layout (check-in | nights | check-out) */
  .htd-dates-bold { display: flex; align-items: stretch; gap: 0; padding: 6px 14px 4px; border-top: 1px solid rgba(255,255,255,0.06); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-dates-bold { border-top-color: var(--grey-100); }
  .htd-block { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 6px 0; min-width: 0; }
  .htd-block.arr { align-items: flex-end; text-align: right; }
  .htd-block-event { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: rgba(255,255,255,0.45); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-block-event { color: var(--grey-400); }
  .htd-block-dow { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.85); line-height: 1.2; margin-top: 2px; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-block-dow { color: var(--black); }
  .htd-block-date { font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.5); margin-top: 1px; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-block-date { color: var(--grey-500); }
  .htd-block-time { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.4); margin-top: 2px; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-block-time { color: var(--grey-400); }
  /* Nights separator (vertical divider between check-in/check-out) */
  .htd-nights-sep { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; flex-shrink: 0; }
  .htd-nights-sep-line { width: 1px; flex: 1; background: rgba(255,255,255,0.06); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .htd-nights-sep-line { background: var(--grey-100); }
  .htd-nights-sep .bpb-mid-badge { white-space: nowrap; margin: 4px 0; }
  /* Car driver row — matches htd-logistics style */
  .bpb-driver { padding: 6px 14px 10px; border-top: 1px solid rgba(255,255,255,0.06); }
  .bpb-driver-item { font-size: 11px; color: rgba(255,255,255,0.7); line-height: 1.7; display: flex; align-items: center; gap: 6px; }
  .bpb-driver-item strong { color: rgba(255,255,255,0.85); font-weight: 700; }

  /* Per-segment actions row */
  .bp-doc { display: flex; align-items: center; gap: 6px; padding: 6px 14px 8px; border-top: 1px solid var(--grey-100); margin-top: 2px; }
  .bp-doc-btn { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; text-decoration: none; border: none; font-family: var(--font); transition: all 0.15s; margin-left: auto; }
  .bp-doc-btn svg { width: 14px; height: 14px; flex-shrink: 0; fill: currentColor; }
  .bp-doc-btn.available { background: var(--blue-500); color: var(--white); }
  .bp-doc-btn.available:hover { background: var(--blue-600); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,169,252,0.25); }
  .bp-doc-btn.deferred { background: var(--grey-75); color: var(--grey-400); cursor: default; }
  .bp-doc-loc { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600; color: var(--grey-500); text-decoration: none; padding: 4px 8px; border-radius: 6px; border: 1px solid var(--grey-100); transition: all 0.15s; font-family: var(--font); white-space: nowrap; }
  .bp-doc-loc:hover { background: var(--grey-50); color: var(--grey-700); border-color: var(--grey-200); }
  .bp-doc-wallet { display: none; }
  @media (max-width: 640px) {
    .bp-doc-wallet { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 6px; font-size: 9px; font-weight: 600; color: var(--black); background: var(--grey-50); border: 1px solid var(--grey-100); cursor: pointer; font-family: var(--font); }
  }
  /* Ticket action tag (inline on badges row, classic mode) */
  .bp-ticket-tag { display: inline-flex; align-items: center; gap: 7px; padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--grey-200); font-family: var(--font); transition: all 0.15s; margin-left: auto; background: var(--grey-50); color: var(--grey-700); }
  .bp-ticket-tag:hover { background: var(--white); border-color: var(--grey-300); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .bp-ticket-tag:active { transform: scale(0.97); box-shadow: none; }
  .bp-ticket-tag svg { width: 18px; height: 18px; flex-shrink: 0; fill: var(--grey-400); }
  .bp-ticket-tag .material-symbols-rounded { font-size: 20px; color: var(--grey-400); line-height: 1; }
  .bp-ticket-tag.deferred { background: var(--grey-50); color: var(--grey-400); border-color: var(--grey-100); font-weight: 600; }
  .bp-ticket-tag.deferred:hover { background: var(--grey-75); border-color: var(--grey-200); transform: none; box-shadow: none; }
  /* Transit bar */
  .bp-transit { display: flex; align-items: center; gap: 6px; padding: 6px 14px; background: var(--blue-50); font-size: 11px; font-weight: 600; color: var(--blue-700); border-radius: 8px; margin-bottom: 6px; }
  /* Pair layout: 2 segments side by side, fill width */
  .bp-pair { display: flex; align-items: stretch; gap: 0; margin-bottom: 6px; }
  .bp-pair .bp, .bp-pair .bpb { flex: 1; min-width: 0; margin-bottom: 0; }
  .bp-pair .bp-time { font-size: 22px; }
  .bp-pair .bp-mid { min-width: 50px; }
  .bp-pair .bp-conn-between { flex-direction: column; gap: 2px; padding: 0 6px; }
  /* Compact paired bold cards to fit 2 side-by-side */
  .bp-pair .bpb .bpb-code { font-size: 22px; }
  .bp-pair .bpb .bpb-route { padding: 4px 10px 6px; gap: 4px; }
  .bp-pair .bpb .bpb-head { padding: 8px 10px 0; }
  .bp-pair .bpb .bpb-mid { display: none; }
  .bp-pair .bpb .bpb-name { font-size: 10px; }
  .bp-pair .bpb .bpb-time { font-size: 11px; }
  .bp-pair .bpb .bp-tags { padding: 2px 10px 8px; gap: 6px; }
  .bp-pair .bpb .bp-tag { padding: 2px 8px; }
  .bp-pair .bpb .bp-tag-value { font-size: 11px; }
  .bp-pair .bpb .bpb-dur { padding: 2px 10px 0; font-size: 9px; }
  .bp-pair .bpb .bpb-ref { display: none; }
  /* Horizontal scroll for 3+ segments */
  .bp-scroll { display: flex; align-items: stretch; gap: 0; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; padding-bottom: 4px; margin-bottom: 6px; scrollbar-width: thin; scrollbar-color: var(--grey-200) transparent; }
  .bp-scroll::-webkit-scrollbar { height: 3px; }
  .bp-scroll::-webkit-scrollbar-track { background: transparent; }
  .bp-scroll::-webkit-scrollbar-thumb { background: var(--grey-200); border-radius: 2px; }
  .bp-scroll .bp, .bp-scroll .bpb { min-width: 260px; max-width: 320px; flex-shrink: 0; scroll-snap-align: start; margin-bottom: 0; }
  .bp-scroll .bp-time { font-size: 22px; }
  .bp-scroll .bp-mid { min-width: 50px; }
  .bp-scroll .bp-conn-between { flex-direction: column; gap: 2px; padding: 0 6px; }

  /* ===== HOTEL CARD ===== */
  .ht-gallery { display: flex; gap: 3px; height: 110px; }
  .ht-gallery img { flex: 1; min-width: 0; object-fit: cover; height: 100%; }
  .ht-gallery img:first-child { flex: 2; }
  .ht-body { padding: 10px 14px 10px; }
  .ht-name { font-size: 15px; font-weight: 700; line-height: 1.25; color: var(--black); }
  .ht-name .stars { color: var(--yellow-500); font-size: 12px; margin-left: 4px; }
  .ht-sub { font-size: 11px; color: var(--grey-500); line-height: 1.4; margin-top: 3px; }
  .ht-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
  .ht-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: var(--radius-pill); font-size: 10px; font-weight: 600; }
  .ht-badge.breakfast { background: var(--green-50); color: var(--green-700); border: 1px solid var(--green-200); }
  .ht-badge.wifi { background: var(--blue-50); color: var(--blue-700); border: 1px solid var(--blue-100); }
  .ht-badge.cancel-free { background: var(--green-50); color: var(--green-700); border: 1px solid var(--green-200); }
  .ht-badge.cancel-restricted { background: var(--orange-50); color: var(--orange-600); border: 1px solid var(--orange-100); }
  .ht-badge.cancel-none { background: var(--red-50); color: var(--red-400); border: 1px solid var(--red-100); }
  .ht-dates { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; padding: 6px 10px; background: var(--grey-50); border-radius: 8px; margin-top: 8px; font-size: 12px; }
  .ht-date-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: var(--grey-500); }
  .ht-date-value { font-weight: 700; color: var(--black); }
  .ht-date-sep { color: var(--grey-300); font-size: 11px; }
  .ht-nights { font-size: 11px; font-weight: 600; color: var(--grey-500); margin-left: auto; }
  .ht-until { color: var(--orange-600); background: var(--orange-50); padding: 0 5px; border-radius: 3px; font-weight: 700; }
  .ht-logistics { background: var(--blue-50); border-top: 1px solid var(--blue-100); padding: 8px 14px; }
  .ht-logistics-title { font-size: 9px; font-weight: 700; color: var(--blue-700); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .ht-logistics-item { font-size: 11px; color: var(--grey-700); line-height: 1.5; display: flex; align-items: center; gap: 5px; }
  .ht-logistics-item strong { color: var(--black); font-weight: 700; }

  /* ===== CAR CARD ===== */
  .car-top { display: flex; gap: 12px; padding: 10px 14px 8px; }
  .car-photo { width: 100px; height: 72px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: var(--grey-50); }
  .car-photo img { width: 100%; height: 100%; object-fit: cover; }
  .car-header { flex: 1; min-width: 0; }
  .car-title { font-size: 14px; font-weight: 700; color: var(--black); line-height: 1.2; }
  .car-details { font-size: 11px; color: var(--grey-500); margin-top: 3px; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
  .car-details .sep { color: var(--grey-300); }
  .car-schedule { display: flex; gap: 0; padding: 0 14px 8px; align-items: center; }
  .car-sched-block { flex: 1; }
  .car-schedule .bp-ticket-tag { flex: 0 0 auto; margin-left: auto; }
  .car-sched-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--grey-500); margin-bottom: 3px; }
  .car-sched-time { font-size: 18px; font-weight: 800; color: var(--black); line-height: 1; }
  .is-past .car-sched-time { color: var(--grey-400); }
  .car-sched-date { font-size: 11px; font-weight: 600; color: var(--grey-700); margin-top: 2px; }
  .car-sched-loc { font-size: 10px; color: var(--grey-500); margin-top: 1px; max-width: 200px; }
  .car-sched-block.oj .car-sched-label { color: var(--orange-600); }
  .car-driver { display: flex; align-items: center; gap: 10px; padding: 8px 14px; background: var(--grey-50); border-top: 1px solid var(--grey-100); }
  .car-driver-badge { width: 36px; height: 36px; border-radius: 8px; background: var(--blue-50); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; border: 1px solid var(--blue-100); }
  .car-driver-text { flex: 1; }
  .car-driver-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--grey-500); }
  .car-driver-name { font-size: 13px; font-weight: 700; color: var(--black); }
  .car-driver-docs { font-size: 10px; color: var(--grey-500); margin-top: 1px; }

  /* CTAs */
  .cta-row { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  .cta-pri { display: inline-flex; align-items: center; gap: 5px; padding: 7px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; border: none; cursor: pointer; transition: all 0.2s var(--ease); text-decoration: none; font-family: var(--font); background: var(--blue-500); color: var(--white); }
  .cta-pri:hover { background: var(--blue-600); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,169,252,0.25); }
  .cta-pri.hero { width: 100%; justify-content: center; padding: 10px 18px; font-size: 13px; border-radius: 10px; box-shadow: 0 3px 14px rgba(0,169,252,0.2); }
  .cta-pri.green { background: var(--green-500); }
  .cta-pri.green:hover { background: var(--green-600); box-shadow: 0 3px 10px rgba(34,215,161,0.25); }
  .cta-pri.disabled { background: var(--grey-75); color: var(--grey-400); cursor: default; box-shadow: none; font-weight: 600; }
  .cta-pri.disabled:hover { background: var(--grey-75); transform: none; box-shadow: none; }
  .cta-sec { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; border: var(--stroke-md) solid var(--grey-100); background: var(--white); color: var(--grey-600); cursor: pointer; transition: all 0.15s; text-decoration: none; font-family: var(--font); }
  .cta-sec:hover { background: var(--grey-50); border-color: var(--grey-200); color: var(--black); }

  /* ===== Bottom Sheet / Modal ===== */
  .sheet-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,5,10,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s var(--ease), visibility 0.3s; }
  .sheet-overlay.open { opacity: 1; visibility: visible; }
  .sheet-panel { background: var(--white); border-radius: 16px; width: 90%; max-width: 420px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05); transform: scale(0.95) translateY(10px); transition: transform 0.3s var(--ease); position: relative; }
  .sheet-overlay.open .sheet-panel { transform: scale(1) translateY(0); }
  .sheet-handle { display: none; width: 36px; height: 4px; background: var(--grey-200); border-radius: 2px; margin: 10px auto 0; flex-shrink: 0; }
  .sheet-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 14px 18px 10px; border-bottom: 1px solid var(--grey-100); gap: 10px; flex-shrink: 0; }
  .sheet-title { display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 700; color: var(--black); flex: 1; min-width: 0; line-height: 1.3; }
  .sheet-title .date-icon { width: 40px; height: 40px; border-radius: 10px; }
  .sheet-title .date-icon-day { font-size: 17px; }
  .sheet-title .date-icon-month { font-size: 9px; }
  .sheet-close { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--grey-75); color: var(--grey-600); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; font-family: var(--font); line-height: 1; }
  .sheet-close:hover { background: var(--grey-100); color: var(--black); }
  .sheet-body { padding: 20px 20px 28px; }
  .sheet-panel .sheet-body { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .sheet-actions { display: flex; flex-direction: column; gap: 8px; }
  .sheet-actions .cta-pri { width: 100%; justify-content: center; padding: 11px 18px; font-size: 14px; border-radius: 10px; }
  .sheet-actions .cta-sec { width: 100%; justify-content: center; padding: 8px 14px; }
  .sheet-actions-row { display: flex; align-items: center; gap: 10px; }
  .sheet-actions-row .wallet-badge-apple, .sheet-actions-row .wallet-badge-google { flex: 1; }
  .sheet-wallet-row { margin-top: 6px; }
  .sheet-pdf-link { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 700; color: var(--grey-500); text-decoration: none; padding: 6px 0; transition: color 0.15s; cursor: pointer; border: none; background: none; font-family: var(--font); flex-shrink: 0; }
  .sheet-pdf-link:hover { color: var(--blue-500); }
  .sheet-pdf-link .material-symbols-rounded { font-size: 16px; }
  .sheet-info { display: flex; align-items: flex-start; gap: 8px; padding: 10px 12px; background: var(--blue-50); border: 1px solid var(--blue-100); border-radius: 10px; font-size: 12px; color: var(--blue-700); line-height: 1.4; margin-bottom: 12px; }
  .sheet-info-icon { font-size: 16px; flex-shrink: 0; }
  .sheet-qr { width: 200px; height: 200px; margin: 16px auto 18px; background: var(--grey-50); border: 1px solid var(--grey-100); border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px; }
  .sheet-qr svg { width: 130px; height: 130px; opacity: 0.2; }
  .sheet-qr-label { font-size: 12px; font-weight: 600; color: var(--grey-600); }
  .sheet-doc { width: 100%; margin: 8px auto 18px; background: var(--grey-50); border: 1px solid var(--grey-100); border-radius: 12px; display: flex; align-items: center; gap: 14px; padding: 18px 20px; cursor: pointer; transition: background 0.15s, border-color 0.15s, transform 0.15s; text-decoration: none; }
  .sheet-doc:hover { background: var(--grey-75); border-color: var(--grey-200); transform: translateY(-1px); }
  .sheet-doc:active { transform: scale(0.99); }
  .sheet-doc-icon { width: 44px; height: 52px; flex-shrink: 0; border-radius: 6px; background: #e53935; display: flex; align-items: center; justify-content: center; }
  .sheet-doc-icon svg { width: 24px; height: 28px; }
  .sheet-doc-info { flex: 1; min-width: 0; }
  .sheet-doc-name { font-size: 13px; font-weight: 700; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sheet-doc-meta { font-size: 11px; color: var(--grey-500); margin-top: 2px; font-weight: 500; }
  .sheet-pax { font-size: 13px; color: var(--grey-600); margin-top: 6px; margin-bottom: 8px; font-weight: 500; text-align: center; }
  .sheet-pax strong { font-weight: 700; color: var(--grey-800); }
  .sheet-conn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,141,84,0.06); border-radius: 8px; margin: 4px 0; }
  .sheet-conn-icon { font-size: 12px; color: var(--orange-500); }
  .sheet-conn-text { font-size: 10px; font-weight: 700; color: var(--orange-600); }
  .sheet-divider { height: 1px; background: var(--grey-100); margin: 14px 0; }
  /* Multi-segment ticket carousel */
  .sheet-ticket-carousel { position: relative; }
  .sheet-ticket-slide { display: none; text-align: center; }
  .sheet-ticket-slide.active { display: block; }
  .sheet-ticket-label { font-size: 13px; font-weight: 700; color: var(--black); }
  .sheet-ticket-route { font-size: 11px; color: var(--grey-500); margin-top: 2px; font-weight: 500; }
  .sheet-ticket-nav { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 6px; }
  .sheet-ticket-nav button { width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid var(--grey-200); background: transparent; color: var(--grey-500); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; padding: 0; }
  .sheet-ticket-nav button:disabled { opacity: 0.25; cursor: default; }
  .sheet-ticket-nav button span { font-size: 18px; }
  .sheet-ticket-counter { font-size: 11px; color: var(--grey-400); font-weight: 600; min-width: 28px; text-align: center; }
  /* PDF viewer in sheet (hotel/car vouchers) */
  .sheet-pdf { display: block; width: 200px; aspect-ratio: 210 / 297; margin: 16px auto 18px; border-radius: 14px; overflow: hidden; border: 1px solid var(--grey-100); background: #fff; text-decoration: none; cursor: pointer; }
  .sheet-pdf iframe { width: 200%; height: 200%; border: none; transform: scale(0.5); transform-origin: 0 0; pointer-events: none; }
  .sheet-dl-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .sheet-dl-info { flex: 1; min-width: 0; }
  .sheet-dl-name { font-size: 13px; font-weight: 700; color: var(--black); }
  .sheet-dl-meta { font-size: 11px; color: var(--grey-500); margin-top: 1px; font-weight: 500; }
  .sheet-dl-btn { display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: var(--blue-500); color: #fff; border: none; cursor: pointer; transition: all 0.15s; flex-shrink: 0; }
  .sheet-dl-btn:hover { background: var(--blue-600); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,169,252,0.25); }
  .sheet-dl-btn .material-symbols-rounded { font-size: 20px; line-height: 1; }
  /* Hotel/car sheet details */
  .sheet-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .sheet-detail-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: var(--grey-400); }
  .sheet-detail-value { font-size: 13px; font-weight: 700; color: var(--black); margin-top: 1px; }
  .sheet-detail-sub { font-size: 11px; color: var(--grey-500); font-weight: 500; }
  .sheet-detail-full { grid-column: 1 / -1; }
  .sheet-conditions { font-size: 11px; color: var(--grey-600); line-height: 1.5; padding: 10px 12px; background: var(--grey-50); border-radius: 8px; margin-bottom: 14px; }
  .sheet-conditions strong { font-weight: 700; color: var(--grey-700); }
  .sheet-footer { display: flex; justify-content: center; margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--grey-100); }
  .sheet-footer a { font-size: 13px; font-weight: 600; color: var(--grey-600); text-decoration: none; display: flex; align-items: center; gap: 4px; transition: color 0.15s; }
  .sheet-footer a:hover { color: var(--blue-500); }
  .sheet-map-btn { display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: var(--grey-100); color: var(--grey-600); border: none; cursor: pointer; transition: all 0.15s; flex-shrink: 0; text-decoration: none; }
  .sheet-map-btn:hover { background: var(--grey-200); color: var(--grey-800); transform: translateY(-1px); }
  .sheet-map-btn .material-symbols-rounded { font-size: 20px; line-height: 1; }
  .wallet-badge { display: flex; align-items: center; justify-content: center; width: 100%; height: 48px; border-radius: 10px; cursor: pointer; border: none; text-decoration: none; transition: opacity 0.15s; box-sizing: border-box; overflow: hidden; background: transparent; }
  .wallet-badge:hover { opacity: 0.85; }
  .wallet-badge img { height: 100%; width: 100%; object-fit: contain; }
  /* Contrast mode sheet */
  .sheet-overlay[data-color="contrast"] .sheet-panel { background: #1a2747; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
  .sheet-overlay[data-color="contrast"] .sheet-handle { background: rgba(255,255,255,0.2); }
  .sheet-overlay[data-color="contrast"] .sheet-header { border-color: rgba(255,255,255,0.08); }
  .sheet-overlay[data-color="contrast"] .sheet-title { color: #fff; }
  .sheet-overlay[data-color="contrast"] .date-icon { background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.15); }
  .sheet-overlay[data-color="contrast"] .date-icon-day { color: #fff; }
  .sheet-overlay[data-color="contrast"] .date-icon-month { color: rgba(255,255,255,0.6); }
  .sheet-overlay[data-color="contrast"] .sheet-close { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
  .sheet-overlay[data-color="contrast"] .sheet-close:hover { background: rgba(255,255,255,0.15); color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-body { color: rgba(255,255,255,0.85); }
  .sheet-overlay[data-color="contrast"] .sheet-info { background: rgba(0,169,252,0.12); border-color: rgba(0,169,252,0.2); color: var(--blue-300); }
  .sheet-overlay[data-color="contrast"] .sheet-qr { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.14); color: rgba(255,255,255,0.55); }
  .sheet-overlay[data-color="contrast"] .sheet-qr-label { color: rgba(255,255,255,0.7); }
  .sheet-overlay[data-color="contrast"] .sheet-doc { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.15); }
  .sheet-overlay[data-color="contrast"] .sheet-doc-name { color: #fff; font-size: 14px; }
  .sheet-overlay[data-color="contrast"] .sheet-doc-meta { color: rgba(255,255,255,0.55); }
  .sheet-overlay[data-color="contrast"] .sheet-pax { color: rgba(255,255,255,0.65); }
  .sheet-overlay[data-color="contrast"] .sheet-pax strong { color: rgba(255,255,255,0.95); }
  .sheet-overlay[data-color="contrast"] .sheet-pdf { border-color: rgba(255,255,255,0.18); background: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-dl-name { color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-dl-meta { color: rgba(255,255,255,0.45); }
  .sheet-overlay[data-color="contrast"] .sheet-dl-btn { background: rgba(255,255,255,0.12); color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-detail-label { color: rgba(255,255,255,0.4); }
  .sheet-overlay[data-color="contrast"] .sheet-detail-value { color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-detail-sub { color: rgba(255,255,255,0.5); }
  .sheet-overlay[data-color="contrast"] .sheet-conditions { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.65); }
  .sheet-overlay[data-color="contrast"] .sheet-conditions strong { color: rgba(255,255,255,0.85); }
  .sheet-overlay[data-color="contrast"] .sheet-map-btn { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
  .sheet-overlay[data-color="contrast"] .sheet-map-btn:hover { background: rgba(255,255,255,0.18); color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-footer { border-color: rgba(255,255,255,0.12); }
  .sheet-overlay[data-color="contrast"] .sheet-footer a { color: rgba(255,255,255,0.7); }
  .sheet-overlay[data-color="contrast"] .sheet-footer a:hover { color: var(--blue-200); }
  .sheet-overlay[data-color="contrast"] .sheet-pdf-link { color: rgba(255,255,255,0.5); }
  .sheet-overlay[data-color="contrast"] .sheet-pdf-link:hover { color: var(--blue-200); }
  .sheet-overlay[data-color="contrast"] .sheet-actions .cta-pri { background: #fff; color: #1a2747; font-weight: 800; }
  .sheet-overlay[data-color="contrast"] .sheet-actions .cta-pri:hover { background: rgba(255,255,255,0.9); }
  .sheet-overlay[data-color="contrast"] .sheet-actions .cta-sec { border-color: rgba(255,255,255,0.18); color: #fff; background: rgba(255,255,255,0.08); }
  .sheet-overlay[data-color="contrast"] .sheet-actions .cta-sec:hover { background: rgba(255,255,255,0.14); }
  .sheet-overlay[data-color="contrast"] .sheet-ticket-label { color: #fff; }
  .sheet-overlay[data-color="contrast"] .sheet-ticket-route { color: rgba(255,255,255,0.45); }
  .sheet-overlay[data-color="contrast"] .sheet-ticket-nav button { border-color: rgba(255,255,255,0.18); color: rgba(255,255,255,0.7); }
  .sheet-overlay[data-color="contrast"] .sheet-ticket-counter { color: rgba(255,255,255,0.4); }
  .sheet-overlay[data-color="contrast"] .sheet-conn { background: rgba(255,141,84,0.08); }
  .sheet-overlay[data-color="contrast"] .sheet-conn-text { color: var(--orange-300); }
  .sheet-overlay[data-color="contrast"] .sheet-divider { background: rgba(255,255,255,0.06); }
  /* Contrast sheet: invert wallet badges to white for dark background */
  .sheet-overlay[data-color="contrast"] .wallet-badge img { filter: invert(1) hue-rotate(180deg); }
  /* Bold card tappable — hover/bounce only on mobile (desktop: only pill is clickable) */
  .bpb.tappable { cursor: default; }
  /* Deferred button clickable */
  .bp-doc-btn.deferred { cursor: pointer; }

  /* Footer */
  .card-footer { display: none; }
  .card-footer a { font-size: 11px; font-weight: 600; color: var(--blue-600); text-decoration: none; display: inline-flex; align-items: center; gap: 3px; padding: 2px 5px; border-radius: 5px; transition: all 0.15s; }
  .card-footer a:hover { background: var(--blue-50); color: var(--blue-700); }

  /* ===== Mobile ===== */
  @media (max-width: 640px) {
    /* Sheet → bottom sheet on mobile */
    .sheet-overlay { align-items: flex-end; justify-content: stretch; }
    .sheet-panel { width: 100%; max-width: 100%; max-height: none; border-radius: 20px 20px 0 0; height: 88vh; height: 88dvh; transform: translateY(100%); }
    .sheet-body { padding-bottom: max(40px, env(safe-area-inset-bottom, 34px)); }
    .sheet-overlay.open .sheet-panel { transform: translateY(0); }
    .sheet-handle { display: block; }
    body { padding: 0 8px 8px; }
    .card-inner { padding: 14px 12px 10px; }
    .card-header { margin-bottom: 10px; flex-wrap: wrap; gap: 6px; }
    .headline { font-size: 15px; }
    .co-travelers { font-size: 10px; }
    .header-link { padding: 4px 8px; font-size: 10px; }
    .stepper { margin-bottom: 10px; }
    .stepper-step { padding: 3px 0; }
    .stepper-dot-row { height: 30px; }
    .stepper-dot { width: 26px; height: 26px; font-size: 13px; }
    .stepper-step.active .stepper-dot { width: 30px; height: 30px; }
    .stepper-line { left: calc(50% + 16px); right: calc(-50% + 16px); }
    .stepper-label { font-size: 11px; }
    .stepper-date { font-size: 8px; }
    /* Modern stepper mobile */
    .stepper.stepper-dark .stepper-dot-row { height: 34px; }
    .stepper.stepper-dark .stepper-dot { width: 24px; height: 24px; }
    .stepper.stepper-dark .stepper-dot .material-symbols-rounded { font-size: 13px; }
    .stepper.stepper-dark .stepper-step.active .stepper-dot { width: 32px; height: 32px; }
    .stepper.stepper-dark .stepper-step.active .stepper-dot .material-symbols-rounded { font-size: 16px; }
    .stepper.stepper-dark .stepper-step.active .stepper-label { font-size: 11px; }
    /* Bold stepper mobile — compact, no scroll (swipe on card area instead) */
    .stepper.stepper-bold { padding: 0 4px; gap: 0; }
    .stepper.stepper-bold .stepper-step { flex: 1; min-width: 0; }
    .stepper.stepper-bold .stepper-step.active { flex: 1; }
    /* Mobile: card tappable with bounce feedback */
    .bpb.tappable { cursor: pointer; transition: transform 0.2s var(--ease), box-shadow 0.2s var(--ease); }
    .bpb.tappable:active { transform: scale(0.985); transition-duration: 0.1s; }
    /* Hide prev/next nav on mobile (swipe replaces it) */
    .bold-nav { display: none; }
    /* Hide voucher pills on mobile (card is tappable instead) */
    .card-voucher-row { display: none; }
    .htd-nights-sep > .bpb-action-pill { display: none; }
    .leg-action-center { display: none; }
    .stepper.stepper-bold .stepper-step.active { width: 140px; }
    .stepper.stepper-bold .stepper-step.active .stepper-dot { width: 34px; height: 34px; }
    .stepper.stepper-bold .stepper-step.active .stepper-dot .material-symbols-rounded { font-size: 17px; }
    .stepper.stepper-bold .stepper-step.active .stepper-dot-row { height: 38px; }
    .stepper.stepper-bold .stepper-step.active .stepper-label { font-size: 12px; }
    .stepper.stepper-bold .stepper-step:not(.active) .stepper-dot { width: 22px; height: 22px; }
    .stepper.stepper-bold .stepper-step:not(.active) .stepper-dot .material-symbols-rounded { font-size: 12px; }
    .stepper.stepper-bold .stepper-step:not(.active) .stepper-dot-row { height: 28px; }
    /* Mobile bold line positions — adjusted for smaller dots */
    .stepper.stepper-bold .stepper-step::before,
    .stepper.stepper-bold .stepper-step::after { top: 17px; }
    .stepper.stepper-bold .stepper-step::before { right: calc(50% + 12px); }
    .stepper.stepper-bold .stepper-step::after { left: calc(50% + 12px); }
    .stepper.stepper-bold .stepper-step.active::before { right: calc(50% + 18px); }
    .stepper.stepper-bold .stepper-step.active::after { left: calc(50% + 18px); }
    .bp-time { font-size: 22px; }
    .bp-route { padding: 8px 10px 4px; }
    .bp-head { padding: 6px 10px 4px; }
    .bp-tags { padding: 4px 10px 6px; gap: 8px; }
    .bp-tag-group { gap: 4px; }
    .bp-pair { flex-direction: column; }
    .bp-pair .bp, .bp-pair .bpb { width: 100%; }
    .bp-pair .bp-conn-between { flex-direction: row; gap: 6px; padding: 6px 0; }
    .bp-scroll .bp { min-width: 220px; max-width: 260px; }
    .bp-scroll .bp-time { font-size: 20px; }
    /* Stack segments vertically on mobile — no carousel */
    .bp-scroll { flex-wrap: wrap; overflow-x: visible; scroll-snap-type: none; }
    .bp-scroll .bp, .bp-scroll .bpb { min-width: 100% !important; max-width: 100% !important; flex-shrink: 1; }
    .bp-scroll .bp-conn-between { width: 100%; padding: 6px 0; }
    /* Bold mobile — hide mid section to save space (except leg cards with escales) */
    .bpb-mid { display: none; }
    .bpb-leg .bpb-mid { display: flex; min-width: 50px; }
    .bpb-leg .bpb-mid-badge .mid-label { font-size: 11px; }
    .bpb-leg .bpb-code { font-size: 18px; }
    .bpb-leg .bpb-route { padding: 8px 12px; }
    .bpb-leg .bpb-time { font-size: 10px; }
    .bpb-leg .bpb-name { font-size: 9px; }
    .bpb-leg .bp-tags { padding: 0 12px 2px; }
    .bpb-code { font-size: 28px; }
    .bpb-route { padding: 12px 12px 6px; }
    .bpb-head { padding: 10px 12px 0; }
    .bpb .bp-tags { padding: 4px 12px 6px; }
    .bpb .bp-doc { padding: 6px 12px 10px; }
    .bp-tear { margin: 0 8px; }
    .bp-tear::before, .bp-tear::after { width: 16px; height: 16px; top: -9px; }
    .bp-tear::before { left: -19px; }
    .bp-tear::after { right: -19px; }
    .ht-gallery { height: 90px; }
    .ht-body { padding: 8px 10px 8px; }
    .ht-name { font-size: 14px; }
    .car-top { padding: 8px 10px 6px; }
    .car-photo { width: 80px; height: 60px; }
    .car-title { font-size: 13px; }
    .car-schedule { padding: 0 10px 8px; flex-wrap: wrap; }
    .car-schedule .bp-ticket-tag { margin-top: 8px; width: 100%; justify-content: center; }
    .car-sched-time { font-size: 16px; }
    .car-driver { padding: 6px 10px; }
    .cta-row { flex-direction: column; gap: 5px; }
    .cta-pri { width: 100%; justify-content: center; padding: 8px 12px; font-size: 12px; }
    .cta-sec { width: 100%; justify-content: center; padding: 6px 10px; font-size: 10px; }
    .card-footer { margin-top: 8px; padding-top: 6px; }
    .demo-controls { flex-direction: column; align-items: stretch; }
    .demo-controls .sep { display: none; }
  }
  @media (max-width: 380px) {
    .card-inner { padding: 12px 10px 8px; }
    .headline { font-size: 14px; }
    .stepper-label { font-size: 9px; -webkit-line-clamp: 1; }
    .stepper-date { display: none; }
    .bp-time { font-size: 18px; }
    .bpb-code { font-size: 24px; }
    .bp-mid { min-width: 50px; }
    .ht-gallery { height: 72px; }
    .ht-name { font-size: 13px; }
    .car-photo { width: 64px; height: 48px; }
  }

  /* ===== Proto Header ===== */
  /* ===== Header (tabs + globals only) ===== */
  .proto-header { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.97); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--grey-100); }
  .proto-tabs { display: flex; align-items: center; padding: 0 16px; position: relative; }
  .proto-tab { padding: 10px 18px; font-size: 12px; font-weight: 700; color: var(--grey-400); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; font-family: var(--font); transition: all 0.15s; margin-bottom: -1px; }
  .proto-tab:hover { color: var(--grey-600); }
  .proto-tab.active { color: var(--black); border-bottom-color: var(--black); }
  .proto-globals { margin-left: auto; display: flex; gap: 3px; align-items: center; padding: 6px 0; }
  .proto-globals .sep { width: 1px; height: 16px; background: var(--grey-100); margin: 0 4px; }
  .proto-globals button { padding: 3px 8px; border: 1.5px solid var(--grey-100); border-radius: 6px; background: var(--white); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; color: var(--grey-500); font-family: var(--font); line-height: 1.2; }
  .proto-globals button:hover { background: var(--grey-50); border-color: var(--grey-200); color: var(--grey-700); }
  .proto-globals button.active { background: var(--black); color: var(--white); border-color: var(--black); }

  /* ===== Sidebar (desktop: fixed left, retractable) ===== */
  .proto-sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: #fff; border-right: 1px solid var(--grey-100); z-index: 110; overflow-y: auto; display: flex; flex-direction: column; transition: transform 0.3s ease; }
  .proto-sidebar-head { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px 8px; border-bottom: 1px solid var(--grey-100); flex-shrink: 0; }
  .proto-sidebar-head span { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; color: var(--grey-400); font-family: var(--font); }
  .proto-sidebar-close { display: none; width: 28px; height: 28px; border-radius: 8px; border: none; background: var(--grey-50); color: var(--grey-500); font-size: 14px; cursor: pointer; font-family: var(--font); transition: all 0.15s; align-items: center; justify-content: center; }
  .proto-sidebar-close:hover { background: var(--grey-100); color: var(--grey-700); }
  .proto-backdrop { display: none; }

  /* Desktop: shift ALL main content right for sidebar */
  .proto-main { margin-left: 250px; transition: margin-left 0.3s ease; }
  /* Desktop collapsed state */
  body.sidebar-collapsed .proto-sidebar { transform: translateX(-100%); }
  body.sidebar-collapsed .proto-main { margin-left: 0; }
  /* Desktop toggle button in header */
  .proto-sidebar-toggle { width: 30px; height: 30px; border-radius: 7px; border: 1.5px solid var(--grey-100); background: var(--white); color: var(--grey-500); font-size: 16px; cursor: pointer; font-family: var(--font); transition: all 0.15s; display: flex; align-items: center; justify-content: center; margin-right: 8px; flex-shrink: 0; }
  .proto-sidebar-toggle:hover { background: var(--grey-50); border-color: var(--grey-200); color: var(--grey-700); }

  /* ===== Panel (inside sidebar) ===== */
  .proto-panel { padding: 12px 14px 12px; flex: 1; }
  /* Grid-based config rows: label | controls */
  .proto-line { display: grid; grid-template-columns: 72px 1fr; align-items: center; gap: 0 6px; min-height: 26px; }
  .proto-line-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: var(--grey-300); font-family: var(--font); white-space: nowrap; text-align: right; padding-right: 2px; }
  .proto-line-controls { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
  .proto-line-controls .sc-config-pill { padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 600; border: 1px solid var(--grey-100); background: var(--white); color: var(--grey-400); cursor: pointer; font-family: var(--font); transition: all 0.15s; white-space: nowrap; }
  .proto-line-controls .sc-config-pill:hover { border-color: var(--grey-200); color: var(--grey-600); }
  .proto-line-controls .sc-config-pill.active { background: var(--black); color: var(--white); border-color: var(--black); }
  .proto-line-controls .sc-toggle { position: relative; width: 30px; height: 16px; border-radius: 8px; background: var(--grey-200); border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
  .proto-line-controls .sc-toggle.on { background: var(--blue-500); }
  .proto-line-controls .sc-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; border-radius: 50%; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: transform 0.2s; }
  .proto-line-controls .sc-toggle.on::after { transform: translateX(14px); }
  .proto-line-controls .sc-toggle-label { font-size: 10px; font-weight: 600; color: var(--grey-400); font-family: var(--font); }
  .proto-divider { grid-column: 1 / -1; height: 0; border-top: 1px dashed var(--grey-100); margin: 2px 0; }

  /* Showcase mobile: CTA button to open real sheet */
  .sc-mobile-cta { display: none; padding: 30px 20px; text-align: center; }
  .sc-mobile-cta button { padding: 14px 28px; border-radius: 12px; background: var(--black); color: var(--white); font-size: 14px; font-weight: 700; border: none; cursor: pointer; font-family: var(--font); transition: all 0.15s; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
  .sc-mobile-cta button:active { transform: scale(0.97); }
  .sc-mobile-cta .sc-mobile-hint { font-size: 11px; color: var(--grey-400); margin-top: 10px; }

  /* Panel submit button (hidden on desktop, visible in mobile drawer) */
  .proto-panel-submit { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--grey-100); text-align: center; grid-column: 1 / -1; }
  .proto-panel-submit button { width: 100%; padding: 12px 20px; border-radius: 10px; background: var(--black); color: var(--white); font-size: 13px; font-weight: 700; border: none; cursor: pointer; font-family: var(--font); transition: all 0.15s; }
  .proto-panel-submit button:active { transform: scale(0.97); opacity: 0.9; }

  /* ===== Mobile overrides ===== */
  @media (max-width: 640px) {
    /* Remove desktop sidebar offset */
    .proto-main { margin-left: 0 !important; }
    /* Sidebar becomes bottom sheet overlay */
    .proto-sidebar { position: fixed; inset: 0; width: 100%; height: 100%; max-height: none; overflow-y: auto; border-right: none; border-radius: 0; box-shadow: none; background: var(--white); transform: translateY(100%); transition: transform 0.3s ease; z-index: 200; display: flex; flex-direction: column; justify-content: center; }
    .proto-sidebar.open { transform: translateY(0); }
    body.sidebar-collapsed .proto-sidebar { transform: translateY(100%); }
    .proto-sidebar-head { padding: 16px 20px 10px; }
    .proto-sidebar-close { display: flex; }
    /* Panel compact */
    .proto-panel { padding: 8px 12px 16px; }
    .proto-line { grid-template-columns: 60px 1fr; min-height: 24px; gap: 0 5px; }
    .proto-line-label { font-size: 8px; }
    .proto-line-controls { gap: 3px; }
    .proto-line-controls .sc-config-pill { padding: 2px 6px; font-size: 9px; border-radius: 4px; }
    .proto-line-controls .sc-toggle { width: 26px; height: 14px; border-radius: 7px; }
    .proto-line-controls .sc-toggle::after { width: 10px; height: 10px; }
    .proto-line-controls .sc-toggle.on::after { transform: translateX(12px); }
    .proto-line-controls .sc-toggle-label { font-size: 9px; }
    .proto-globals { gap: 2px; }
    .proto-globals button { padding: 2px 6px; font-size: 9px; }
    .proto-globals .sep { margin: 0 2px; }
    .proto-tab { padding: 8px 12px; font-size: 11px; }
    .proto-sidebar-toggle { width: 26px; height: 26px; border-radius: 6px; margin-right: 4px; }
    .proto-sidebar-toggle .material-symbols-rounded { font-size: 14px !important; }
    /* Showcase: hide inline preview, show CTA button */
    .sc-preview { display: none; }
    .sc-mobile-cta { display: none !important; }
    .proto-panel-submit { display: block; }
  }
  /* Float drawer */
  .float-drawer { position: fixed; bottom: 20px; right: 20px; z-index: 1100; display: none; }
  .float-drawer.visible { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
  .float-drawer-toggle { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--black); color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.15s; font-family: var(--font); }
  .float-drawer-toggle:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
  .float-drawer-body { background: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); padding: 10px 12px; display: none; }
  .float-drawer.open .float-drawer-body { display: flex; flex-direction: column; gap: 8px; }
  .float-drawer .fd-row { display: flex; align-items: center; gap: 4px; }
  .float-drawer .fd-label { font-size: 9px; font-weight: 700; color: var(--grey-400); text-transform: uppercase; letter-spacing: 0.3px; margin-right: 4px; white-space: nowrap; }
  .float-drawer .fd-pill { padding: 3px 9px; border-radius: 7px; font-size: 10px; font-weight: 600; border: 1.5px solid var(--grey-100); background: var(--white); color: var(--grey-600); cursor: pointer; font-family: var(--font); transition: all 0.15s; }
  .float-drawer .fd-pill:hover { background: var(--grey-50); border-color: var(--grey-200); }
  .float-drawer .fd-pill.active { background: var(--black); color: var(--white); border-color: var(--black); }
  .float-drawer .fd-toggle { width: 28px; height: 16px; border-radius: 8px; border: none; background: var(--grey-200); cursor: pointer; position: relative; transition: background 0.15s; padding: 0; }
  .float-drawer .fd-toggle::after { content: ''; position: absolute; left: 2px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: #fff; transition: transform 0.15s; }
  .float-drawer .fd-toggle.on { background: var(--black); }
  .float-drawer .fd-toggle.on::after { transform: translateX(12px); }

  /* ===== Home Skeleton Sections ===== */
  .home-skeleton { max-width: 960px; margin: 0 auto; padding: 0 16px 60px; }
  .home-skeleton.hidden { display: none; }
  .skel-section { margin-top: 28px; }
  .skel-section-title { font-size: 13px; font-weight: 700; color: var(--grey-500); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .skel-section-title .skel-badge { background: #ef4444; color: #fff; font-size: 11px; font-weight: 700; padding: 1px 7px; border-radius: 10px; }
  .skel-card { background: var(--white); border: 1px solid var(--grey-100); border-radius: 12px; padding: 16px; margin-bottom: 10px; }
  .skel-row { display: flex; align-items: center; gap: 12px; }
  .skel-row + .skel-row { margin-top: 10px; }
  .skel-bar { height: 10px; border-radius: 5px; background: var(--grey-100); }
  .skel-bar.w30 { width: 30%; }
  .skel-bar.w40 { width: 40%; }
  .skel-bar.w50 { width: 50%; }
  .skel-bar.w60 { width: 60%; }
  .skel-bar.w70 { width: 70%; }
  .skel-bar.w80 { width: 80%; }
  .skel-bar.w100 { width: 100%; }
  .skel-bar.h6 { height: 6px; }
  .skel-bar.h14 { height: 14px; }
  .skel-circle { width: 36px; height: 36px; border-radius: 50%; background: var(--grey-100); flex-shrink: 0; }
  .skel-circle.sm { width: 28px; height: 28px; }
  .skel-card .skel-title { font-size: 12px; font-weight: 600; color: var(--grey-400); margin-bottom: 8px; }
  .skel-separator { height: 1px; background: var(--grey-100); margin: 20px 0; }

  /* ===== Scenario Sections ===== */
  .scenario-section { max-width: 960px; margin: 24px auto; scroll-margin-top: 90px; }
  .scenario-label { font-size: 11px; font-weight: 700; color: var(--grey-400); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding-left: 4px; }

  /* ===== Light+Bold — Override bpb dark colors to light ===== */
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb { background: linear-gradient(145deg, #f4f7ff 0%, #e2e8f6 12%, #f0f4ff 22%, #d8e0f2 35%, #edf2ff 48%, #dfe6f5 58%, #f2f6ff 70%, #e0e7f4 82%, #f0f4fe 100%); border: 1px solid rgba(130,155,220,0.22); box-shadow: inset 0 1px 0 rgba(255,255,255,1), inset 0 -2px 4px rgba(100,130,210,0.06), 0 4px 20px rgba(90,120,200,0.10), 0 1px 3px rgba(0,0,0,0.04); }
  .trip-card:not(.contrast-mode) .bpb-carrier { color: var(--black); }
  .trip-card:not(.contrast-mode) .bpb-carrier .bp-carrier-sub { color: var(--grey-500); }
  .trip-card:not(.contrast-mode) .bpb-date { color: var(--grey-600); }
  .trip-card:not(.contrast-mode) .bpb .date-icon { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
  .trip-card:not(.contrast-mode) .bpb .date-icon-day { color: var(--black); }
  .trip-card:not(.contrast-mode) .bpb .date-icon-month { color: var(--blue-600); }
  .trip-card:not(.contrast-mode) .bpb-num { color: var(--grey-800); }
  .trip-card:not(.contrast-mode) .bpb-ref { color: var(--grey-400); }
  .trip-card:not(.contrast-mode) .bpb-code { color: var(--black); }
  .trip-card:not(.contrast-mode) .bpb-code .day-offset { color: var(--orange-500); }
  .trip-card:not(.contrast-mode) .bp-time .day-offset { color: var(--orange-500); }
  .trip-card:not(.contrast-mode) .bpb-time { color: var(--grey-700); }
  .trip-card:not(.contrast-mode) .bpb-name { color: var(--grey-700); }
  .trip-card:not(.contrast-mode) .bpb-mid-line { background: var(--grey-200); }
  .trip-card:not(.contrast-mode) .bpb-mid-line:first-child::before, .trip-card:not(.contrast-mode) .bpb-mid-line:last-child::after { background: var(--grey-300); }
  .trip-card:not(.contrast-mode) .bpb-mid-badge .material-symbols-rounded { color: var(--grey-400); }
  .trip-card:not(.contrast-mode) .bpb-mid-badge .mid-label { color: var(--grey-400); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-dur { color: var(--orange-600); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-dur .material-symbols-rounded { color: var(--orange-500); }
  .trip-card:not(.contrast-mode) .bpb .bp-tag { background: rgba(255,255,255,0.82); border-color: rgba(180,185,200,0.45); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  .trip-card:not(.contrast-mode) .bpb .bp-tag-label { color: var(--grey-600); font-weight: 700; }
  .trip-card:not(.contrast-mode) .bpb .bp-tag-value { color: var(--black); font-weight: 800; }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.accent { background: rgba(0,169,252,0.10); border-color: rgba(0,169,252,0.25); }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.accent .bp-tag-label { color: var(--blue-600); font-weight: 700; }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.accent .bp-tag-value { color: var(--blue-800); }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.warm { background: rgba(255,141,84,0.10); border-color: rgba(255,141,84,0.25); }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.warm .bp-tag-label { color: var(--orange-600); font-weight: 700; }
  .trip-card:not(.contrast-mode) .bpb .bp-tag.warm .bp-tag-value { color: #b34700; }
  .trip-card:not(.contrast-mode) .bpb .bp-doc { border-color: var(--grey-100); }
  .trip-card:not(.contrast-mode) .bpb .bp-doc-loc { color: var(--grey-600); border-color: var(--grey-200); }
  .trip-card:not(.contrast-mode) .bpb .bp-doc-btn.deferred { background: var(--grey-50); color: var(--grey-500); }
  .trip-card:not(.contrast-mode) .bpb .bp-doc-wallet { color: var(--black); background: var(--grey-50); border-color: var(--grey-200); }
  .trip-card:not(.contrast-mode) .bpb-action-pill { background: rgba(0,0,0,0.06); color: var(--grey-700); border-color: rgba(0,0,0,0.10); }
  .trip-card:not(.contrast-mode) .bold-nav-btn { border-color: rgba(0,0,0,0.12); background: rgba(0,0,0,0.04); color: var(--grey-400); }
  .trip-card:not(.contrast-mode) .bold-nav-btn:hover { background: rgba(0,0,0,0.08); border-color: rgba(0,0,0,0.2); color: var(--grey-600); }
  .trip-card:not(.contrast-mode) .bpb-action-pill svg { fill: var(--grey-500); }
  .trip-card:not(.contrast-mode) .bpb-action-pill .material-symbols-rounded { color: var(--grey-500); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-driver { border-top-color: var(--grey-100); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-driver-item { color: var(--grey-600); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bpb-driver-item strong { color: var(--black); }
  /* Light+Bold: transit & connection bars */
  .trip-card:not(.contrast-mode):not(.dark-mode) .bp-transit.bold-transit { background: rgba(0,169,252,0.06); color: var(--blue-700); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bp-transit.bold-transit strong { color: var(--blue-800); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bold-conn .bp-conn-chip { background: rgba(255,141,84,0.08); border-color: rgba(255,141,84,0.15); color: #cc5500; }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bold-conn .bp-conn-where { color: var(--grey-500); }
  .trip-card:not(.contrast-mode):not(.dark-mode) .bp-luggage.luggage-dark { color: var(--grey-500); }
  /* Light+Bold: hotel card */
  .trip-card:not(.contrast-mode) .htd-title { color: var(--black); }
  .trip-card:not(.contrast-mode) .htd-sub { color: var(--grey-500); }
  .trip-card:not(.contrast-mode) .htd-date-label { color: var(--grey-500); }
  .trip-card:not(.contrast-mode) .htd-date-time { color: var(--black); }
  .trip-card:not(.contrast-mode) .htd-date-day { color: var(--grey-600); }
  .trip-card:not(.contrast-mode) .htd-mid-room { color: var(--grey-400); }
  .trip-card:not(.contrast-mode) .htd-logistics { border-color: var(--grey-100); }
  .trip-card:not(.contrast-mode) .htd-log-item { color: var(--grey-600); }
  .trip-card:not(.contrast-mode) .htd-log-item strong { color: var(--black); }

  /* ===== Contrast-mode — outer card state overrides (stronger signals for high-contrast) ===== */
  .trip-card.contrast-mode.state-imminent { border-color: rgba(0,169,252,0.28); background: linear-gradient(160deg, rgba(0,169,252,0.10) 0%, rgba(255,255,255,0.55) 35%); box-shadow: 0 2px 20px rgba(0,169,252,0.14), 0 0 0 1px rgba(0,169,252,0.10); }
  .trip-card.contrast-mode.state-in_transit { border-color: rgba(0,169,252,0.35); background: linear-gradient(160deg, rgba(0,169,252,0.14) 0%, rgba(255,255,255,0.55) 45%); box-shadow: 0 2px 20px rgba(0,169,252,0.18), 0 0 0 1px rgba(0,169,252,0.12); }
  .trip-card.contrast-mode.state-between_segments { border-color: rgba(34,215,161,0.18); }
  .trip-card.contrast-mode.state-trip_ending { border-color: rgba(34,215,161,0.28); background: linear-gradient(160deg, rgba(34,215,161,0.10) 0%, rgba(255,255,255,0.55) 35%); box-shadow: 0 2px 16px rgba(34,215,161,0.10); }
  .trip-card.contrast-mode.state-imminent .headline,
  .trip-card.contrast-mode.state-in_transit .headline { color: var(--blue-700); }
  .trip-card.contrast-mode.state-trip_ending .headline { color: var(--green-700); }
  /* ===== Contrast-mode — inner cards: dark bg, white text ===== */
  .trip-card.contrast-mode .bp *, .trip-card.contrast-mode .ecard * { color: rgba(255,255,255,0.88); }
  .trip-card.contrast-mode .bp { background: #1a2747; border-color: rgba(255,255,255,0.08); border-radius: 14px; }
  .trip-card.contrast-mode .ecard { background: #1a2747; border-color: rgba(255,255,255,0.08); }
  .trip-card.contrast-mode .ecard strong { color: #fff; }
  .trip-card.contrast-mode .bp-head { border-color: rgba(255,255,255,0.08); }
  .trip-card.contrast-mode .bp-carrier { color: #fff; }
  .trip-card.contrast-mode .bp-carrier-sub { color: rgba(255,255,255,0.55); }
  .trip-card.contrast-mode .bp-date { color: rgba(255,255,255,0.6); }
  .trip-card.contrast-mode .date-icon { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.12); }
  .trip-card.contrast-mode .date-icon-day { color: #fff; }
  .trip-card.contrast-mode .date-icon-month { color: rgba(255,255,255,0.55); }
  .trip-card.contrast-mode .bp-tear { border-top-color: rgba(255,255,255,0.12); }
  .trip-card.contrast-mode .bp-tear::before, .trip-card.contrast-mode .bp-tear::after { background: var(--grey-50); border-color: var(--grey-50); }
  .trip-card.contrast-mode .bp-time { color: #fff; }
  .trip-card.contrast-mode .bp-loc { color: rgba(255,255,255,0.85); }
  .trip-card.contrast-mode .bp-sub { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .bp-arrow-line { background: rgba(255,255,255,0.15); }
  .trip-card.contrast-mode .bp-arrow-line::before, .trip-card.contrast-mode .bp-arrow-line::after { background: rgba(255,255,255,0.25); }
  .trip-card.contrast-mode .bp-ticket-tag { background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.9); border-color: rgba(255,255,255,0.18); }
  .trip-card.contrast-mode .bp-ticket-tag:hover { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.30); }
  .trip-card.contrast-mode .bp-ticket-tag svg { fill: rgba(255,255,255,0.6); }
  .trip-card.contrast-mode .bp-ticket-tag .material-symbols-rounded { color: rgba(255,255,255,0.6); }
  .trip-card.contrast-mode .bp-mid { color: rgba(255,255,255,0.55); }
  .trip-card.contrast-mode .bp-dur { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .bp-meta { border-color: rgba(255,255,255,0.08); }
  .trip-card.contrast-mode .bp-tag { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.06); }
  .trip-card.contrast-mode .bp-tag-label { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .bp-tag-value { color: #fff; }
  .trip-card.contrast-mode .bp-doc { border-color: rgba(255,255,255,0.06); }
  .trip-card.contrast-mode .bp-doc-btn { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.1); }
  .trip-card.contrast-mode .bp-doc-loc { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.1); }
  .trip-card.contrast-mode .bp-doc-wallet { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
  /* Contrast: conn chip is on light outer card — keep default dark-on-light colors */
  .trip-card.contrast-mode .bold-conn .bp-conn-chip { background: rgba(255,141,84,0.08); border-color: rgba(255,141,84,0.15); color: #cc5500; }
  .trip-card.contrast-mode .bold-conn .bp-conn-where { color: var(--grey-500); }
  .trip-card.contrast-mode .bp-luggage { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.65); }
  .trip-card.contrast-mode .bp-transit { background: rgba(0,169,252,0.10); color: var(--blue-800); border: 1px solid rgba(0,169,252,0.15); }
  .trip-card.contrast-mode .bp-transit strong { color: var(--blue-700); }
  .trip-card.contrast-mode .ht-name { color: #fff; }
  .trip-card.contrast-mode .ht-sub { color: rgba(255,255,255,0.6); }
  .trip-card.contrast-mode .ht-badge { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.08); }
  .trip-card.contrast-mode .ht-dates { background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.8); }
  .trip-card.contrast-mode .ht-date-label { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .ht-date-value { color: #fff; }
  .trip-card.contrast-mode .ht-date-sep { color: rgba(255,255,255,0.3); }
  .trip-card.contrast-mode .ht-nights { color: rgba(255,255,255,0.55); }
  .trip-card.contrast-mode .ht-logistics { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.06); }
  .trip-card.contrast-mode .ht-logistics-title { color: rgba(255,255,255,0.65); }
  .trip-card.contrast-mode .ht-logistics-item { color: rgba(255,255,255,0.7); }
  .trip-card.contrast-mode .ht-logistics-item strong { color: #fff; }
  .trip-card.contrast-mode .ht-until { color: var(--orange-400, #ffaa66); }
  .trip-card.contrast-mode .car-title { color: #fff; }
  .trip-card.contrast-mode .car-details { color: rgba(255,255,255,0.6); }
  .trip-card.contrast-mode .car-details .sep { color: rgba(255,255,255,0.3); }
  .trip-card.contrast-mode .car-sched-label { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .car-sched-time { color: #fff; }
  .trip-card.contrast-mode .car-sched-date { color: rgba(255,255,255,0.65); }
  .trip-card.contrast-mode .car-sched-loc { color: rgba(255,255,255,0.55); }
  .trip-card.contrast-mode .car-sched-block.oj .car-sched-label { color: var(--orange-400, #ffaa66); }
  .trip-card.contrast-mode .car-driver { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.06); }
  .trip-card.contrast-mode .car-driver-badge { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
  .trip-card.contrast-mode .car-driver-label { color: rgba(255,255,255,0.5); }
  .trip-card.contrast-mode .car-driver-name { color: #fff; }
  .trip-card.contrast-mode .car-driver-docs { color: rgba(255,255,255,0.55); }
  /* Dark liquid glass gradient — bpb in contrast-mode only (deep dark inner) */
  .trip-card.contrast-mode .bpb { background: linear-gradient(135deg, #162040 0%, #1e2d52 20%, #1a2748 40%, #243562 55%, #182344 75%, #1f2c50 100%); border: 1px solid rgba(100,140,255,0.12); box-shadow: inset 0 1px 0 rgba(100,140,255,0.06), inset 0 -1px 2px rgba(0,0,0,0.15), 0 4px 16px rgba(0,0,0,0.2); }
  .trip-card.contrast-mode .bpb-mid-badge .material-symbols-rounded { color: rgba(255,255,255,0.4); }
  .trip-card.contrast-mode .bpb-mid-badge .mid-label { color: rgba(255,255,255,0.45); }
  /* ===== Dark-contrast mode — dark outer, premium metallic glass inner cards ===== */
  .trip-card.dark-mode .bp {
    background: linear-gradient(165deg, rgba(215,222,242,0.92) 0%, rgba(205,215,238,0.87) 25%, rgba(222,228,248,0.90) 50%, rgba(210,218,240,0.85) 75%, rgba(218,225,244,0.88) 100%);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.55);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.65), inset 0 -1px 0 rgba(0,0,0,0.02), 0 4px 20px rgba(0,0,0,0.10);
  }
  .trip-card.dark-mode .ecard {
    background: linear-gradient(165deg, rgba(215,222,242,0.92) 0%, rgba(205,215,238,0.87) 25%, rgba(222,228,248,0.90) 50%, rgba(210,218,240,0.85) 75%, rgba(218,225,244,0.88) 100%);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.55);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.65), inset 0 -1px 0 rgba(0,0,0,0.02), 0 4px 20px rgba(0,0,0,0.10);
  }
  .trip-card.dark-mode .bpb {
    background: linear-gradient(135deg, rgba(210,220,245,0.88) 0%, rgba(200,212,240,0.82) 20%, rgba(220,228,250,0.86) 40%, rgba(205,215,242,0.80) 60%, rgba(215,224,248,0.85) 80%, rgba(210,220,244,0.83) 100%);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.50);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.60), inset 0 -1px 2px rgba(0,0,0,0.03), 0 4px 20px rgba(0,0,0,0.10);
  }
  /* Dark-contrast bold card text & badge overrides for glass bg */
  .trip-card.dark-mode .bpb-carrier { color: #1a1a2e; }
  .trip-card.dark-mode .bpb-carrier .bp-carrier-sub { color: rgba(30,30,60,0.6); }
  .trip-card.dark-mode .bpb-date { color: rgba(30,30,60,0.7); }
  .trip-card.dark-mode .bpb .date-icon { background: rgba(30,30,70,0.06); border-color: rgba(30,30,70,0.12); }
  .trip-card.dark-mode .bpb .date-icon-day { color: #1a1a2e; }
  .trip-card.dark-mode .bpb .date-icon-month { color: rgba(30,30,60,0.55); }
  .trip-card.dark-mode .date-icon { background: rgba(255,255,255,0.50); border-color: rgba(255,255,255,0.35); }
  .trip-card.dark-mode .date-icon-day { color: #0a0a20; }
  .trip-card.dark-mode .date-icon-month { color: rgba(30,30,60,0.55); }
  .trip-card.dark-mode .bpb-num { color: rgba(10,10,30,0.85); }
  .trip-card.dark-mode .bpb-ref { color: rgba(30,30,60,0.4); }
  .trip-card.dark-mode .bpb-code { color: #0a0a20; font-weight: 800; }
  .trip-card.dark-mode .bpb-time { color: #1a1a2e; }
  .trip-card.dark-mode .bpb-name { color: rgba(20,20,50,0.85); }
  .trip-card.dark-mode .bpb-mid-line { background: rgba(30,30,70,0.22); }
  .trip-card.dark-mode .bpb-mid-line:first-child::before, .trip-card.dark-mode .bpb-mid-line:last-child::after { background: rgba(30,30,70,0.30); }
  .trip-card.dark-mode .bpb-mid-badge .material-symbols-rounded { color: rgba(30,30,60,0.40); }
  .trip-card.dark-mode .bpb-mid-badge .mid-label { color: rgba(30,30,60,0.45); }
  .trip-card.dark-mode .bpb-dur { color: rgba(200,120,40,0.8); }
  .trip-card.dark-mode .bpb-dur .material-symbols-rounded { color: rgba(200,120,40,0.9); }
  .trip-card.dark-mode .bpb .bp-tag { background: rgba(255,255,255,0.55); border-color: rgba(255,255,255,0.40); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  .trip-card.dark-mode .bpb .bp-tag-label { color: rgba(30,30,60,0.6); }
  .trip-card.dark-mode .bpb .bp-tag-value { color: #0a0a20; font-weight: 700; }
  .trip-card.dark-mode .bpb .bp-tag.accent { background: rgba(0,169,252,0.15); border-color: rgba(0,169,252,0.25); }
  .trip-card.dark-mode .bpb .bp-tag.accent .bp-tag-label { color: #006aaa; }
  .trip-card.dark-mode .bpb .bp-tag.accent .bp-tag-value { color: #004d80; }
  .trip-card.dark-mode .bpb .bp-tag.warm { background: rgba(230,100,30,0.12); border-color: rgba(230,100,30,0.22); }
  .trip-card.dark-mode .bpb .bp-tag.warm .bp-tag-label { color: #b34700; }
  .trip-card.dark-mode .bpb .bp-tag.warm .bp-tag-value { color: #8a3800; }
  .trip-card.dark-mode .bpb .bp-doc { border-color: rgba(30,30,70,0.10); }
  .trip-card.dark-mode .bpb .bp-doc-loc { color: rgba(30,30,60,0.65); border-color: rgba(30,30,70,0.12); }
  .trip-card.dark-mode .bpb .bp-doc-wallet { color: #1a1a2e; background: rgba(255,255,255,0.45); border-color: rgba(255,255,255,0.30); }
  .trip-card.dark-mode .bpb-driver { border-top-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .bpb-driver-item { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .bpb-driver-item strong { color: #0a0a20; }
  /* Dark-contrast classic card text overrides for glass bg */
  .trip-card.dark-mode .bp-carrier { color: #1a1a2e; }
  .trip-card.dark-mode .bp-carrier-sub { color: rgba(30,30,60,0.55); }
  .trip-card.dark-mode .bp-date { color: rgba(30,30,60,0.65); }
  .trip-card.dark-mode .bp-time { color: #0a0a20; }
  .trip-card.dark-mode .bp-loc { color: rgba(20,20,50,0.85); }
  .trip-card.dark-mode .bp-sub { color: rgba(30,30,60,0.5); }
  .trip-card.dark-mode .bp-dur { color: rgba(30,30,60,0.5); }
  .trip-card.dark-mode .bp-arrow-line { background: rgba(30,30,70,0.15); }
  .trip-card.dark-mode .bp-arrow-line::before, .trip-card.dark-mode .bp-arrow-line::after { background: rgba(30,30,70,0.25); }
  .trip-card.dark-mode .bp-ticket-tag { background: rgba(255,255,255,0.45); color: #1a1a2e; border-color: rgba(255,255,255,0.35); }
  .trip-card.dark-mode .bp-ticket-tag:hover { background: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.5); }
  .trip-card.dark-mode .bp-ticket-tag svg { fill: rgba(30,30,60,0.45); }
  .trip-card.dark-mode .bp-ticket-tag .material-symbols-rounded { color: rgba(30,30,60,0.45); }
  .trip-card.dark-mode .bp-ticket-tag.deferred { background: rgba(255,255,255,0.3); color: rgba(30,30,60,0.5); border-color: rgba(255,255,255,0.2); }
  .trip-card.dark-mode .bpb-action-pill { background: rgba(30,30,70,0.12); color: rgba(30,30,60,0.70); border-color: rgba(30,30,70,0.14); }
  .trip-card.dark-mode .bpb-action-pill svg { fill: rgba(30,30,60,0.55); }
  .trip-card.dark-mode .bpb-action-pill .material-symbols-rounded { color: rgba(30,30,60,0.55); }
  .trip-card.dark-mode .bp-tag { background: rgba(255,255,255,0.50); border-color: rgba(255,255,255,0.35); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .trip-card.dark-mode .bp-tag-label { color: rgba(30,30,60,0.6); }
  .trip-card.dark-mode .bp-tag-value { color: #0a0a20; font-weight: 700; }
  .trip-card.dark-mode .bp-tag.accent { background: rgba(0,169,252,0.15); border-color: rgba(0,169,252,0.25); }
  .trip-card.dark-mode .bp-tag.accent .bp-tag-label { color: #006aaa; }
  .trip-card.dark-mode .bp-tag.accent .bp-tag-value { color: #004d80; }
  .trip-card.dark-mode .bp-tag.warm { background: rgba(230,100,30,0.12); border-color: rgba(230,100,30,0.22); }
  .trip-card.dark-mode .bp-tag.warm .bp-tag-label { color: #b34700; }
  .trip-card.dark-mode .bp-tag.warm .bp-tag-value { color: #8a3800; }
  .trip-card.dark-mode .bp-head { border-color: rgba(30,30,70,0.08); }
  .trip-card.dark-mode .bp-tear { border-top-color: rgba(30,30,70,0.10); }
  .trip-card.dark-mode .bp-doc { border-color: rgba(30,30,70,0.08); }
  .trip-card.dark-mode .bp-doc-btn { background: rgba(255,255,255,0.45); color: #1a1a2e; border-color: rgba(255,255,255,0.30); }
  .trip-card.dark-mode .bp-doc-loc { color: rgba(30,30,60,0.65); border-color: rgba(30,30,70,0.12); }
  .trip-card.dark-mode .bp-doc-wallet { color: #1a1a2e; background: rgba(255,255,255,0.45); border-color: rgba(255,255,255,0.30); }
  /* Dark-contrast hotel bold (.htd-*) text overrides for glass bg */
  .trip-card.dark-mode .htd-title { color: #0a0a20; }
  .trip-card.dark-mode .htd-sub { color: rgba(20,20,50,0.7); }
  .trip-card.dark-mode .htd-date-label { color: rgba(20,20,50,0.65); }
  .trip-card.dark-mode .htd-date-time { color: #0a0a20; }
  .trip-card.dark-mode .htd-date-day { color: rgba(20,20,50,0.75); }
  .trip-card.dark-mode .htd-mid-room { color: rgba(20,20,50,0.45); }
  .trip-card.dark-mode .htd-dates { border-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .htd-logistics { background: rgba(30,30,60,0.06); border-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .htd-log-item { color: rgba(20,20,50,0.75); }
  .trip-card.dark-mode .htd-log-item strong { color: #0a0a20; }
  /* Dark-contrast hotel classic (.ht-*) text overrides for glass bg */
  .trip-card.dark-mode .ht-name { color: #0a0a20; }
  .trip-card.dark-mode .ht-sub { color: rgba(20,20,50,0.65); }
  .trip-card.dark-mode .ht-badge { background: rgba(255,255,255,0.50); color: rgba(20,20,50,0.8); border-color: rgba(255,255,255,0.35); }
  .trip-card.dark-mode .ht-dates { background: rgba(30,30,60,0.05); color: rgba(20,20,50,0.8); }
  .trip-card.dark-mode .ht-date-label { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .ht-date-value { color: #0a0a20; }
  .trip-card.dark-mode .ht-date-sep { color: rgba(20,20,50,0.35); }
  .trip-card.dark-mode .ht-nights { color: rgba(20,20,50,0.55); }
  .trip-card.dark-mode .ht-logistics { background: rgba(255,255,255,0.15); border-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .ht-logistics-title { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .ht-logistics-item { color: rgba(20,20,50,0.75); }
  .trip-card.dark-mode .ht-logistics-item strong { color: #0a0a20; }
  /* Dark-contrast car classic (.car-*) text overrides for glass bg */
  .trip-card.dark-mode .car-title { color: #0a0a20; }
  .trip-card.dark-mode .car-details { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .car-details .sep { color: rgba(20,20,50,0.3); }
  .trip-card.dark-mode .car-sched-label { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .car-sched-time { color: #0a0a20; }
  .trip-card.dark-mode .car-sched-date { color: rgba(20,20,50,0.7); }
  .trip-card.dark-mode .car-sched-loc { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .car-sched-block.oj .car-sched-label { color: #cc5500; }
  .trip-card.dark-mode .car-schedule { border-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .car-driver { border-color: rgba(30,30,60,0.08); }
  .trip-card.dark-mode .car-driver-label { color: rgba(20,20,50,0.55); }
  .trip-card.dark-mode .car-driver-name { color: #0a0a20; }
  .trip-card.dark-mode .car-driver-docs { color: rgba(20,20,50,0.6); }
  .trip-card.dark-mode .bp-transit { background: rgba(0,169,252,0.15); color: var(--blue-200); border: 1px solid rgba(0,169,252,0.12); }
  .trip-card.dark-mode .bp-transit strong { color: var(--blue-100); }
  .trip-card.dark-mode .bp-tear::before, .trip-card.dark-mode .bp-tear::after { background: #252540; border-color: #252540; }
  .trip-card.dark-mode .cta-row .cta-sec, .trip-card.contrast-mode .cta-row .cta-sec { border-color: rgba(255,255,255,0.12); color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.06); }
  .trip-card.dark-mode .cta-row .cta-pri, .trip-card.contrast-mode .cta-row .cta-pri { background: var(--blue-500); color: #fff; border-color: var(--blue-500); }

  /* Showcase grid */
  #showcase-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
  .sc-config { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--grey-100); }
  .sc-config-row { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
  .sc-config-row:last-child { margin-bottom: 0; }
  .sc-config-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--grey-400); min-width: 64px; font-family: var(--font); }
  .sc-config-pill { padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; border: 1.5px solid var(--grey-100); background: var(--white); color: var(--grey-600); cursor: pointer; font-family: var(--font); transition: all 0.15s; }
  .sc-config-pill:hover { background: var(--grey-50); border-color: var(--grey-200); color: var(--black); }
  .sc-config-pill.active { background: var(--black); color: var(--white); border-color: var(--black); }
  .sc-toggle { position: relative; width: 36px; height: 20px; border-radius: 10px; background: var(--grey-200); border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
  .sc-toggle.on { background: var(--blue-500); }
  .sc-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 50%; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
  .sc-toggle.on::after { transform: translateX(16px); }
  .sc-toggle-label { font-size: 11px; font-weight: 600; color: var(--grey-500); font-family: var(--font); }
  .sc-preview { max-width: 380px; width: 380px; }
  .showcase-item { border-radius: 14px; overflow: hidden; box-shadow: 0 1px 6px rgba(0,0,0,0.08); }
  .showcase-label { padding: 8px 14px; font-size: 11px; font-weight: 700; font-family: var(--font); letter-spacing: 0.3px; background: var(--grey-50); color: var(--grey-600); border-bottom: 1px solid var(--grey-100); }
  .showcase-panel { padding: 0; background: var(--white); }
  /* Showcase color overrides */
  #showcase-container[data-color="contrast"] .showcase-item { box-shadow: 0 1px 6px rgba(0,0,0,0.3); }
  #showcase-container[data-color="contrast"] .showcase-label { background: #0f1a30; color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.06); }
  #showcase-container[data-color="contrast"] .showcase-panel { background: #1a2747; color: rgba(255,255,255,0.85); }
  #showcase-container[data-color="contrast"] .sheet-header { border-color: rgba(255,255,255,0.08); }
  #showcase-container[data-color="contrast"] .sheet-title { color: #fff; }
  #showcase-container[data-color="contrast"] .date-icon { background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.15); }
  #showcase-container[data-color="contrast"] .date-icon-day { color: #fff; }
  #showcase-container[data-color="contrast"] .date-icon-month { color: rgba(255,255,255,0.6); }
  #showcase-container[data-color="contrast"] .sheet-close { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
  #showcase-container[data-color="contrast"] .sheet-info { background: rgba(0,169,252,0.12); border-color: rgba(0,169,252,0.2); color: var(--blue-300); }
  #showcase-container[data-color="contrast"] .sheet-qr { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.14); color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-qr-label { color: rgba(255,255,255,0.4); }
  #showcase-container[data-color="contrast"] .sheet-doc { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
  #showcase-container[data-color="contrast"] .sheet-doc-name { color: #fff; }
  #showcase-container[data-color="contrast"] .sheet-doc-meta { color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-pax { color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-pax strong { color: rgba(255,255,255,0.7); }
  #showcase-container[data-color="contrast"] .sheet-pdf { border-color: rgba(255,255,255,0.18); background: #fff; }
  #showcase-container[data-color="contrast"] .sheet-dl-name { color: #fff; }
  #showcase-container[data-color="contrast"] .sheet-dl-meta { color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-dl-btn { background: rgba(255,255,255,0.12); color: #fff; }
  #showcase-container[data-color="contrast"] .sheet-detail-label { color: rgba(255,255,255,0.4); }
  #showcase-container[data-color="contrast"] .sheet-detail-value { color: #fff; }
  #showcase-container[data-color="contrast"] .sheet-detail-sub { color: rgba(255,255,255,0.5); }
  #showcase-container[data-color="contrast"] .sheet-conditions { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.65); }
  #showcase-container[data-color="contrast"] .sheet-map-btn { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
  #showcase-container[data-color="contrast"] .sheet-ticket-label { color: #fff; }
  #showcase-container[data-color="contrast"] .sheet-ticket-route { color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-ticket-nav button { border-color: rgba(255,255,255,0.18); color: rgba(255,255,255,0.7); }
  #showcase-container[data-color="contrast"] .sheet-ticket-counter { color: rgba(255,255,255,0.4); }
  #showcase-container[data-color="contrast"] .sheet-divider { background: rgba(255,255,255,0.08); }
  #showcase-container[data-color="contrast"] .sheet-footer { border-color: rgba(255,255,255,0.08); }
  #showcase-container[data-color="contrast"] .sheet-footer a { color: rgba(255,255,255,0.45); }
  #showcase-container[data-color="contrast"] .sheet-actions .cta-pri { background: #fff; color: #1a2747; font-weight: 800; }
  #showcase-container[data-color="contrast"] .sheet-actions .cta-sec { border-color: rgba(255,255,255,0.18); color: #fff; background: rgba(255,255,255,0.08); }
</style>
</head>
<body class="color-contrast">

<!-- Sidebar (desktop: fixed left, mobile: bottom overlay) -->
<div class="proto-sidebar" id="proto-sidebar">
  <div class="proto-sidebar-head">
    <span id="proto-sidebar-title">Paramètres timeline</span>
    <button class="proto-sidebar-close" onclick="dismissConfig()">&#10005;</button>
  </div>
  <div class="proto-panel" id="proto-panel"></div>
</div>
<div class="proto-backdrop" id="proto-backdrop" onclick="dismissConfig()"></div>

<div class="proto-main">

<div class="proto-header" id="proto-header">
  <div class="proto-tabs">
    <button class="proto-sidebar-toggle" id="proto-sidebar-toggle" onclick="togglePanel()" title="Config"><span class="material-symbols-rounded" style="font-size:16px">tune</span></button>
    <button class="proto-tab active" data-tab="timeline" onclick="setTab('timeline')">Timeline</button>
    <button class="proto-tab" data-tab="ticket" onclick="setTab('ticket')">Ticket modal</button>
    <div class="proto-globals">
      <button onclick="setColor('light')" id="btn-color-light">Light</button>
      <button onclick="setColor('contrast')" id="btn-color-contrast" class="active">Contrast</button>
      <div class="sep"></div>
      <button onclick="setLayout('classic')" id="btn-layout-classic">Classic</button>
      <button onclick="setLayout('bold')" id="btn-layout-bold" class="active">Bold</button>
    </div>
  </div>
</div>

<div id="showcase-container" style="display:none"></div>
<div id="cards-container"></div>

<div class="home-skeleton" id="home-skeleton">

  <!-- Validations en attente -->
  <div class="skel-section">
    <div class="skel-section-title">
      <span>Validations en attente</span>
      <span class="skel-badge">3</span>
    </div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle sm"></div><div style="flex:1"><div class="skel-bar w60"></div><div class="skel-bar w40 h6" style="margin-top:6px"></div></div><div class="skel-bar w30 h14" style="max-width:60px;border-radius:7px"></div></div>
    </div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle sm"></div><div style="flex:1"><div class="skel-bar w50"></div><div class="skel-bar w30 h6" style="margin-top:6px"></div></div><div class="skel-bar w30 h14" style="max-width:60px;border-radius:7px"></div></div>
    </div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle sm"></div><div style="flex:1"><div class="skel-bar w70"></div><div class="skel-bar w40 h6" style="margin-top:6px"></div></div><div class="skel-bar w30 h14" style="max-width:60px;border-radius:7px"></div></div>
    </div>
  </div>

  <!-- Voyages à venir -->
  <div class="skel-section">
    <div class="skel-section-title">Voyages à venir</div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle"></div><div style="flex:1"><div class="skel-bar w70 h14"></div><div class="skel-bar w40 h6" style="margin-top:6px"></div></div></div>
      <div class="skel-row" style="margin-top:12px"><div class="skel-bar w80 h6"></div></div>
      <div class="skel-row"><div class="skel-bar w60 h6"></div></div>
    </div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle"></div><div style="flex:1"><div class="skel-bar w50 h14"></div><div class="skel-bar w30 h6" style="margin-top:6px"></div></div></div>
      <div class="skel-row" style="margin-top:12px"><div class="skel-bar w70 h6"></div></div>
      <div class="skel-row"><div class="skel-bar w50 h6"></div></div>
    </div>
  </div>

  <!-- Raccourcis -->
  <div class="skel-section">
    <div class="skel-section-title">Raccourcis</div>
    <div style="display:flex;gap:10px">
      <div class="skel-card" style="flex:1;text-align:center;padding:20px 12px">
        <div class="skel-circle" style="margin:0 auto 8px"></div>
        <div class="skel-bar w60 h6" style="margin:0 auto"></div>
      </div>
      <div class="skel-card" style="flex:1;text-align:center;padding:20px 12px">
        <div class="skel-circle" style="margin:0 auto 8px"></div>
        <div class="skel-bar w60 h6" style="margin:0 auto"></div>
      </div>
      <div class="skel-card" style="flex:1;text-align:center;padding:20px 12px">
        <div class="skel-circle" style="margin:0 auto 8px"></div>
        <div class="skel-bar w60 h6" style="margin:0 auto"></div>
      </div>
    </div>
  </div>

  <!-- Voyages passés -->
  <div class="skel-section">
    <div class="skel-section-title">Voyages passés</div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle sm"></div><div style="flex:1"><div class="skel-bar w60 h14"></div><div class="skel-bar w40 h6" style="margin-top:6px"></div></div></div>
    </div>
    <div class="skel-card">
      <div class="skel-row"><div class="skel-circle sm"></div><div style="flex:1"><div class="skel-bar w50 h14"></div><div class="skel-bar w30 h6" style="margin-top:6px"></div></div></div>
    </div>
  </div>

</div>

</div><!-- /.proto-main -->

<div class="float-drawer" id="float-drawer">
  <div class="float-drawer-body" id="float-drawer-body"></div>
  <button class="float-drawer-toggle" onclick="toggleFloatDrawer()">&#9881;</button>
</div>

<div class="sheet-overlay" id="sheet-overlay" onclick="if(event.target===this)closeSheet()">
  <div class="sheet-panel">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="sheet-title" id="sheet-title"></div>
      <button class="sheet-close" onclick="closeSheet()">&#10005;</button>
    </div>
    <div class="sheet-body" id="sheet-body"></div>
  </div>
</div>

<script>
const TRIPS = {
  full: {
    destination: 'Aix-en-Provence',
    travelers: ['Stella Smith', 'Donnie Schmidt'],
    etapes: [
      {
        type: 'train', icon: '🚄',
        title: 'Aéroport Charles-de-Gaulle TGV → Aix-en-Provence TGV',
        shortLabel: 'CDG TGV → Aix TGV', dateShort: 'Ven 09 · 12:30',
        departure: { time: '12:30', name: 'Aéroport Charles-de-Gaulle TGV', date: 'Ven. 09 Fév' },
        arrival: { time: '16:32', name: 'Aix-en-Provence TGV', date: 'Ven. 09 Fév' },
        duration: '2h02',
        carrier: 'Ouigo', details: ['2nde classe', 'Direct'],
        seat: { wagon: '12', place: '45' },
        ticket: { available: true, hasQR: true, wallet: true },
        num: 'OUIGO 7641', pnr: 'HJKL42', platform: '3',
        fareName: 'Prem\'s', fareExch: false, fareRefund: false, amenities: ['wifi', 'power'],
        voucherPdf: 'voucher-train.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      },
      {
        type: 'hotel', icon: '🏨',
        title: 'Hôtel Renaissance Bordeaux Centre Historique',
        shortLabel: 'Hôtel Renaissance Bordeaux', dateShort: 'Ven 09 – Dim 11',
        checkin: { date: 'Vendredi 9 Février', time: '15:00' },
        checkout: { date: 'Dimanche 11 Février', time: '11:00' },
        nights: 3, starsText: '★★★★',
        roomName: 'Chambre Deluxe Double',
        inclusions: ['Petit-déjeuner inclus'],
        cancellation: { type: 'free', freeUntil: '7 Février 2026' },
        freeTextConditions: 'Récupérez votre clé à la réception. Check-in à partir de 15h. Réception ouverte 24h/24. Contact : +33 5 56 48 88 88',
        bookingRef: 'MRR-482910',
        address: '15 Rue du Temple, 33000 Bordeaux',
        photos: [
          'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=300&h=300&fit=crop',
          'https://images.unsplash.com/photo-1590490360182-c33d57733427?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'car', icon: '🚗',
        title: 'Avis – Location de véhicule',
        shortLabel: 'Avis Bordeaux', dateShort: 'Mar 17 – Mer 18',
        pickup: { time: '14:00', date: 'Mardi 17 Février', location: 'Gare Saint-Jean, 33800 Bordeaux' },
        dropoff: { time: '18:00', date: 'Mercredi 18 Février', location: 'Gare Saint-Jean, 33800 Bordeaux' },
        carrier: 'Avis', details: ['Cat. B', '1 jour'],
        bookingRef: 'AVIS-84729',
        driverName: 'Stella Smith',
        carPhoto: 'https://images.unsplash.com/photo-1502877338535-766e1452684a?w=260&h=180&fit=crop',
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-flight.pdf',
        locLabel: "Itinéraire vers l'agence", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'train', icon: '🚄',
        title: 'Bordeaux Saint-Jean → Paris Montparnasse',
        shortLabel: 'Bordeaux → Paris', dateShort: 'Mer 18 · 14:00',
        departure: { time: '14:00', name: 'Bordeaux Saint-Jean', date: 'Mer. 18 Fév' },
        arrival: { time: '16:15', name: 'Paris Montparnasse', date: 'Mer. 18 Fév' },
        duration: '2h15',
        carrier: 'Ouigo', details: ['2nde classe', 'Direct'],
        seat: null,
        ticket: { available: false, hasQR: false, wallet: false, availableDate: '14 Fév' },
        num: 'OUIGO 7860', pnr: 'HJKL42',
        fareName: 'Prem\'s', fareExch: false, fareRefund: false, amenities: ['wifi', 'power'],
        docLabel: 'Voir mon billet', docIcon: '🎫',
        docAvailable: false, docDisabledText: 'Billet disponible à partir du 14 Fév',
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      }
    ]
  },
  openjaw: {
    destination: 'Nice',
    travelers: ['Stella Smith'],
    etapes: [
      {
        type: 'flight', icon: '✈️',
        title: 'Paris CDG → Nice Côte d\'Azur',
        shortLabel: 'CDG → NCE', dateShort: 'Lun 09 · 07:15',
        departure: { time: '07:15', name: 'Paris', code: 'CDG', terminal: 'T2F', date: 'Lun. 09 Fév' },
        arrival: { time: '08:50', name: 'Nice', code: 'NCE', terminal: 'T1', date: 'Lun. 09 Fév' },
        duration: '1h35', carrier: 'Air France', details: ['Economy', 'Direct'],
        luggage: '1 cabine + 1 soute 23 kg',
        seat: { place: '14A' },
        ticket: { available: true, hasQR: false, wallet: false },
        num: 'AF 7680', pnr: 'ABC123', gate: 'B24',
        fareName: 'Economy Standard', fareExch: 'with_fee', fareRefund: false, amenities: ['meal', 'wifi'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'hotel', icon: '🏨',
        title: 'Hyatt Regency Nice Palais de la Méditerranée',
        shortLabel: 'Hyatt Nice', dateShort: 'Lun 09 – Jeu 12',
        checkin: { date: 'Lundi 9 Février', time: '14:00' },
        checkout: { date: 'Jeudi 12 Février', time: '12:00' },
        nights: 3, starsText: '★★★★★',
        roomName: 'Suite Méditerranée Vue Mer',
        inclusions: ['Petit-déjeuner inclus', 'Demi-pension'],
        cancellation: { type: 'restricted', freeUntil: '5 Février 2026' },
        freeTextConditions: 'Récupérez votre clé à la réception. Check-in de 14h à 23h. Late check-out possible sur demande. Contact : +33 4 93 27 12 34',
        bookingRef: 'HYT-556271',
        address: '13 Promenade des Anglais, 06000 Nice',
        photos: [
          'https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1618773928121-c32242e63f39?w=300&h=300&fit=crop',
          'https://images.unsplash.com/photo-1584132967334-10e028bd69f7?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'car', icon: '🚗',
        title: 'Europcar – Nice → Marseille',
        shortLabel: 'Europcar OJ', dateShort: 'Jeu 12 – Ven 13',
        pickup: { time: '12:00', date: 'Jeudi 12 Février', location: 'Aéroport Nice NCE, T1' },
        dropoff: { time: '09:00', date: 'Vendredi 13 Février', location: 'Aéroport Marseille MRS, T1' },
        carrier: 'Europcar', details: ['Cat. C', '1 jour'],
        bookingRef: 'EUR-19384',
        driverName: 'Stella Smith',
        carPhoto: 'https://images.unsplash.com/photo-1549399542-7e3f8b79c341?w=260&h=180&fit=crop',
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'agence", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'flight', icon: '✈️',
        title: 'Marseille MRS → Paris CDG',
        shortLabel: 'MRS → CDG', dateShort: 'Ven 13 · 11:30',
        departure: { time: '11:30', name: 'Marseille', code: 'MRS', terminal: 'T1', date: 'Ven. 13 Fév' },
        arrival: { time: '13:00', name: 'Paris', code: 'CDG', terminal: 'T2F', date: 'Ven. 13 Fév' },
        duration: '1h30', carrier: 'Air France', details: ['Economy', 'Direct'],
        luggage: '1 cabine + 1 soute 23 kg', seat: null,
        ticket: { available: true, hasQR: false, wallet: false },
        num: 'AF 7695', pnr: 'ABC123',
        fareName: 'Economy Standard', fareExch: 'with_fee', fareRefund: false, amenities: ['meal', 'wifi'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      }
    ]
  },
  correspondance: {
    destination: 'Bordeaux',
    travelers: ['Stella Smith', 'Donnie Schmidt'],
    etapes: [
      {
        type: 'train', icon: '🚄',
        title: 'Paris Montparnasse → Bordeaux Saint-Jean',
        shortLabel: 'Paris → Bordeaux', dateShort: 'Ven 09 · 08:30',
        departure: { time: '08:30', name: 'Paris Montparnasse', date: 'Ven. 09 Fév' },
        arrival: { time: '14:28', name: 'Bordeaux Saint-Jean', date: 'Ven. 09 Fév' },
        duration: '5h58',
        carrier: 'SNCF', details: ['2nde classe', '1 correspondance'],
        segments: [
          { dep: { time: '08:30', name: 'Paris Montparnasse' }, arr: { time: '10:32', name: 'Lyon Part-Dieu' }, dur: '2h02', num: 'TGV 6211', pnr: 'XYZW89', platform: '7', seat: { wagon: '7', place: '62' }, fareName: 'Loisir', fareExch: 'with_fee', fareRefund: false, amenities: ['wifi', 'power', 'bar'] },
          { dep: { time: '11:15', name: 'Lyon Part-Dieu' }, arr: { time: '14:28', name: 'Bordeaux Saint-Jean' }, dur: '3h13', num: 'TGV 6825', pnr: 'XYZW89', platform: '12', seat: { wagon: '3', place: '18' }, fareName: 'Loisir', fareExch: 'with_fee', fareRefund: false, amenities: ['wifi', 'power', 'bar'] },
        ],
        connections: [{ loc: 'Lyon Part-Dieu', dur: '43 min' }],
        seat: { wagon: '7', place: '62' },
        ticket: { available: true, hasQR: true, wallet: false },
        pnr: 'XYZW89',
        fareName: 'Loisir', fareExch: 'with_fee', fareRefund: false, amenities: ['wifi', 'power', 'bar'],
        voucherPdf: 'voucher-train.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      },
      {
        type: 'hotel', icon: '🏨',
        title: 'Hôtel Renaissance Bordeaux Centre Historique',
        shortLabel: 'Hôtel Renaissance Bordeaux', dateShort: 'Ven 09 – Dim 11',
        checkin: { date: 'Vendredi 9 Février', time: '15:00' },
        checkout: { date: 'Dimanche 11 Février', time: '11:00' },
        nights: 2, starsText: '★★★★',
        roomName: 'Chambre Deluxe Double',
        inclusions: ['Petit-déjeuner inclus'],
        cancellation: { type: 'free', freeUntil: '7 Février 2026' },
        freeTextConditions: 'Récupérez votre clé à la réception. Check-in à partir de 15h. Réception ouverte 24h/24. Contact : +33 5 56 48 88 88',
        bookingRef: 'MRR-482910',
        address: '15 Rue du Temple, 33000 Bordeaux',
        photos: [
          'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=300&h=300&fit=crop',
          'https://images.unsplash.com/photo-1590490360182-c33d57733427?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'train', icon: '🚄',
        title: 'Bordeaux Saint-Jean → Paris Montparnasse',
        shortLabel: 'Bordeaux → Paris', dateShort: 'Dim 11 · 14:00',
        departure: { time: '14:00', name: 'Bordeaux Saint-Jean', date: 'Dim. 11 Fév' },
        arrival: { time: '16:15', name: 'Paris Montparnasse', date: 'Dim. 11 Fév' },
        duration: '2h15', carrier: 'Ouigo', details: ['2nde classe', 'Direct'],
        seat: null,
        ticket: { available: true, hasQR: true, wallet: false },
        num: 'OUIGO 7854', pnr: 'XYZW89',
        fareName: 'Prem\'s', fareExch: false, fareRefund: false, amenities: ['wifi'],
        voucherPdf: 'voucher-train.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      }
    ]
  },
  escale: {
    destination: 'Athènes',
    travelers: ['Stella Smith'],
    etapes: [
      {
        type: 'flight', icon: '✈️',
        title: 'Paris CDG → Athènes ATH',
        shortLabel: 'CDG → ATH', dateShort: 'Lun 09 · 06:45',
        departure: { time: '06:45', name: 'Paris', code: 'CDG', terminal: 'T1', date: 'Lun. 09 Fév' },
        arrival: { time: '13:35', name: 'Athènes', code: 'ATH', terminal: null, date: 'Lun. 09 Fév' },
        duration: '7h50',
        carrier: 'Lufthansa', details: ['Economy', '1 escale'],
        segments: [
          { dep: { time: '06:45', name: 'Paris', code: 'CDG', terminal: 'T1' }, arr: { time: '08:25', name: 'Munich', code: 'MUC', terminal: 'T2' }, dur: '1h40', num: 'LH 2231', pnr: 'KLM456', gate: 'G23', seat: { place: '22F' }, fareName: 'Economy Light', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'] },
          { dep: { time: '09:45', name: 'Munich', code: 'MUC', terminal: 'T2' }, arr: { time: '13:35', name: 'Ath\u00e8nes', code: 'ATH' }, dur: '2h50', num: 'LH 1752', pnr: 'KLM456', seat: { place: '22F' }, fareName: 'Economy Light', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'] },
        ],
        connections: [{ loc: 'Munich MUC', dur: '1h20', detail: 'Terminal 2' }],
        luggage: '1 cabine + 1 soute 23 kg · Bagages jusqu\'à ATH',
        seat: { place: '22F' },
        ticket: { available: true, hasQR: false, wallet: false },
        pnr: 'KLM456',
        fareName: 'Economy Light', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'hotel', icon: '🏨',
        title: 'Hotel Grande Bretagne, a Luxury Collection Hotel, Athens',
        shortLabel: 'Hotel Grande Bretagne Athens', dateShort: 'Lun 09 – Jeu 12',
        checkin: { date: 'Lundi 9 Février', time: '15:00' },
        checkout: { date: 'Jeudi 12 Février', time: '12:00' },
        nights: 3, starsText: '★★★★★',
        roomName: 'Grand Deluxe Suite vue Acropole',
        inclusions: ['Petit-déjeuner buffet inclus', 'Wifi premium'],
        cancellation: { type: 'free', freeUntil: '3 Février 2026' },
        freeTextConditions: 'Récupérez votre clé à la réception. Check-in à partir de 15h. Réception ouverte 24h/24. Late check-out 14h disponible. Contact : +30 210 333 0000',
        bookingRef: 'ATH-556271',
        address: '1 Vasileos Georgiou A\', Syntagma, 105 64 Athènes',
        photos: [
          'https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1618773928121-c32242e63f39?w=300&h=300&fit=crop',
          'https://images.unsplash.com/photo-1584132967334-10e028bd69f7?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'flight', icon: '✈️',
        title: 'Athènes ATH → Paris CDG',
        shortLabel: 'ATH → CDG', dateShort: 'Jeu 12 · 22:50',
        departure: { time: '22:50', name: 'Athènes', code: 'ATH', terminal: null, date: 'Jeu. 12 Fév' },
        arrival: { time: '01:35', name: 'Paris', code: 'CDG', terminal: 'T1', date: 'Ven. 13 Fév', dayOffset: 1 },
        duration: '3h45', carrier: 'Aegean', details: ['Economy', 'Direct'],
        luggage: '1 cabine + 1 soute 23 kg', seat: null,
        ticket: { available: true, hasQR: false, wallet: false },
        num: 'A3 621', pnr: 'KLM456',
        fareName: 'Economy Flex', fareExch: true, fareRefund: 'with_fee', amenities: ['meal'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      }
    ]
  },
  escale3: {
    destination: 'Bangkok',
    travelers: ['Stella Smith'],
    etapes: [
      {
        type: 'flight', icon: '✈️',
        title: 'Paris CDG → Bangkok BKK',
        shortLabel: 'CDG → BKK', dateShort: 'Lun 09 · 10:15',
        departure: { time: '10:15', name: 'Paris', code: 'CDG', terminal: 'T1', date: 'Lun. 09 Fév' },
        arrival: { time: '14:30', name: 'Bangkok', code: 'BKK', terminal: null, date: 'Mar. 10 Fév', dayOffset: 1 },
        duration: '22h15',
        carrier: 'Lufthansa', details: ['Economy', '3 escales'],
        segments: [
          { dep: { time: '10:15', name: 'Paris', code: 'CDG', terminal: 'T1' }, arr: { time: '11:25', name: 'Francfort', code: 'FRA', terminal: 'T1' }, dur: '1h10', num: 'LH 1035', pnr: 'BKK901', seat: { place: '34A' }, carrier: 'Lufthansa', ticket: { available: true, hasQR: false, wallet: false }, voucherPdf: 'voucher-flight.pdf', fareName: 'Economy Light', fareExch: false, fareRefund: false, amenities: ['meal'] },
          { dep: { time: '13:00', name: 'Francfort', code: 'FRA', terminal: 'T1' }, arr: { time: '18:40', name: 'Istanbul', code: 'IST' }, dur: '2h40', num: 'TK 1592', pnr: 'BKK901', seat: { place: '18C' }, carrier: 'Turkish Airlines', ticket: { available: true, hasQR: false, wallet: false }, voucherPdf: 'voucher-flight.pdf', fareName: 'Economy', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'] },
          { dep: { time: '20:45', name: 'Istanbul', code: 'IST' }, arr: { time: '03:00', name: 'Doha', code: 'DOH', dayOffset: 1 }, dur: '3h15', num: 'QR 246', pnr: 'BKK901', seat: { place: '25K' }, carrier: 'Qatar Airways', ticket: { available: true, hasQR: false, wallet: false }, voucherPdf: 'voucher-flight.pdf', fareName: 'Economy', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'] },
          { dep: { time: '05:10', name: 'Doha', code: 'DOH', date: 'Mar. 10 Fév' }, arr: { time: '14:30', name: 'Bangkok', code: 'BKK' }, dur: '6h20', num: 'QR 836', pnr: 'BKK901', seat: { place: '31F' }, carrier: 'Qatar Airways', ticket: { available: true, hasQR: false, wallet: false }, voucherPdf: 'voucher-flight.pdf', fareName: 'Economy', fareExch: false, fareRefund: false, amenities: ['meal', 'entertainment'] },
        ],
        connections: [
          { loc: 'Francfort FRA', dur: '1h35' },
          { loc: 'Istanbul IST', dur: '2h05' },
          { loc: 'Doha DOH', dur: '2h10' },
        ],
        luggage: '1 cabine + 1 soute 23 kg · Bagages jusqu\'à BKK',
        seat: { place: '34A' },
        ticket: { available: true, hasQR: false, wallet: false },
        pnr: 'BKK901',
        fareName: 'Economy Light', fareExch: false, fareRefund: false, amenities: ['meal'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'hotel', icon: '🏨',
        title: 'Mandarin Oriental Bangkok',
        shortLabel: 'Mandarin Oriental', dateShort: 'Mar 10 – Sam 14',
        checkin: { date: 'Mardi 10 Février', time: '14:00' },
        checkout: { date: 'Samedi 14 Février', time: '12:00' },
        nights: 4, starsText: '★★★★★',
        roomName: 'Authors Suite River View',
        inclusions: ['Petit-déjeuner inclus', 'Spa access'],
        cancellation: { type: 'free', freeUntil: '5 Février 2026' },
        freeTextConditions: 'Check-in dès 14h. Shuttle bateau gratuit depuis Saphan Taksin BTS. Contact : +66 2 659 9000',
        bookingRef: 'BKK-773820',
        address: '48 Oriental Avenue, Bangkok 10500',
        photos: [
          'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      },
      {
        type: 'flight', icon: '✈️',
        title: 'Bangkok BKK → Paris CDG',
        shortLabel: 'BKK → CDG', dateShort: 'Sam 14 · 23:45',
        departure: { time: '23:45', name: 'Bangkok', code: 'BKK', terminal: null, date: 'Sam. 14 Fév' },
        arrival: { time: '06:15', name: 'Paris', code: 'CDG', terminal: 'T1', date: 'Dim. 15 Fév', dayOffset: 1 },
        duration: '12h30', carrier: 'Thai Airways', details: ['Economy', 'Direct'],
        luggage: '1 cabine + 1 soute 23 kg',
        seat: null,
        ticket: { available: false, hasQR: false, wallet: false, availableDate: '12 Fév' },
        num: 'TG 930', pnr: 'BKK901',
        fareName: 'Economy Flex', fareExch: true, fareRefund: 'with_fee', amenities: ['meal', 'entertainment'],
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: false,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      }
    ]
  },
  simple: {
    destination: 'Bordeaux',
    travelers: ['Stella Smith'],
    etapes: [
      {
        type: 'train', icon: '🚄',
        title: 'Marne-la-Vallée Chessy TGV → Marseille Saint-Charles',
        shortLabel: 'MLV Chessy → Marseille St-Ch.', dateShort: 'Ven 09 · 12:30',
        departure: { time: '12:30', name: 'Marne-la-Vallée Chessy TGV', date: 'Ven. 09 Fév' },
        arrival: { time: '16:32', name: 'Marseille Saint-Charles', date: 'Ven. 09 Fév' },
        duration: '2h02', carrier: 'Ouigo', details: ['2nde classe', 'Direct'],
        seat: { wagon: '12', place: '45' },
        ticket: { available: true, hasQR: true, wallet: false },
        num: 'OUIGO 7641', pnr: 'HJKL42', platform: '3',
        fareName: 'Prem\'s', fareExch: false, fareRefund: false, amenities: ['wifi', 'power'],
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      },
      {
        type: 'train', icon: '🚄',
        title: 'Bordeaux Saint-Jean → Paris Montparnasse',
        shortLabel: 'Bordeaux → Paris', dateShort: 'Mer 18 · 14:00',
        departure: { time: '14:00', name: 'Bordeaux Saint-Jean', date: 'Mer. 18 Fév' },
        arrival: { time: '16:15', name: 'Paris Montparnasse', date: 'Mer. 18 Fév' },
        duration: '2h15', carrier: 'Ouigo', details: ['2nde classe', 'Direct'],
        seat: null,
        ticket: { available: false, hasQR: false, wallet: false, availableDate: '14 Fév' },
        num: 'OUIGO 7860', pnr: 'HJKL42',
        fareName: 'Prem\'s', fareExch: false, fareRefund: false, amenities: ['wifi', 'power'],
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: 'Itinéraire vers la gare', locIcon: '📍', locUrl: '#',
      }
    ]
  },
  flight: {
    destination: 'Bordeaux',
    travelers: [],
    etapes: [
      {
        type: 'flight', icon: '✈️',
        title: 'Paris CDG → Bordeaux Mérignac',
        shortLabel: 'CDG → BOD', dateShort: 'Ven 09 · 07:15',
        departure: { time: '07:15', name: 'Paris', code: 'CDG', terminal: 'T2F', date: 'Ven. 09 Fév' },
        arrival: { time: '08:30', name: 'Bordeaux', code: 'BOD', terminal: null, date: 'Ven. 09 Fév' },
        duration: '1h15', carrier: 'Air France', details: ['Economy', 'Direct'],
        luggage: '1 cabine + 1 soute 23 kg',
        seat: { place: '7C' },
        ticket: { available: true, hasQR: false, wallet: false },
        num: 'AF 7514', pnr: 'DEF789', gate: 'A12',
        fareName: 'Economy Standard', fareExch: 'with_fee', fareRefund: false, amenities: ['wifi'],
        voucherPdf: 'voucher-flight.pdf',
        docLabel: 'Voir mon billet', docIcon: '🎫', docAvailable: true,
        locLabel: "Itinéraire vers l'aéroport", locIcon: '📍', locUrl: '#',
      }
    ]
  },
  hotelonly: {
    destination: 'Bordeaux',
    travelers: ['Donnie Schmidt'],
    etapes: [
      {
        type: 'hotel', icon: '🏨',
        title: 'Intercontinental Bordeaux – Le Grand Hôtel',
        shortLabel: 'Grand Hôtel', dateShort: 'Lun 16 – Mer 18',
        checkin: { date: 'Lundi 16 Février', time: '15:00' },
        checkout: { date: 'Mercredi 18 Février', time: '12:00' },
        nights: 2, starsText: '★★★★★',
        roomName: 'Chambre Premium Vue Opéra',
        inclusions: [],
        cancellation: { type: 'non_refundable' },
        freeTextConditions: 'Accès par code d\'entrée (code fourni 24h avant). Check-in de 15h à 22h. Parking souterrain disponible (25\u20AC/nuit). Contact : +33 5 57 30 44 44',
        bookingRef: 'BDX-928471',
        address: '2-5 Place de la Comédie, 33000 Bordeaux',
        photos: [
          'https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=600&h=300&fit=crop',
          'https://images.unsplash.com/photo-1618773928121-c32242e63f39?w=300&h=300&fit=crop',
        ],
        docLabel: 'Voir mon voucher', docIcon: '📄', docAvailable: true, voucherPdf: 'voucher-hotel.pdf',
        locLabel: "Itinéraire vers l'hôtel", locIcon: '📍', locUrl: '#',
      }
    ]
  }
};

let currentState = 'upcoming';
let currentContext = 'home';
let autoResetTimer = null;
let currentColor = 'contrast';   // light | contrast | dark
let currentLayout = 'bold'; // classic | bold
let currentPlatform = 'desktop'; // desktop | ios | android
let currentTab = 'timeline';    // timeline | ticket
let selectedEtapes = {};       // per-card selected étape index
let sheetTargets = [];         // etape data refs for sheet onclick

// Timeline configurator state
const _tlState = {
  transport: true,    // has transport?
  direction: 'ar',    // 'ar' | 'as'
  mode: 'train',      // 'train' | 'vol'
  hotel: true,        // toggle
  car: false,         // toggle
  legs: 'direct',     // 'direct' | '1-stop' | 'multi'
};

const HEADLINES = {
  upcoming: t => `Voyage à ${t.destination} dans 2 jours`,
  imminent: () => `Départ dans 3h15`,
  in_transit: t => `En route vers ${t.destination}`,
  between_segments: t => `À ${t.destination}`,
  trip_ending: () => `Bon retour !`,
};

function getAutoIdx(state, trip) {
  const n = trip.etapes.length;
  switch (state) {
    case 'upcoming': case 'imminent': case 'in_transit': return 0;
    case 'between_segments': return Math.min(2, n - 1);
    case 'trip_ending': return n - 1;
    default: return 0;
  }
}
function getCompleted(state, trip) {
  const n = trip.etapes.length;
  if (state === 'between_segments') return [0, 1];
  if (state === 'trip_ending') return Array.from({length: n}, (_, i) => i);
  return [];
}
function getTag(idx, autoIdx, done, state) {
  if (state === 'in_transit' && idx === autoIdx) return { t: 'En cours', c: 'current' };
  if (state === 'trip_ending') return { t: 'Terminée ✓', c: 'done' };
  if (done.includes(idx)) return { t: 'Terminée ✓', c: 'past' };
  if (idx === autoIdx) return { t: state === 'imminent' ? 'Départ imminent' : 'Prochaine étape', c: 'next' };
  if (idx < autoIdx) return { t: 'Terminée ✓', c: 'past' };
  return { t: 'À venir', c: 'future' };
}

const STEPPER_ICONS = { train: 'train', flight: 'flight', hotel: 'hotel', car: 'directions_car' };
// Etape pool — references into existing TRIPS data
const POOL = {
  trainDirect:     TRIPS.full.etapes[0],
  trainRetour:     TRIPS.full.etapes[3],
  trainCorr:       TRIPS.correspondance.etapes[0],
  trainCorrRetour: TRIPS.correspondance.etapes[2],
  volDirect:       TRIPS.openjaw.etapes[0],
  volRetour:       TRIPS.openjaw.etapes[3],
  vol1escale:      TRIPS.escale.etapes[0],
  vol1escRetour:   TRIPS.escale.etapes[2],
  volMulti:        TRIPS.escale3.etapes[0],
  volMultiRetour:  TRIPS.escale3.etapes[2],
  hotel:           TRIPS.full.etapes[1],
  car:             TRIPS.full.etapes[2],
};

function buildComposedTrip(cfg) {
  let etapes = [], destination = 'Bordeaux';

  if (!cfg.transport) {
    // No transport: hotel and/or car only
    if (cfg.hotel) etapes.push(POOL.hotel);
    if (cfg.car) etapes.push(POOL.car);
    return { destination, travelers: ['Stella Smith'], etapes };
  }

  // Has transport
  const isVol = cfg.mode === 'vol';

  // Aller
  if (cfg.legs === 'direct') {
    etapes.push(isVol ? POOL.volDirect : POOL.trainDirect);
    destination = isVol ? 'Nice' : 'Aix-en-Provence';
  } else if (cfg.legs === '1-stop') {
    etapes.push(isVol ? POOL.vol1escale : POOL.trainCorr);
    destination = isVol ? 'Athènes' : 'Bordeaux';
  } else {
    etapes.push(POOL.volMulti);
    destination = 'Bangkok';
  }

  // Extras
  if (cfg.hotel) etapes.push(POOL.hotel);
  if (cfg.car) etapes.push(POOL.car);

  // Retour (A/R only)
  if (cfg.direction === 'ar') {
    if (cfg.legs === 'direct')      etapes.push(isVol ? POOL.volRetour : POOL.trainRetour);
    else if (cfg.legs === '1-stop') etapes.push(isVol ? POOL.vol1escRetour : POOL.trainCorrRetour);
    else                            etapes.push(POOL.volMultiRetour);
  }

  return { destination, travelers: ['Stella Smith'], etapes };
}

function tlSet(key, val) {
  _tlState[key] = val;
  // Resets
  if (key === 'transport' && !val) {
    // No transport: at least hotel or car
    if (!_tlState.hotel && !_tlState.car) _tlState.hotel = true;
  }
  if (key === 'direction' && val === 'as') {
    _tlState.hotel = false; // no hotel on one-way
  }
  if (key === 'mode' && val === 'train' && _tlState.legs === 'multi') {
    _tlState.legs = 'direct';
  }
  // When toggling hotel/car off in no-transport mode, ensure at least one stays
  if (!_tlState.transport && key === 'hotel' && !val && !_tlState.car) { _tlState.car = true; }
  if (!_tlState.transport && key === 'car' && !val && !_tlState.hotel) { _tlState.hotel = true; }
  selectedEtapes = {};
  renderPanel();
  renderAll();
}

function buildStepperHTML(trip, state, activeIdx, autoIdx, done, isDark, isBold, tripKey) {
  if (trip.etapes.length < 2) return '';
  let h = '';
  const useIcons = isBold; // Material Symbols icons = Bold layout feature
  const useDarkDots = isDark || isBold; // Dark dots = dark color OR bold layout
  trip.etapes.forEach((e, i) => {
    let cls = 'stepper-step';
    if (done.includes(i)) cls += ' completed';
    if (i === activeIdx) {
      cls += ' active';
      if (done.includes(i)) cls += ' viewing';
      if (state === 'in_transit' && i === autoIdx) cls += ' transit';
    }
    let dotContent;
    if (done.includes(i)) {
      dotContent = useIcons ? '<span class="material-symbols-rounded">check</span>' : '<span class="stepper-check">✓</span>';
    } else {
      dotContent = useIcons ? `<span class="material-symbols-rounded">${STEPPER_ICONS[e.type] || 'trip'}</span>` : e.icon;
    }
    let statusHint = '';
    if (i === activeIdx && i === autoIdx) {
      if (state === 'in_transit') statusHint = '<div class="stepper-status">En cours</div>';
      else if (state === 'imminent') statusHint = '<div class="stepper-status">Imminent</div>';
      else if (state === 'trip_ending' && done.includes(i)) statusHint = '<div class="stepper-status">Terminé</div>';
    }
    h += `<div class="${cls}" onclick="selectEtape('${tripKey}',${i})" style="cursor:pointer"><div class="stepper-dot-row"><div class="stepper-dot">${dotContent}</div><div class="stepper-line"></div></div><div class="stepper-label">${e.shortLabel}</div><div class="stepper-date">${e.dateShort}</div>${statusHint}</div>`;
  });
  const stepperCls = 'stepper' + (useDarkDots ? ' stepper-dark' : '') + (isBold ? ' stepper-bold' : '');
  return `<div class="${stepperCls}">${h}</div>`;
}

function renderAll() {
  sheetTargets = [];
  const state = currentState;
  const isContrast = currentColor === 'contrast';
  const isDark = isContrast;
  const isBold = currentLayout === 'bold';
  const isEpure = isBold;
  const container = document.getElementById('cards-container');
  container.innerHTML = '';

  const isMobileCarousel = isBold && window.innerWidth <= 640;

  // Build trip from configurator
  const trip = buildComposedTrip(_tlState);
  const key = 'composed';
  {
    const autoIdx = getAutoIdx(state, trip);
    const done = getCompleted(state, trip);
    const selIdx = selectedEtapes[key] != null ? selectedEtapes[key] : autoIdx;
    const etape = trip.etapes[selIdx];
    const isPast = done.includes(selIdx) && state !== 'trip_ending';

    const headline = HEADLINES[state](trip);
    const travelers = trip.travelers.length ? `<div class="co-travelers">avec ${trip.travelers.join(' et ')}</div>` : '';
    const stepperH = buildStepperHTML(trip, state, selIdx, autoIdx, done, isDark, isBold, key);

    const colorCls = isContrast ? ' contrast-mode' : '';
    const cardHTML = `<div id="scenario-${key}"><div class="trip-card state-${state}${colorCls}"><div class="card-inner"><div class="card-header"><div class="header-left"><div class="headline-row"><div class="state-dot"></div><div class="headline">${headline}</div></div>${travelers}</div><a href="#" class="header-link" onclick="event.preventDefault()">Voir le voyage →</a></div>${stepperH}<div id="etape-${key}"></div></div></div></div>`;
    container.insertAdjacentHTML('beforeend', cardHTML);

    if (isMobileCarousel && trip.etapes.length > 1) {
      // === Mobile bold: native scroll-snap carousel with ALL etapes ===
      let carouselH = '<div class="etape-carousel" data-trip="' + key + '">';
      trip.etapes.forEach((_, i) => {
        carouselH += '<div class="etape-slide" data-idx="' + i + '" id="slide-' + key + '-' + i + '"></div>';
      });
      carouselH += '</div>';
      document.getElementById('etape-' + key).innerHTML = carouselH;
      // Render each etape into its slide
      trip.etapes.forEach((et, i) => {
        if (et && trip.travelers && trip.travelers.length) et._travelerName = trip.travelers[0];
        const isPastI = done.includes(i) && state !== 'trip_ending';
        renderEtape(et, state, i, autoIdx, done, trip.etapes.length, isPastI, 'slide-' + key + '-' + i);
      });
      // Scroll to active slide (instant, no animation on initial render)
      requestAnimationFrame(() => {
        const slide = document.getElementById('slide-' + key + '-' + selIdx);
        if (slide) slide.scrollIntoView({ behavior: 'instant', inline: 'start', block: 'nearest' });
      });
      // On scroll snap: update stepper active step
      const carousel = document.querySelector('#etape-' + key + ' .etape-carousel');
      if (carousel) {
        let scrollTimer;
        carousel.addEventListener('scroll', () => {
          clearTimeout(scrollTimer);
          scrollTimer = setTimeout(() => {
            const cRect = carousel.getBoundingClientRect();
            const center = cRect.left + cRect.width / 2;
            let bestIdx = 0, minDist = Infinity;
            carousel.querySelectorAll('.etape-slide').forEach((s, i) => {
              const r = s.getBoundingClientRect();
              const dist = Math.abs((r.left + r.width / 2) - center);
              if (dist < minDist) { minDist = dist; bestIdx = i; }
            });
            selectedEtapes[key] = bestIdx;
            // Update stepper visually without re-render
            const stepper = document.querySelector('#scenario-' + key + ' .stepper-bold');
            if (stepper) {
              stepper.querySelectorAll('.stepper-step').forEach((step, i) => {
                const wasActive = step.classList.contains('active');
                step.classList.toggle('active', i === bestIdx);
                if (i === bestIdx && !wasActive) step.classList.add('viewing');
              });
            }
          }, 80);
        }, { passive: true });
      }
    } else {
      // === Desktop bold or classic: single etape ===
      if (trip.travelers && trip.travelers.length) etape._travelerName = trip.travelers[0];
      renderEtape(etape, state, selIdx, autoIdx, done, trip.etapes.length, isPast, 'etape-' + key);

      // Bold desktop: prev/next navigation
      if (isBold && trip.etapes.length > 1) {
        const total = trip.etapes.length;
        const prevDis = selIdx <= 0 ? ' disabled' : '';
        const nextDis = selIdx >= total - 1 ? ' disabled' : '';
        const navH = '<div class="bold-nav"><button class="bold-nav-btn"' + prevDis + ' onclick="selectEtape(\'' + key + '\',' + (selIdx - 1) + ')"><span class="material-symbols-rounded">chevron_left</span></button><button class="bold-nav-btn"' + nextDis + ' onclick="selectEtape(\'' + key + '\',' + (selIdx + 1) + ')"><span class="material-symbols-rounded">chevron_right</span></button></div>';
        // Insert nav into the header row (top-right, no overlap with content)
        const headEl = document.querySelector('#etape-' + key + ' .bpb-head');
        if (headEl) headEl.insertAdjacentHTML('beforeend', navH);
        else document.getElementById('etape-' + key).insertAdjacentHTML('beforeend', navH);
      }
    }
  }
}

// Calendar date icon (éphéméride) — parses "Ven. 09 Fév" or "Vendredi 9 Février"
function dateIcon(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.trim().split(/\s+/);
  let day, monthRaw;
  if (parts.length >= 3) { day = parts[parts.length - 2]; monthRaw = parts[parts.length - 1]; }
  else if (parts.length === 2) { day = parts[0]; monthRaw = parts[1]; }
  else return '';
  const dayNum = parseInt(day, 10);
  const mMap = { 'Janvier':'JAN','Février':'FÉV','Mars':'MAR','Avril':'AVR','Mai':'MAI','Juin':'JUN','Juillet':'JUL','Août':'AOÛ','Septembre':'SEP','Octobre':'OCT','Novembre':'NOV','Décembre':'DÉC','Jan':'JAN','Fév':'FÉV','Mar':'MAR','Avr':'AVR','Sep':'SEP','Oct':'OCT','Nov':'NOV','Déc':'DÉC' };
  const month = mMap[monthRaw] || monthRaw.substring(0, 3).toUpperCase();
  return `<div class="date-icon"><div class="date-icon-day">${dayNum}</div><div class="date-icon-month">${month}</div></div>`;
}

// Parse "Vendredi 9 Février" → { dow: "Vendredi", rest: "9 Février" }
function parseFullDate(dateStr) {
  if (!dateStr) return { dow: '', rest: dateStr || '' };
  const parts = dateStr.trim().split(/\s+/);
  if (parts.length >= 3) return { dow: parts[0], rest: parts.slice(1).join(' ') };
  return { dow: '', rest: dateStr };
}

function renderEtape(e, state, idx, autoIdx, done, total, isPast, targetId) {
  const ct = document.getElementById(targetId || 'etape-content');
  const isHero = state === 'imminent' && idx === autoIdx && !isPast;
  const isTransit = state === 'in_transit' && idx === autoIdx && !isPast;
  const tag = getTag(idx, autoIdx, done, state);
  const hasSeg = e.segments && e.segments.length > 1;
  const isFlight = e.type === 'flight';

  // Sheet target index for hotel/car ticket tags
  const ctaIdx = sheetTargets.length;
  sheetTargets.push(e);

  let bodyH = '';

  // Material Symbols icon mapping for mid badge (shared by transport + car bold)
  const ICON_MAP = { train: 'train', flight: 'flight', car: 'directions_car', hotel: 'hotel' };
  function midBadge(type, label) { return `<span class="material-symbols-rounded">${ICON_MAP[type] || 'trip'}</span>${label ? '<span class="mid-label">' + label + '</span>' : ''}`; }

  // ===== TRANSPORT — BOARDING PASS =====
  if (e.type === 'train' || e.type === 'flight') {
    const detailsStr = e.details.filter(d => d !== 'Direct').join(' · ');

    // Helper: build unified info tags with logical grouping
    // Train: [num → voie → voiture/place] | [tarif → réf]
    // Flight: [vol → porte → siège] | [réf → tarif → bagages]
    function infoTags(seat, data, extras, type, slim, ticket, etapeData) {
      const g1 = []; // transport identity (voie/porte + siège only)

      // Seat tag — accent (blue) to stand out
      function seatTag() {
        if (!seat) return null;
        if (seat.wagon) return `<div class="bp-tag accent"><div><div class="bp-tag-label">Voiture</div><div class="bp-tag-value">${seat.wagon}</div></div><div><div class="bp-tag-label">Place</div><div class="bp-tag-value">${seat.place}</div></div></div>`;
        return `<div class="bp-tag accent"><div><div class="bp-tag-label">Siège</div><div class="bp-tag-value">${seat.place}</div></div></div>`;
      }

      if (type === 'flight') {
        // Porte → Siège (slim: same)
        if (data && data.gate) g1.push(`<div class="bp-tag warm"><div><div class="bp-tag-label">Porte</div><div class="bp-tag-value">${data.gate}</div></div></div>`);
        const st = seatTag(); if (st) g1.push(st);
      } else {
        // Voie → Voiture/Place (slim: same)
        if (data && data.platform) g1.push(`<div class="bp-tag warm"><div><div class="bp-tag-label">Voie</div><div class="bp-tag-value">${data.platform}</div></div></div>`);
        const st = seatTag(); if (st) g1.push(st);
      }

      // Ticket action badge (classic mode only, not slim/bold)
      let ticketTag = '';
      if (!slim && ticket && etapeData) {
        const tIdx = sheetTargets.length;
        sheetTargets.push(etapeData);
        const sheetCall = `event.stopPropagation();openSheet(sheetTargets[${tIdx}])`;
        if (ticket.available) {
          const tIcon = ticket.hasQR ? qrSvg : '<span class="material-symbols-rounded">confirmation_number</span>';
          ticketTag = `<button class="bp-ticket-tag" onclick="${sheetCall}">${tIcon} Voir mon billet</button>`;
        } else {
          ticketTag = `<button class="bp-ticket-tag deferred" onclick="${sheetCall}"><span class="material-symbols-rounded">event</span> Dispo le ${ticket.availableDate || '—'}</button>`;
        }
      }

      if (!g1.length && !ticketTag) return '';
      let h = '';
      if (g1.length) h += `<div class="bp-tag-group">${g1.join('')}</div>`;
      h += ticketTag;
      return `<div class="bp-tags">${h}</div>`;
    }

    // Helper: build location HTML for a stop
    function locH(stop) {
      if (stop.code) {
        let h = `<div class="bp-loc">${stop.code}</div>`;
        if (stop.terminal) h += `<div class="bp-sub">Terminal ${stop.terminal}</div>`;
        if (stop.name) h += `<div class="bp-sub">${stop.name}</div>`;
        return h;
      }
      return `<div class="bp-loc">${stop.name}</div>`;
    }

    // SVG for QR code icon (inherits color via currentColor)
    const qrSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v3h-3v2h3v3h2v-3h3v-2h-3v-3zm0 5v3h2v-3h-2zm-5 3h2v-5h-2v5z"/></svg>`;

    // Helper: build actions row (ticket + itinerary) for a boarding pass
    function ticketDoc(ticket, locUrl, etapeData) {
      // Bold mode: no inline CTAs — card is tappable
      if (currentLayout === 'bold') return '';
      const tIdx = sheetTargets.length;
      if (etapeData) sheetTargets.push(etapeData);
      let h = '<div class="bp-doc">';
      h += `<a href="${locUrl || '#'}" class="bp-doc-loc" onclick="event.preventDefault()">📍 Itinéraire</a>`;
      if (ticket) {
        const sheetCall = etapeData ? `event.preventDefault();openSheet(sheetTargets[${tIdx}])` : 'event.preventDefault()';
        if (ticket.available) {
          const icon = ticket.hasQR ? qrSvg : '🎫';
          h += `<button class="bp-doc-btn available" onclick="${sheetCall}">${icon} Voir mon billet</button>`;
        } else {
          h += `<button class="bp-doc-btn deferred" onclick="${sheetCall}">📅 Dispo le ${ticket.availableDate || '—'}</button>`;
        }
        if (ticket.available && ticket.wallet) {
          h += `<button class="bp-doc-wallet" onclick="${sheetCall}"> Wallet</button>`;
        }
      }
      h += '</div>';
      return h;
    }

    // Helper: build one boarding pass card
    function bpCard(headerLeft, headerRight, dep, arr, midLabel, seat, extras, ticket, locUrl, fareData, type, etapeData) {
      let h = '';
      h += `<div class="bp-head"><div class="bp-carrier">${headerLeft}</div><span class="bp-date">${headerRight}</span></div>`;
      h += '<div class="bp-tear"></div>';
      const arrOffset = arr.dayOffset ? `<span class="day-offset">+${arr.dayOffset}</span>` : '';
      const depDate = dep.date && arr.dayOffset ? `<div class="bp-sub">${dep.date}</div>` : '';
      const arrDate = arr.date && arr.dayOffset ? `<div class="bp-sub">${arr.date}</div>` : '';
      h += `<div class="bp-route"><div class="bp-point"><div class="bp-time">${dep.time}</div>${depDate}${locH(dep)}</div><div class="bp-mid"><div class="bp-arrow-line"></div><div class="bp-dur">${midLabel}</div></div><div class="bp-point arr"><div class="bp-time">${arr.time}${arrOffset}</div>${arrDate}${locH(arr)}</div></div>`;
      h += infoTags(seat, fareData, extras, type, false, ticket, etapeData);
      return `<div class="bp">${h}</div>`;
    }

    // Helper: build one bold-style boarding pass card (iOS widget inspired)
    // extraCls: 'bpb-navy' for dark variant; pnr: shown in header right
    function bpCardBold(carrier, num, pnr, dateStr, dep, arr, midLabel, seat, ticket, locUrl, fareData, type, icon, extraCls, etapeData) {
      const isFl = type === 'flight';
      let h = '';
      // Header: date + carrier | PNR (no fare name — only cabin class matters)
      const headRight = (num || pnr) ? `<div class="bpb-head-right">${num ? '<span class="bpb-num">' + num + '</span>' : ''}${pnr ? '<span class="bpb-ref">Réf. ' + pnr + '</span>' : ''}</div>` : '';
      h += `<div class="bpb-head"><div class="bpb-carrier"><span class="bpb-date">${dateStr}</span><span class="bp-carrier-icon">${icon}</span>${carrier}</div>${headRight}</div>`;
      // Route: big codes (flights) or big times (trains)
      h += '<div class="bpb-route">';
      if (isFl && dep.code) {
        h += `<div class="bpb-hero"><div class="bpb-code">${dep.code}</div><div class="bpb-time">${dep.time}</div><div class="bpb-name">${dep.name}${dep.terminal ? ' · T' + dep.terminal : ''}</div></div>`;
      } else {
        h += `<div class="bpb-hero"><div class="bpb-code">${dep.time}</div><div class="bpb-name">${dep.name}</div></div>`;
      }
      const midPillLabel = midLabel;
      // Build action pill for mid zone (with direct onclick for desktop)
      const pillIdx = etapeData ? sheetTargets.length : -1;
      if (etapeData) sheetTargets.push(etapeData);
      let actionPill = '';
      if (ticket) {
        const pillClick = pillIdx >= 0 ? ` onclick="event.stopPropagation();openSheet(sheetTargets[${pillIdx}])"` : '';
        if (ticket.available) {
          const tIcon = ticket.hasQR ? qrSvg : '<span class="material-symbols-rounded">confirmation_number</span>';
          actionPill = `<div class="bpb-action-pill"${pillClick}>${tIcon} Voir mon billet</div>`;
        } else {
          actionPill = `<div class="bpb-action-pill deferred"${pillClick}><span class="material-symbols-rounded">event</span> Billet dispo. le ${ticket.availableDate || '—'}</div>`;
        }
      }
      h += `<div class="bpb-mid"><div class="bpb-mid-row"><div class="bpb-mid-line"></div><div class="bpb-mid-badge">${midBadge(type, midPillLabel)}</div><div class="bpb-mid-line"></div></div>${actionPill}</div>`;
      const boldArrOffset = arr.dayOffset ? `<span class="day-offset">+${arr.dayOffset}</span>` : '';
      if (isFl && arr.code) {
        h += `<div class="bpb-hero arr"><div class="bpb-code">${arr.code}${boldArrOffset}</div><div class="bpb-time">${arr.time}${arr.date && arr.dayOffset ? ' · ' + arr.date : ''}</div><div class="bpb-name">${arr.name}${arr.terminal ? ' · T' + arr.terminal : ''}</div></div>`;
      } else {
        h += `<div class="bpb-hero arr"><div class="bpb-code">${arr.time}${boldArrOffset}</div>${arr.date && arr.dayOffset ? '<div class="bpb-time">' + arr.date + '</div>' : ''}<div class="bpb-name">${arr.name}</div></div>`;
      }
      h += '</div>';
      // Slim tags: only porte/siège (flight) or voie/voiture (train)
      // Always render tags row (even empty) so nav chevrons have a line to sit on
      const tags = infoTags(seat, fareData, null, type, true);
      h += tags || '<div class="bp-tags"></div>';
      // Card: tappable on mobile, pill handles desktop click
      const tapAttr = etapeData ? ` tappable" onclick="if(window.innerWidth<641)openSheet(sheetTargets[${pillIdx}])"` : '"';
      return `<div class="bpb${extraCls ? ' ' + extraCls : ''}${tapAttr}>${h}</div>`;
    }

    // Leg-level card for multi-segment etapes (bold mode only)
    // Stacks segment routes (same visual as direct cards) with connection bars between
    function bpCardLeg(etape, extraCls) {
      const isFl = etape.type === 'flight';
      const firstSeg = etape.segments[0];
      let h = '';
      // Minimal header — just date + PNR (carrier moves to per-segment mid zone)
      const pnr = firstSeg.pnr || etape.pnr || '';
      const headRight = pnr ? `<div class="bpb-head-right"><span class="bpb-ref">Réf. ${pnr}</span></div>` : '';
      h += `<div class="bpb-head"><div class="bpb-carrier"><span class="bpb-date">${etape.departure.date}</span></div>${headRight}</div>`;
      // Stacked segment routes — same visual as direct cards, carrier+seat in mid
      const headerDate = etape.departure.date;
      let prevDate = headerDate;
      etape.segments.forEach((seg, si) => {
        const dep = seg.dep;
        const arr = seg.arr;
        const arrOff = arr.dayOffset ? `<span class="day-offset">+${arr.dayOffset}</span>` : '';
        const carrier = seg.carrier || etape.carrier;
        const segNum = seg.num || '';
        // Date label when it changes
        const segDate = dep.date || null;
        if (si > 0 && segDate && segDate !== prevDate) {
          h += `<div class="leg-seg-date">${segDate}</div>`;
        }
        if (segDate) prevDate = segDate;
        // Mid content: carrier name + flight num (no 2-letter code) + duration, all in one line
        const numOnly = segNum.replace(/^[A-Z]{2,3}\s*/, '');
        const midLabel = [carrier + (numOnly ? ' ' + numOnly : ''), seg.dur].filter(Boolean).join(' · ');
        // Seat/gate as compact text in mid zone
        // Seat info (mid zone) — relative to the segment
        const segSeat = seg.seat || null;
        let midSeatLine = '';
        if (isFl) {
          if (segSeat && segSeat.place) midSeatLine = `<div class="leg-mid-seat">Siège ${segSeat.place}</div>`;
        } else {
          if (segSeat && segSeat.wagon) midSeatLine = `<div class="leg-mid-seat">Voit. ${segSeat.wagon} Place ${segSeat.place}</div>`;
          else if (segSeat && segSeat.place) midSeatLine = `<div class="leg-mid-seat">Place ${segSeat.place}</div>`;
        }
        // Dep name with gate/voie (relative to departure station)
        let depName = dep.name;
        if (isFl) {
          if (dep.terminal) depName += ' · T' + dep.terminal;
          if (seg.gate) depName += ' · Porte ' + seg.gate;
        } else {
          if (seg.platform) depName += ' · Voie ' + seg.platform;
        }
        // Route row
        const routeCls = si === 0 ? ' leg-route-first' : '';
        h += `<div class="bpb-route${routeCls}">`;
        if (isFl && dep.code) {
          h += `<div class="bpb-hero"><div class="bpb-code">${dep.code}</div><div class="bpb-time">${dep.time}</div><div class="bpb-name">${depName}</div></div>`;
        } else {
          h += `<div class="bpb-hero"><div class="bpb-code">${dep.time}</div><div class="bpb-name">${depName}</div></div>`;
        }
        h += `<div class="bpb-mid"><div class="bpb-mid-row"><div class="bpb-mid-line"></div><div class="bpb-mid-badge">${midBadge(etape.type, midLabel)}</div><div class="bpb-mid-line"></div></div>${midSeatLine}</div>`;
        if (isFl && arr.code) {
          h += `<div class="bpb-hero arr"><div class="bpb-code">${arr.code}${arrOff}</div><div class="bpb-time">${arr.time}</div><div class="bpb-name">${arr.name}${arr.terminal ? ' · T' + arr.terminal : ''}</div></div>`;
        } else {
          h += `<div class="bpb-hero arr"><div class="bpb-code">${arr.time}${arrOff}</div><div class="bpb-name">${arr.name}</div></div>`;
        }
        h += '</div>';
        // Connection bar between segments
        if (si < etape.segments.length - 1 && etape.connections && etape.connections[si]) {
          const conn = etape.connections[si];
          h += `<div class="leg-conn-bar"><span class="leg-conn-chip"><span class="material-symbols-rounded" style="font-size:12px">schedule</span> ${conn.dur} · ${conn.loc}</span></div>`;
        }
      });
      // Action pill — floating on bottom edge, clickable to open sheet
      const tIdx = sheetTargets.length;
      sheetTargets.push(etape);
      const legTicket = firstSeg.ticket || etape.ticket;
      if (legTicket) {
        if (legTicket.available) {
          const tIcon = legTicket.hasQR ? qrSvg : '<span class="material-symbols-rounded">confirmation_number</span>';
          h += `<div class="leg-action-center"><div class="bpb-action-pill" onclick="event.stopPropagation();openSheet(sheetTargets[${tIdx}])">${tIcon} Voir mon billet</div></div>`;
        } else {
          h += `<div class="leg-action-center"><div class="bpb-action-pill deferred" onclick="event.stopPropagation();openSheet(sheetTargets[${tIdx}])"><span class="material-symbols-rounded">event</span> Billet dispo. le ${legTicket.availableDate || '—'}</div></div>`;
        }
      }
      const legTap = tIdx >= 0 ? ` tappable" onclick="if(window.innerWidth<641)openSheet(sheetTargets[${tIdx}])"` : '"';
      return `<div class="bpb bpb-leg${extraCls ? ' ' + extraCls : ''}${legTap}>${h}</div>`;
    }

    let allH = '';

    // Style flags
    const isBold = currentLayout === 'bold';
    const isEpure = isBold;
    const navyCls = '';

    // Transit bar
    if (isTransit) {
      const transitCls = isEpure ? 'bp-transit bold-transit' : 'bp-transit';
      allH += `<div class="${transitCls}">⏱ En route · Arrivée prévue à <strong>${e.arrival.time}</strong> · ${e.arrival.name}${e.arrival.code ? ' ' + e.arrival.code : ''}</div>`;
    }

    if (hasSeg) {
      if (isEpure) {
        // ── Bold: single LEG card with stop indicators ──
        allH += bpCardLeg(e, navyCls);
      } else {
        // ── Classic: multi-card per segment ──
        let scrollH = '';
        e.segments.forEach((seg, si) => {
          const isLast = si === e.segments.length - 1;
          const segData = seg.fareName ? seg : e;
          const segRef = seg.pnr || e.pnr || '';
          const headerSub = [seg.num, segRef ? 'Réf. ' + segRef : ''].filter(Boolean).join(' · ');
          const headerLeft = `<span class="bp-carrier-icon">${e.icon}</span>${e.carrier}<span class="bp-carrier-sub">· ${headerSub}</span>`;
          scrollH += bpCard(headerLeft, e.departure.date, seg.dep, seg.arr, seg.dur, seg.seat, null, seg.ticket || e.ticket, e.locUrl, segData, e.type, e);
          if (!isLast && e.connections && e.connections[si]) {
            const conn = e.connections[si];
            scrollH += `<div class="bp-conn-between"><div class="bp-conn-chip">⏱ ${conn.dur}</div><div class="bp-conn-where">${conn.loc}</div></div>`;
          }
        });
        const wrapCls = e.segments.length <= 2 ? 'bp-pair' : 'bp-scroll';
        allH += `<div class="${wrapCls}">${scrollH}</div>`;
        if (isFlight && e.luggage) {
          allH += `<div class="bp-luggage">🧳 ${e.luggage}</div>`;
        }
      }
    } else {
      // ── Direct: single boarding pass ──
      if (isEpure) {
        allH += bpCardBold(e.carrier, e.num, e.pnr, e.departure.date, e.departure, e.arrival, e.duration, e.seat, e.ticket, e.locUrl, e, e.type, e.icon, navyCls, e);
      } else {
        const directSub = [detailsStr, e.pnr ? 'Réf. ' + e.pnr : ''].filter(Boolean).join(' · ');
        const headerLeft = `<span class="bp-carrier-icon">${e.icon}</span>${e.carrier}<span class="bp-carrier-sub">· ${directSub}</span>`;
        allH += bpCard(headerLeft, e.departure.date, e.departure, e.arrival, e.duration, e.seat, null, e.ticket, e.locUrl, e, e.type, e);
      }
    }

    bodyH = allH;
  }

  // ===== HOTEL CARD =====
  else if (e.type === 'hotel') {
    const isDark = currentColor === 'contrast';
    const isBold = currentLayout === 'bold';
    const isEpure = isBold;
    const stars = e.starsText || '';

    if (isEpure) {
      // ── Épuré hotel: dark card with essentials only ──
      const navyCls = isDark ? ' bpb-navy' : '';
      let h = '';
      // Header: name + ref top-right
      const phoneStr = '';
      h += `<div class="bpb-head"><div class="bpb-carrier"><div class="htd-title">${e.title}${stars ? ' <span class="stars">' + stars + '</span>' : ''}</div></div>${e.bookingRef ? '<div class="bpb-head-right"><span class="bpb-ref">Réf. ' + e.bookingRef + '</span></div>' : ''}</div>`;
      h += `<div class="htd-sub-row"><div class="htd-sub">📍 ${e.address}${phoneStr}</div></div>`;
      // Dates: vertical layout — time big, day-of-week prominent, date medium
      const nightsLabel = e.nights + ' nuit' + (e.nights > 1 ? 's' : '');
      const cin = parseFullDate(e.checkin.date);
      const cout = parseFullDate(e.checkout.date);
      h += '<div class="htd-dates-bold">';
      h += `<div class="htd-block"><div class="htd-block-event">Check-in</div><div class="htd-block-dow">${cin.dow} ${cin.rest}</div><div class="htd-block-time">dès ${e.checkin.time}</div></div>`;
      const htIdx = sheetTargets.length;
      sheetTargets.push(e);
      const htVoucherPill = e.docAvailable ? `<div class="bpb-action-pill" onclick="event.stopPropagation();openSheet(sheetTargets[${htIdx}])"><span class="material-symbols-rounded">description</span> Voir mon voucher</div>` : '';
      h += `<div class="htd-nights-sep"><div class="htd-nights-sep-line"></div><div class="bpb-mid-badge">${midBadge('hotel', nightsLabel)}</div><div class="htd-nights-sep-line"></div>${htVoucherPill}</div>`;
      h += `<div class="htd-block arr"><div class="htd-block-event">Check-out</div><div class="htd-block-dow">${cout.dow} ${cout.rest}</div><div class="htd-block-time">avant ${e.checkout.time}</div></div>`;
      h += '</div>';
      // Free-text arrival conditions (unstructured, from supplier)
      if (e.freeTextConditions) {
        h += `<div class="htd-logistics"><div class="htd-log-item">${e.freeTextConditions}</div></div>`;
      }
      bodyH = `<div class="bpb tappable${navyCls}" onclick="if(window.innerWidth<641)openSheet(sheetTargets[${htIdx}])">${h}</div>`;
    } else {
      // ── Classic hotel card ──
      let galleryH = '';
      if (e.photos && e.photos.length) {
        galleryH = '<div class="ht-gallery">' + e.photos.map(p => `<img src="${p}" alt="" loading="lazy">`).join('') + '</div>';
      }
      let infoH = `<div class="ht-body"><div class="ht-name">${e.title}${stars ? ' <span class="stars">' + stars + '</span>' : ''}</div><div class="ht-sub">📍 ${e.address}${e.roomName ? ' · 🛏 ' + e.roomName : ''}</div>`;
      const badges = [];
      if (e.inclusions) {
        e.inclusions.forEach(inc => {
          if (inc.toLowerCase().includes('petit-déjeuner') || inc.toLowerCase().includes('breakfast')) {
            badges.push(`<span class="ht-badge breakfast">☀️ ${inc}</span>`);
          } else {
            badges.push(`<span class="ht-badge wifi">✓ ${inc}</span>`);
          }
        });
      }
      if (e.cancellation) {
        if (e.cancellation.type === 'free') badges.push(`<span class="ht-badge cancel-free">✅ Annulable jusqu'au ${e.cancellation.freeUntil}</span>`);
        else if (e.cancellation.type === 'restricted') badges.push(`<span class="ht-badge cancel-restricted">⚠️ Annulable jusqu'au ${e.cancellation.freeUntil}</span>`);
        else if (e.cancellation.type === 'non_refundable') badges.push(`<span class="ht-badge cancel-none">✕ Non remboursable</span>`);
      }
      if (badges.length) infoH += '<div class="ht-badges">' + badges.join('') + '</div>';
      infoH += '</div>';
      // Schedule: same layout as car card, voucher button inline
      const htTagBtn = e.docAvailable
        ? `<button class="bp-ticket-tag" onclick="event.stopPropagation();openSheet(sheetTargets[${ctaIdx}])"><span class="material-symbols-rounded">description</span> Voir mon voucher</button>`
        : '';
      let schedH = `<div class="car-schedule"><div class="car-sched-block"><div class="car-sched-label">Check-in</div><div class="car-sched-time">${e.checkin.time}</div><div class="car-sched-date">${e.checkin.date}</div></div><div class="car-sched-block"><div class="car-sched-label">Check-out · ${e.nights} nuit${e.nights > 1 ? 's' : ''}</div><div class="car-sched-time">${e.checkout.time}</div><div class="car-sched-date">${e.checkout.date}</div></div>${htTagBtn}</div>`;
      let logH = '';
      if (e.freeTextConditions) {
        logH = `<div class="ht-logistics"><div class="ht-logistics-title">Conditions d'arrivée</div><div class="ht-logistics-item">${e.freeTextConditions}</div></div>`;
      }
      bodyH = `<div class="ecard">${galleryH}${infoH}${schedH}${logH}</div>`;
    }
  }

  // ===== CAR CARD =====
  else if (e.type === 'car') {
    const isDark = currentColor === 'contrast';
    const isBold = currentLayout === 'bold';
    const isEpure = isBold;
    const oj = e.pickup.location !== e.dropoff.location;

    if (isEpure) {
      // ── Épuré car: panoramic dark card like transport ──
      const navyCls = isDark ? ' bpb-navy' : '';
      const carDetails = e.details.filter(d => d !== 'Direct').join(' · ');
      const carDuration = e.details.find(d => /jour|day/i.test(d)) || '';
      const carIdx = sheetTargets.length;
      sheetTargets.push(e);
      const carVoucherPill = e.docAvailable ? `<div class="bpb-action-pill" onclick="event.stopPropagation();openSheet(sheetTargets[${carIdx}])"><span class="material-symbols-rounded">description</span> Voir mon voucher</div>` : '';
      let h = '';
      h += `<div class="bpb-head"><div class="bpb-carrier"><span class="bpb-date">${e.pickup.date}</span><span class="bp-carrier-icon">🚗</span>${e.title}</div>${e.bookingRef ? '<div class="bpb-head-right"><span class="bpb-ref">Réf. ' + e.bookingRef + '</span></div>' : ''}</div>`;
      // Route: pickup → dropoff (times as hero, like trains) — voucher pill in mid zone
      h += '<div class="bpb-route">';
      h += `<div class="bpb-hero"><div class="bpb-code">${e.pickup.time}</div><div class="bpb-time">${e.pickup.date}</div><div class="bpb-name">${e.pickup.location}</div></div>`;
      h += `<div class="bpb-mid"><div class="bpb-mid-row"><div class="bpb-mid-line"></div><div class="bpb-mid-badge">${midBadge('car', carDetails)}</div><div class="bpb-mid-line"></div></div>${carVoucherPill}</div>`;
      h += `<div class="bpb-hero arr"><div class="bpb-code">${e.dropoff.time}</div><div class="bpb-time">${e.dropoff.date}</div><div class="bpb-name">${e.dropoff.location}</div></div>`;
      h += '</div>';
      if (oj) h += `<div class="bpb-dur"><span class="material-symbols-rounded">warning</span> Restitution dans une agence différente (open jaw)</div>`;
      if (e.driverName) {
        h += `<div class="bpb-driver"><div class="bpb-driver-item">🪪 Permis + CB au nom du conducteur : <strong>${e.driverName}</strong></div></div>`;
      }
      bodyH = `<div class="bpb tappable${navyCls}" onclick="if(window.innerWidth<641)openSheet(sheetTargets[${carIdx}])">${h}</div>`;
    } else {
      // ── Classic car card ──
      const detailsStr = e.details.map(d => `<span>${d}</span>`).join('<span class="sep">·</span>');
      const photoH = e.carPhoto ? `<div class="car-photo"><img src="${e.carPhoto}" alt="" loading="lazy"></div>` : '';
      let topH = `<div class="car-top">${photoH}<div class="car-header"><div class="car-title">${e.title}</div><div class="car-details">${detailsStr}${e.bookingRef ? '<span class="sep">·</span><span>Réf. ' + e.bookingRef + '</span>' : ''}</div></div></div>`;
      const carTagBtn = e.docAvailable
        ? `<button class="bp-ticket-tag" onclick="event.stopPropagation();openSheet(sheetTargets[${ctaIdx}])"><span class="material-symbols-rounded">description</span> Voir mon voucher</button>`
        : '';
      let schedH = `<div class="car-schedule"><div class="car-sched-block"><div class="car-sched-label">Prise en charge</div><div class="car-sched-time">${e.pickup.time}</div><div class="car-sched-date">${e.pickup.date}</div><div class="car-sched-loc">${e.pickup.location}</div></div><div class="car-sched-block${oj ? ' oj' : ''}"><div class="car-sched-label">Restitution${oj ? ' · Open jaw' : ''}</div><div class="car-sched-time">${e.dropoff.time}</div><div class="car-sched-date">${e.dropoff.date}</div><div class="car-sched-loc">${e.dropoff.location}</div></div>${carTagBtn}</div>`;
      let driverH = '';
      if (e.driverName) {
        driverH = `<div class="car-driver"><div class="car-driver-badge">🪪</div><div class="car-driver-text"><div class="car-driver-docs">Permis + CB au nom du conducteur : <strong>${e.driverName}</strong></div></div></div>`;
      }
      bodyH = `<div class="ecard">${topH}${schedH}${driverH}</div>`;
    }
  }

  ct.innerHTML = `<div class="etape-content ${isPast ? 'is-past' : ''}">${bodyH}</div>`;
}

function setState(s) {
  currentState = s;
  selectedEtapes = {};
  renderPanel();
  renderAll();
}
function setColor(c) {
  currentColor = c;
  document.querySelectorAll('[id^="btn-color-"]').forEach(b => b.classList.toggle('active', b.id === 'btn-color-' + c));
  document.body.className = document.body.className.replace(/color-\w+/g, '');
  document.body.classList.add('color-' + c);
  closeSheet();
  if (currentTab === 'timeline') renderAll();
  else updateShowcase();
}
function setLayout(l) {
  currentLayout = l;
  document.querySelectorAll('[id^="btn-layout-"]').forEach(b => b.classList.toggle('active', b.id === 'btn-layout-' + l));
  closeSheet();
  if (currentTab === 'timeline') renderAll();
  else updateShowcase();
}
function setPlatform(p) {
  currentPlatform = p;
  updateShowcase();
}

// ===== Sidebar toggle =====
let _sidebarOpen = window.innerWidth > 640; // open on desktop, closed on mobile
function togglePanel() {
  const isMobile = window.innerWidth <= 640;
  _sidebarOpen = !_sidebarOpen;
  if (isMobile) {
    const sidebar = document.getElementById('proto-sidebar');
    const backdrop = document.getElementById('proto-backdrop');
    sidebar.classList.toggle('open', _sidebarOpen);
    backdrop.classList.toggle('open', _sidebarOpen);
    document.body.style.overflow = _sidebarOpen ? 'hidden' : '';
  } else {
    document.body.classList.toggle('sidebar-collapsed', !_sidebarOpen);
  }
}

function dismissConfig() {
  const isMobile = window.innerWidth <= 640;
  if (isMobile && currentTab === 'ticket') {
    // On mobile ticket tab, dismissing config = back to timeline
    _sidebarOpen = false;
    document.getElementById('proto-sidebar').classList.remove('open');
    document.getElementById('proto-backdrop').classList.remove('open');
    document.body.style.overflow = '';
    setTab('timeline');
  } else {
    togglePanel();
  }
}

// ===== Tabs =====
function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.proto-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  renderPanel();
  const skel = document.getElementById('home-skeleton');
  if (tab === 'timeline') {
    document.getElementById('showcase-container').style.display = 'none';
    document.getElementById('cards-container').style.display = '';
    if (skel) skel.classList.remove('hidden');
    renderAll();
  } else {
    document.getElementById('showcase-container').style.display = 'block';
    document.getElementById('cards-container').style.display = 'none';
    if (skel) skel.classList.add('hidden');
    renderShowcase();
    // Mobile: auto-open config drawer on ticket tab
    if (window.innerWidth <= 640 && !_sidebarOpen) {
      _sidebarOpen = true;
      document.getElementById('proto-sidebar').classList.add('open');
      document.getElementById('proto-backdrop').classList.add('open');
      document.body.style.overflow = 'hidden';
    }
  }
}

function renderPanel() {
  const panel = document.getElementById('proto-panel');
  const titleEl = document.getElementById('proto-sidebar-title');
  const line = (label, controls) => `<div class="proto-line"><span class="proto-line-label">${label}</span><div class="proto-line-controls">${controls}</div></div>`;

  if (titleEl) titleEl.textContent = currentTab === 'timeline' ? 'Paramètres voyage' : 'Paramètres billet';

  if (currentTab === 'timeline') {
    const st = _tlState;
    const pill = (key, val, label) => `<button class="sc-config-pill${st[key] === val ? ' active' : ''}" onclick="tlSet('${key}','${val}')">${label}</button>`;
    const tog = (key, label) => `<span class="sc-toggle-label">${label}</span><button class="sc-toggle${st[key] ? ' on' : ''}" onclick="tlSet('${key}',${!st[key]})"></button>`;

    let h = '';
    h += line('Transport',
      `<button class="sc-config-pill${st.transport ? ' active' : ''}" onclick="tlSet('transport',true)">Oui</button>` +
      `<button class="sc-config-pill${!st.transport ? ' active' : ''}" onclick="tlSet('transport',false)">Non</button>`);

    if (st.transport) {
      h += line('Direction', pill('direction','ar','A/R') + pill('direction','as','Aller simple'));
      h += line('Mode', pill('mode','train','Train') + pill('mode','vol','Avion'));
      if (st.mode === 'vol') {
        h += line('Legs', pill('legs','direct','Direct') + pill('legs','1-stop','1 escale') + pill('legs','multi','Multi'));
      } else {
        h += line('Legs', pill('legs','direct','Direct') + pill('legs','1-stop','Corresp.'));
      }
      if (st.direction === 'ar') {
        h += line('Extras', tog('hotel','Hôtel') + '<span style="width:8px"></span>' + tog('car','Voiture'));
      } else {
        h += line('Extras', tog('car','Voiture'));
      }
    } else {
      h += line('Services', tog('hotel','Hôtel') + '<span style="width:8px"></span>' + tog('car','Voiture'));
    }

    h += '<div class="proto-divider"></div>';
    let etatPills = '';
    ['upcoming','imminent','in_transit','between_segments','trip_ending'].forEach(s => {
      const label = { upcoming:'Upcoming', imminent:'Imminent', in_transit:'Transit', between_segments:'Between', trip_ending:'Ending' }[s];
      etatPills += `<button class="sc-config-pill${currentState === s ? ' active' : ''}" onclick="setState('${s}')">${label}</button>`;
    });
    h += line('État', etatPills);

    panel.innerHTML = h;
  } else {
    // Ticket modal panel
    if (!window._scState) window._scState = { type: 'train', ticket: 'qr-wallet', multi: false, platform: 'ios' };
    const st = window._scState;
    const isTrain = st.type === 'train';
    const isDiffere = st.ticket === 'differe';
    const showMulti = isTrain && !isDiffere;
    const showPlatform = isTrain && st.ticket === 'qr-wallet' && !isDiffere;

    let h = '';
    let typePills = '';
    [['train','Train'],['flight','Avion'],['hotel','Hôtel'],['car','Voiture']].forEach(([k,l]) => {
      typePills += `<button class="sc-config-pill${st.type === k ? ' active' : ''}" onclick="scSet('type','${k}')">${l}</button>`;
    });
    h += line('Type', typePills);

    if (isTrain) {
      let billetPills = '';
      [['qr-wallet','QR+Wallet'],['qr','QR seul'],['pdf','PDF'],['differe','Différé']].forEach(([k,l]) => {
        billetPills += `<button class="sc-config-pill${st.ticket === k ? ' active' : ''}" onclick="scSet('ticket','${k}')">${l}</button>`;
      });
      h += line('Billet', billetPills);
    }
    if (showMulti) {
      h += line('Suppliers', `<button class="sc-toggle${st.multi ? ' on' : ''}" onclick="scSet('multi',${!st.multi})"></button><span class="sc-toggle-label">${st.multi ? 'Multi-billets' : 'Mono'}</span>`);
    }
    if (showPlatform) {
      let platPills = '';
      [['ios','iOS'],['android','Android']].forEach(([k,l]) => {
        platPills += `<button class="sc-config-pill${st.platform === k ? ' active' : ''}" onclick="scSet('platform','${k}')">${l}</button>`;
      });
      h += line('Plateforme', platPills);
    }
    // Mobile: submit button inside drawer
    h += '<div class="proto-panel-submit"><button onclick="submitShowcaseFromDrawer()">Voir le billet</button></div>';
    panel.innerHTML = h;
  }
}
function selectEtape(tripKey, idx) {
  // If mobile carousel exists, scroll to slide (no re-render)
  const carousel = document.querySelector('#etape-' + tripKey + ' .etape-carousel');
  if (carousel) {
    const slide = document.getElementById('slide-' + tripKey + '-' + idx);
    if (slide) slide.scrollIntoView({ behavior: 'instant', inline: 'start', block: 'nearest' });
    selectedEtapes[tripKey] = idx;
    return;
  }
  // Desktop: re-render
  selectedEtapes[tripKey] = idx;
  renderAll();
}

// ===== Bottom Sheet =====
let _sheetEtape = null;
function openSheet(etapeData) {
  _sheetEtape = etapeData;
  // Sync float drawer state with etape's actual ticket data
  if (currentTab === 'timeline' && (etapeData.type === 'train' || etapeData.type === 'flight')) {
    const t = etapeData.ticket || {};
    if (!t.available) _fdState.ticket = 'differe';
    else if (t.hasQR && t.wallet) _fdState.ticket = 'qr-wallet';
    else if (t.hasQR) _fdState.ticket = 'qr';
    else _fdState.ticket = 'pdf';
    // Sync multi from segments
    _fdState.multi = !!(etapeData.segments && etapeData.segments.length > 1 && etapeData.segments.some(s => s.ticket));
  }
  const patched = (currentTab === 'timeline') ? _applyFdOverrides(etapeData) : etapeData;
  _renderSheet(patched);
  // Show float drawer (only in timeline tab)
  if (currentTab === 'timeline') {
    renderFloatDrawer();
    document.getElementById('float-drawer').classList.add('visible');
    document.getElementById('float-drawer').classList.add('open');
  }
}
function switchSheetPlatform(p) {
  currentPlatform = p;
  if (_sheetEtape) {
    const patched = (currentTab === 'timeline') ? _applyFdOverrides(_sheetEtape) : _sheetEtape;
    _renderSheet(patched);
  }
  renderFloatDrawer();
  if (currentTab === 'ticket') updateShowcase();
}
function _renderSheet(etapeData) {
  const overlay = document.getElementById('sheet-overlay');
  const titleEl = document.getElementById('sheet-title');
  const bodyEl = document.getElementById('sheet-body');
  overlay.setAttribute('data-color', currentColor);

  let startDate = '';
  if (etapeData.type === 'train' || etapeData.type === 'flight') {
    startDate = etapeData.departure && etapeData.departure.date || '';
  } else if (etapeData.type === 'hotel') {
    startDate = etapeData.checkin && etapeData.checkin.date || '';
  } else if (etapeData.type === 'car') {
    startDate = etapeData.pickup && etapeData.pickup.date || '';
  }
  let titleText = etapeData.shortLabel || etapeData.title;
  if ((etapeData.type === 'train' || etapeData.type === 'flight') && etapeData.departure && etapeData.arrival) {
    const depLabel = etapeData.departure.code || etapeData.departure.name || '';
    const arrLabel = etapeData.arrival.code || etapeData.arrival.name || '';
    titleText = `${depLabel} \u2192 ${arrLabel}`;
  }
  titleEl.innerHTML = `${dateIcon(startDate)}<span>${titleText}</span>`;

  let content = '';
  if (etapeData.type === 'train' || etapeData.type === 'flight') {
    content = buildTransportSheet(etapeData, currentPlatform);
  } else if (etapeData.type === 'hotel') {
    content = buildHotelSheet(etapeData);
  } else if (etapeData.type === 'car') {
    content = buildCarSheet(etapeData);
  }
  bodyEl.innerHTML = content;

  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  document.addEventListener('keydown', sheetEscHandler);
}

function closeSheet() {
  const overlay = document.getElementById('sheet-overlay');
  overlay.classList.remove('open');
  document.body.style.overflow = '';
  document.removeEventListener('keydown', sheetEscHandler);
  // Hide float drawer
  const fd = document.getElementById('float-drawer');
  fd.classList.remove('visible', 'open');
  // Mobile + ticket tab: reopen config drawer
  if (window.innerWidth <= 640 && currentTab === 'ticket') {
    _sidebarOpen = true;
    document.getElementById('proto-sidebar').classList.add('open');
    document.getElementById('proto-backdrop').classList.add('open');
    document.body.style.overflow = 'hidden';
  }
}

function sheetEscHandler(e) { if (e.key === 'Escape') closeSheet(); }

// ===== Float Drawer =====
// Float drawer state for ticket overrides
const _fdState = {
  ticket: 'qr-wallet',  // 'qr-wallet' | 'qr' | 'pdf' | 'differe'
  multi: false,
};

function toggleFloatDrawer() {
  document.getElementById('float-drawer').classList.toggle('open');
}
function fdSet(key, val) {
  _fdState[key] = val;
  if (_sheetEtape) {
    const patched = _applyFdOverrides(_sheetEtape);
    _renderSheet(patched);
  }
  renderFloatDrawer();
}
function _applyFdOverrides(etape) {
  // Deep-ish clone to avoid mutating POOL data
  const e = JSON.parse(JSON.stringify(etape));
  const st = _fdState;

  if (e.type === 'train' || e.type === 'flight') {
    // Ticket facility
    if (st.ticket === 'differe') {
      e.ticket = { available: false };
      delete e.voucherPdf;
      if (e.segments) e.segments.forEach(s => { s.ticket = { available: false }; });
    } else if (st.ticket === 'pdf') {
      e.ticket = { available: true, hasQR: false, wallet: false };
      e.voucherPdf = e.type === 'flight' ? 'voucher-flight.pdf' : 'voucher-train.pdf';
      if (e.segments) e.segments.forEach(s => { s.ticket = null; });
    } else if (st.ticket === 'qr') {
      e.ticket = { available: true, hasQR: true, wallet: false };
      delete e.voucherPdf;
      if (e.segments && st.multi) e.segments.forEach(s => { s.ticket = { available: true, hasQR: true, wallet: false }; });
      else if (e.segments) e.segments.forEach(s => { s.ticket = null; });
    } else {
      // qr-wallet
      e.ticket = { available: true, hasQR: true, wallet: true };
      delete e.voucherPdf;
      if (e.segments && st.multi) e.segments.forEach(s => { s.ticket = { available: true, hasQR: true, wallet: true }; });
      else if (e.segments) e.segments.forEach(s => { s.ticket = null; });
    }

    // Multi-supplier: give each segment its own ticket
    if (st.multi && e.segments && e.segments.length > 1) {
      e.segments.forEach(s => {
        if (!s.ticket) s.ticket = e.ticket ? {...e.ticket} : { available: true, hasQR: true, wallet: true };
      });
    } else if (!st.multi && e.segments) {
      e.segments.forEach(s => { s.ticket = null; });
    }
  }
  return e;
}
function renderFloatDrawer() {
  const body = document.getElementById('float-drawer-body');
  const e = _sheetEtape;
  const isTransport = e && (e.type === 'train' || e.type === 'flight');
  const hasSegs = e && e.segments && e.segments.length > 1;
  const st = _fdState;

  let h = '';

  const isFlight = e && e.type === 'flight';
  if (isTransport) {
    // Ticket row — options depend on type (flights: PDF/Diff only, trains: all)
    const ticketOpts = isFlight
      ? [['pdf','PDF'],['differe','Diff.']]
      : [['qr-wallet','QR+W'],['qr','QR'],['pdf','PDF'],['differe','Diff.']];
    h += '<div class="fd-row"><span class="fd-label">Ticket</span>';
    ticketOpts.forEach(([k, l]) => {
      h += `<button class="fd-pill${st.ticket === k ? ' active' : ''}" onclick="fdSet('ticket','${k}')">${l}</button>`;
    });
    h += '</div>';

    // Multi-supplier row (only if multi-segment)
    if (hasSegs) {
      h += `<div class="fd-row"><span class="fd-label">Multi</span><button class="fd-toggle${st.multi ? ' on' : ''}" onclick="fdSet('multi',${!st.multi})"></button><span style="font-size:10px;color:var(--grey-500);margin-left:2px">${st.multi ? 'Multi-billets' : 'Mono'}</span></div>`;
    }

    // Platform row — only if wallet (QR+W)
    if (st.ticket === 'qr-wallet') {
      h += '<div class="fd-row"><span class="fd-label">Plat.</span>';
      ['desktop', 'ios', 'android'].forEach(p => {
        const lbl = p === 'desktop' ? 'Desktop' : p === 'ios' ? 'iOS' : 'Android';
        h += `<button class="fd-pill${p === currentPlatform ? ' active' : ''}" onclick="switchSheetPlatform('${p}')">${lbl}</button>`;
      });
      h += '</div>';
    }
  } else {
    // Non-transport: just platform
    h += '<div class="fd-row"><span class="fd-label">Plat.</span>';
    ['desktop', 'ios', 'android'].forEach(p => {
      const lbl = p === 'desktop' ? 'Desktop' : p === 'ios' ? 'iOS' : 'Android';
      h += `<button class="fd-pill${p === currentPlatform ? ' active' : ''}" onclick="switchSheetPlatform('${p}')">${lbl}</button>`;
    });
    h += '</div>';
  }

  body.innerHTML = h;
}

// Official wallet badges (local SVG files)
const appleWalletBadge = `<a href="#" class="wallet-badge wallet-badge-apple" onclick="event.preventDefault()"><img src="badges/FR_Add_to_Apple_Wallet_RGB_102921.svg" alt="Ajouter à Apple Wallet"></a>`;
const googleWalletBadge = `<a href="#" class="wallet-badge wallet-badge-google" onclick="event.preventDefault()"><img src="badges/frFR_add_to_google_wallet_add-wallet-badge.svg" alt="Ajouter à Google Wallet"></a>`;

const pdfDocSvg = '<svg viewBox="0 0 24 28" fill="none"><path d="M2 4a2 2 0 0 1 2-2h10l8 8v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4z" fill="white" fill-opacity="0.9"/><path d="M14 2l8 8h-6a2 2 0 0 1-2-2V2z" fill="white" fill-opacity="0.6"/><text x="12" y="21" text-anchor="middle" font-size="7" font-weight="800" fill="#e53935" font-family="system-ui">PDF</text></svg>';

const qrPlaceholderSvg = '<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="25" height="25" rx="2" stroke="currentColor" stroke-width="3"/><rect x="10" y="10" width="15" height="15" rx="1" fill="currentColor"/><rect x="70" y="5" width="25" height="25" rx="2" stroke="currentColor" stroke-width="3"/><rect x="75" y="10" width="15" height="15" rx="1" fill="currentColor"/><rect x="5" y="70" width="25" height="25" rx="2" stroke="currentColor" stroke-width="3"/><rect x="10" y="75" width="15" height="15" rx="1" fill="currentColor"/><rect x="38" y="5" width="8" height="8" fill="currentColor"/><rect x="50" y="5" width="8" height="8" fill="currentColor"/><rect x="38" y="17" width="8" height="8" fill="currentColor"/><rect x="5" y="38" width="8" height="8" fill="currentColor"/><rect x="17" y="38" width="8" height="8" fill="currentColor"/><rect x="5" y="50" width="8" height="8" fill="currentColor"/><rect x="38" y="38" width="8" height="8" fill="currentColor"/><rect x="50" y="38" width="8" height="8" fill="currentColor"/><rect x="62" y="38" width="8" height="8" fill="currentColor"/><rect x="38" y="50" width="8" height="8" fill="currentColor"/><rect x="62" y="50" width="8" height="8" fill="currentColor"/><rect x="50" y="62" width="8" height="8" fill="currentColor"/><rect x="62" y="62" width="8" height="8" fill="currentColor"/><rect x="74" y="62" width="8" height="8" fill="currentColor"/><rect x="86" y="62" width="8" height="8" fill="currentColor"/><rect x="74" y="50" width="8" height="8" fill="currentColor"/><rect x="86" y="38" width="8" height="8" fill="currentColor"/><rect x="38" y="74" width="8" height="8" fill="currentColor"/><rect x="50" y="86" width="8" height="8" fill="currentColor"/><rect x="62" y="74" width="8" height="8" fill="currentColor"/><rect x="74" y="86" width="8" height="8" fill="currentColor"/><rect x="86" y="74" width="8" height="8" fill="currentColor"/><rect x="86" y="86" width="8" height="8" fill="currentColor"/></svg>';

function buildTransportSheet(e, platform) {
  const isFl = e.type === 'flight';
  const isMobile = platform === 'ios' || platform === 'android';

  // Multi-segment
  if (e.segments && e.segments.length > 1) {
    const segs = e.segments;
    const hasPerSegTicket = segs.some(s => s.ticket);

    // Same supplier / single ticket for the whole leg → one QR + route summary
    if (!hasPerSegTicket) {
      const ticket = e.ticket || {};
      const depSeg = segs[0], arrSeg = segs[segs.length - 1];
      const depN = depSeg.dep.code || depSeg.dep.name || '';
      const arrN = arrSeg.arr.code || arrSeg.arr.name || '';
      const conn = e.connections || [];
      const stops = conn.map(c => c.loc).join(', ');
      let h = '';
      h += `<div class="sheet-ticket-label">${e.carrier || ''}</div>`;
      h += `<div class="sheet-ticket-route">${depN} \u2192 ${arrN}${stops ? ' \u00b7 via ' + stops : ''}</div>`;
      if (ticket.available !== false && ticket.hasQR) {
        h += `<div class="sheet-qr">${qrPlaceholderSvg}<div class="sheet-qr-label">Pr\u00e9sentez au contr\u00f4leur</div></div>`;
      } else if (ticket.available !== false && e.voucherPdf) {
        const docName = isFl ? 'Confirmation' : 'Billet';
        h += `<a href="${e.voucherPdf}" target="_blank" class="sheet-pdf"><iframe src="${e.voucherPdf}#toolbar=0&view=Fit&page=1" title="PDF"></iframe></a>`;
      }
      h += buildFederalActions(e, platform);
      return h;
    }

    // Different suppliers / per-segment tickets → carousel
    const cid = 'stc-' + Math.random().toString(36).slice(2, 8);
    let h = `<div class="sheet-ticket-carousel" id="${cid}">`;
    segs.forEach((seg, i) => {
      const ticket = seg.ticket || {};
      const depN = seg.dep.code || seg.dep.name || '';
      const arrN = seg.arr.code || seg.arr.name || '';
      const depT = seg.dep.time || '';
      const arrT = seg.arr.time || '';
      const carrier = seg.carrier || e.carrier || '';
      const num = seg.num || '';
      h += `<div class="sheet-ticket-slide${i === 0 ? ' active' : ''}">`;
      h += `<div class="sheet-ticket-label">${carrier} ${num}</div>`;
      h += `<div class="sheet-ticket-route">${depN} \u2192 ${arrN} \u00b7 ${depT}\u2009\u2013\u2009${arrT}</div>`;
      if (ticket.available !== false) {
        if (ticket.hasQR) {
          h += `<div class="sheet-qr">${qrPlaceholderSvg}<div class="sheet-qr-label">Pr\u00e9sentez au contr\u00f4leur</div></div>`;
        } else if (seg.voucherPdf) {
          const docName = isFl ? 'Confirmation' : 'Billet';
          h += `<a href="${seg.voucherPdf}" target="_blank" class="sheet-pdf"><iframe src="${seg.voucherPdf}#toolbar=0&view=Fit&page=1" title="PDF"></iframe></a>`;
        }
      }
      h += '</div>';
    });
    h += '<div class="sheet-ticket-nav">';
    h += `<button onclick="sheetCarouselNav('${cid}',-1)" disabled><span class="material-symbols-rounded">chevron_left</span></button>`;
    h += `<span class="sheet-ticket-counter">1 / ${segs.length}</span>`;
    h += `<button onclick="sheetCarouselNav('${cid}',1)"><span class="material-symbols-rounded">chevron_right</span></button>`;
    h += '</div></div>';
    h += buildFederalActions(e, platform, true);
    return h;
  }

  // Single segment (or no segments)
  return buildSingleTicketSection(e, platform);
}

function sheetCarouselNav(id, dir) {
  const el = document.getElementById(id);
  if (!el) return;
  const slides = el.querySelectorAll('.sheet-ticket-slide');
  let cur = [...slides].findIndex(s => s.classList.contains('active'));
  slides[cur].classList.remove('active');
  cur = Math.max(0, Math.min(slides.length - 1, cur + dir));
  slides[cur].classList.add('active');
  el.querySelector('.sheet-ticket-counter').textContent = (cur + 1) + ' / ' + slides.length;
  const btns = el.querySelectorAll('.sheet-ticket-nav button');
  btns[0].disabled = cur === 0;
  btns[1].disabled = cur === slides.length - 1;
}

function buildFederalActions(e, platform, multipleTickets) {
  const ticket = e.ticket || {};
  const isFl = e.type === 'flight';
  const isMobile = platform === 'ios' || platform === 'android';
  const segsWallet = (e.segments || []).some(s => s.ticket && s.ticket.wallet);
  const hasWallet = isMobile && (ticket.wallet || segsWallet);
  const segs = e.segments || [];
  const nums = segs.length > 1 ? segs.map(s => s.num || '').filter(Boolean).join(', ') : (e.num || '');
  const docName = multipleTickets ? 'Tous les billets' : (isFl ? 'Confirmation' : 'Billet') + ' ' + (e.carrier || '') + (nums ? ' ' + nums : '');
  const dlMeta = (e._travelerName || '') + (e._travelerName && e.pnr ? ' \u00b7 ' : '') + (e.pnr || '');
  let h = '<div class="sheet-divider"></div>';
  h += '<div class="sheet-dl-row">';
  h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${docName}</div><div class="sheet-dl-meta">${dlMeta || 'PDF'}</div></div>`;
  h += `<button class="sheet-dl-btn" onclick="event.preventDefault()" title="T\u00e9l\u00e9charger"><span class="material-symbols-rounded">download</span></button>`;
  h += '</div>';
  if (hasWallet) {
    h += '<div class="sheet-wallet-row">';
    h += (platform === 'ios') ? appleWalletBadge : googleWalletBadge;
    h += '</div>';
  }
  return h;
}

function buildSingleTicketSection(e, platform) {
  const ticket = e.ticket || {};
  const isFl = e.type === 'flight';
  const isMobile = platform === 'ios' || platform === 'android';
  let h = '';

  // Deferred ticket
  if (!ticket.available) {
    h += `<div class="sheet-info"><span class="sheet-info-icon">&#128197;</span><div>Votre billet sera disponible à partir du <strong>${ticket.availableDate || '\u2014'}</strong>. Certains transporteurs n'émettent les billets que quelques jours avant le départ.${isFl ? '<br>Pensez ensuite à vous enregistrer auprès de la compagnie aérienne.' : ''}</div></div>`;
    h += '<div class="sheet-actions"><span class="cta-pri disabled">Billet pas encore disponible</span></div>';
    return h;
  }

  // Visual: QR code or clickable PDF document
  if (ticket.hasQR) {
    h += `<div class="sheet-qr">${qrPlaceholderSvg}<div class="sheet-qr-label">Présentez au contrôleur</div></div>`;
  } else {
    const docName = isFl ? 'Confirmation' : 'Billet';
    const carrier = e.carrier || '';
    const num = e.num || '';
    const paxMeta = (e._travelerName || '') + (e._travelerName && e.pnr ? ' \u00b7 ' : '') + (e.pnr || '');
    if (e.voucherPdf) {
      h += `<a href="${e.voucherPdf}" target="_blank" class="sheet-pdf"><iframe src="${e.voucherPdf}#toolbar=0&view=Fit&page=1" title="PDF"></iframe></a>`;
      h += '<div class="sheet-dl-row">';
      h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${docName} ${carrier} ${num}</div><div class="sheet-dl-meta">${paxMeta || 'PDF'}</div></div>`;
      h += `<a href="${e.voucherPdf}" target="_blank" download class="sheet-dl-btn" title="Télécharger"><span class="material-symbols-rounded">download</span></a>`;
      h += '</div>';
    } else {
      h += `<a href="#" class="sheet-doc" onclick="event.preventDefault()"><div class="sheet-doc-icon">${pdfDocSvg}</div><div class="sheet-doc-info"><div class="sheet-doc-name">${docName} ${carrier} ${num}</div><div class="sheet-doc-meta">${paxMeta || 'PDF'}</div></div></a>`;
    }
  }

  // Actions — always show ticket info dl-row, wallet below if available
  const hasWallet = isMobile && ticket.wallet;
  if (ticket.hasQR) {
    const docName = isFl ? 'Confirmation' : 'Billet';
    const dlMeta = (e._travelerName || '') + (e._travelerName && e.pnr ? ' \u00b7 ' : '') + (e.pnr || '');
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${docName} ${e.carrier || ''} ${e.num || ''}</div><div class="sheet-dl-meta">${dlMeta || 'PDF'}</div></div>`;
    h += `<button class="sheet-dl-btn" onclick="event.preventDefault()" title="T\u00e9l\u00e9charger"><span class="material-symbols-rounded">download</span></button>`;
    h += '</div>';
  }
  if (hasWallet) {
    h += '<div class="sheet-wallet-row">';
    h += (platform === 'ios') ? appleWalletBadge : googleWalletBadge;
    h += '</div>';
  }
  if (isFl && !hasWallet && !ticket.hasQR) {
    h += `<div class="sheet-info" style="margin-top:8px;margin-bottom:0"><span class="sheet-info-icon">&#9432;</span><div>Confirmation de r\u00e9servation. Enregistrez-vous aupr\u00e8s de la compagnie pour obtenir votre carte d\u2019embarquement.</div></div>`;
  }

  return h;
}

function mapsLink(query) { return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query); }
function mapBtn(url) { return `<a href="${url}" target="_blank" class="sheet-map-btn" title="Voir sur la carte"><span class="material-symbols-rounded">location_on</span></a>`; }

function buildHotelSheet(e) {
  let h = '';
  const mUrl = e.address ? mapsLink(e.address) : e.locUrl;
  // PDF preview when available
  if (e.voucherPdf) {
    h += `<a href="${e.voucherPdf}" target="_blank" class="sheet-pdf"><iframe src="${e.voucherPdf}#toolbar=0&view=Fit&page=1" title="PDF"></iframe></a>`;
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">Voucher ${e.shortLabel || e.title || ''}</div><div class="sheet-dl-meta">PDF · ${e.bookingRef || ''}</div></div>`;
    if (mUrl) h += mapBtn(mUrl);
    h += `<a href="${e.voucherPdf}" target="_blank" download class="sheet-dl-btn" title="Télécharger"><span class="material-symbols-rounded">download</span></a>`;
    h += '</div>';
  } else if (e.docAvailable) {
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${e.docLabel || 'Voucher'}</div><div class="sheet-dl-meta">${e.bookingRef || ''}</div></div>`;
    if (mUrl) h += mapBtn(mUrl);
    h += '</div>';
  } else if (mUrl) {
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${e.shortLabel || e.title || ''}</div></div>`;
    h += mapBtn(mUrl);
    h += '</div>';
  }
  // Booking details grid
  h += '<div class="sheet-detail-grid">';
  if (e.checkin) {
    h += `<div><div class="sheet-detail-label">Check-in</div><div class="sheet-detail-value">${e.checkin.time}</div><div class="sheet-detail-sub">${e.checkin.date}</div></div>`;
  }
  if (e.checkout) {
    h += `<div><div class="sheet-detail-label">Check-out · ${e.nights || ''} nuit${(e.nights || 0) > 1 ? 's' : ''}</div><div class="sheet-detail-value">${e.checkout.time}</div><div class="sheet-detail-sub">${e.checkout.date}</div></div>`;
  }
  if (e.roomName) {
    h += `<div><div class="sheet-detail-label">Chambre</div><div class="sheet-detail-value">${e.roomName}</div></div>`;
  }
  if (e.bookingRef) {
    h += `<div><div class="sheet-detail-label">Référence</div><div class="sheet-detail-value">${e.bookingRef}</div></div>`;
  }
  if (e.address) {
    h += `<div class="sheet-detail-full"><div class="sheet-detail-label">Adresse</div><div class="sheet-detail-sub">${e.address}</div></div>`;
  }
  h += '</div>';
  // Free-text conditions
  if (e.freeTextConditions) {
    h += `<div class="sheet-conditions">${e.freeTextConditions}</div>`;
  }
  return h;
}

function buildCarSheet(e) {
  const isOJ = e.pickup && e.dropoff && e.pickup.location !== e.dropoff.location;
  const mUrl = e.pickup ? mapsLink(e.pickup.location) : e.locUrl;
  let h = '';
  // PDF preview when available
  if (e.voucherPdf) {
    h += `<a href="${e.voucherPdf}" target="_blank" class="sheet-pdf"><iframe src="${e.voucherPdf}#toolbar=0&view=Fit&page=1" title="PDF"></iframe></a>`;
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">Voucher ${e.carrier || e.title || ''}</div><div class="sheet-dl-meta">PDF · ${e.bookingRef || ''}</div></div>`;
    if (mUrl && !isOJ) h += mapBtn(mUrl);
    h += `<a href="${e.voucherPdf}" target="_blank" download class="sheet-dl-btn" title="Télécharger"><span class="material-symbols-rounded">download</span></a>`;
    h += '</div>';
  } else if (e.docAvailable) {
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${e.docLabel || 'Voucher'}</div><div class="sheet-dl-meta">${e.bookingRef || ''}</div></div>`;
    if (mUrl && !isOJ) h += mapBtn(mUrl);
    h += '</div>';
  } else if (mUrl && !isOJ) {
    h += '<div class="sheet-dl-row">';
    h += `<div class="sheet-dl-info"><div class="sheet-dl-name">${e.carrier || e.title || ''}</div></div>`;
    h += mapBtn(mUrl);
    h += '</div>';
  }
  // Booking details grid
  h += '<div class="sheet-detail-grid">';
  if (e.pickup) {
    h += `<div><div class="sheet-detail-label">Prise en charge</div><div class="sheet-detail-value">${e.pickup.time}</div><div class="sheet-detail-sub">${e.pickup.date}</div><div class="sheet-detail-sub">${e.pickup.location}</div></div>`;
  }
  if (e.dropoff) {
    h += `<div><div class="sheet-detail-label">Restitution${isOJ ? ' · Open jaw' : ''}</div><div class="sheet-detail-value">${e.dropoff.time}</div><div class="sheet-detail-sub">${e.dropoff.date}</div><div class="sheet-detail-sub">${e.dropoff.location}</div></div>`;
  }
  if (e.title) {
    h += `<div><div class="sheet-detail-label">Véhicule</div><div class="sheet-detail-value">${e.title}</div></div>`;
  }
  if (e.bookingRef) {
    h += `<div><div class="sheet-detail-label">Référence</div><div class="sheet-detail-value">${e.bookingRef}</div></div>`;
  }
  if (e.driverName) {
    h += `<div class="sheet-detail-full"><div class="sheet-detail-label">Conducteur</div><div class="sheet-detail-sub">🪪 Permis + CB au nom de <strong>${e.driverName}</strong></div></div>`;
  }
  h += '</div>';
  return h;
}

// Swipe-down to close (mobile) — only from handle/header area
(function() {
  const panel = document.querySelector('.sheet-panel');
  const body = document.getElementById('sheet-body');
  let startY = 0, currentY = 0, isDragging = false;
  // Only allow swipe-to-close from handle or header, not from scrollable body
  panel.addEventListener('touchstart', (e) => {
    const tgt = e.target.closest('.sheet-handle, .sheet-header');
    if (!tgt) return;
    startY = e.touches[0].clientY;
    isDragging = true;
  });
  panel.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    const delta = currentY - startY;
    if (delta > 0) {
      panel.style.transform = `translateY(${delta}px)`;
      e.preventDefault();
    }
  }, { passive: false });
  panel.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;
    const delta = currentY - startY;
    if (delta > 100) closeSheet();
    panel.style.transform = '';
    currentY = 0;
  });
})();

// ===== Showcase (Ticket modal) =====
function updateShowcase() {
  const sc = document.getElementById('showcase-container');
  if (sc.style.display === 'block') renderShowcase();
}

function renderShowcase() {
  const sc = document.getElementById('showcase-container');
  sc.setAttribute('data-color', currentColor);
  if (!window._scState) window._scState = { type: 'train', ticket: 'qr-wallet', multi: false, platform: 'ios' };
  const st = window._scState;

  const isTrain = st.type === 'train';
  const isDiffere = st.ticket === 'differe';
  const showPlatform = isTrain && st.ticket === 'qr-wallet' && !isDiffere;

  let html = '';

  // Build mock data
  const base = { _travelerName: 'Stella Smith', locUrl: '#' };
  const trainDep = { name: 'Paris Montparnasse' };
  const trainArr = { name: 'Bordeaux Saint-Jean' };
  const flightDep = { name: 'Paris', code: 'CDG' };
  const flightArr = { name: 'Nice', code: 'NCE' };

  let content = '', headerTitle = '', panelLabel = '';

  if (st.type === 'hotel') {
    const me = { ...base, type: 'hotel',
      checkin: { date: 'Vendredi 9 F\u00e9vrier', time: '15:00' },
      checkout: { date: 'Dimanche 11 F\u00e9vrier', time: '11:00' },
      nights: 3, roomName: 'Chambre Deluxe Double', bookingRef: 'MRR-482910',
      address: '15 Rue du Temple, 33000 Bordeaux',
      freeTextConditions: 'R\u00e9cup\u00e9rez votre cl\u00e9 \u00e0 la r\u00e9ception. Check-in \u00e0 partir de 15h. R\u00e9ception ouverte 24h/24.',
      voucherPdf: 'voucher-hotel.pdf', docAvailable: true,
      shortLabel: 'H\u00f4tel Renaissance Bordeaux', title: 'H\u00f4tel Renaissance Bordeaux',
    };
    headerTitle = dateIcon('Vendredi 9 F\u00e9vrier') + '<span>H\u00f4tel Renaissance Bordeaux</span>';
    content = buildHotelSheet(me);
    panelLabel = 'H\u00f4tel \u2014 PDF voucher';
  } else if (st.type === 'car') {
    const me = { ...base, type: 'car',
      pickup: { time: '14:00', date: 'Mardi 17 F\u00e9vrier', location: 'Gare Saint-Jean, Bordeaux' },
      dropoff: { time: '18:00', date: 'Mardi 17 F\u00e9vrier', location: 'Gare Saint-Jean, Bordeaux' },
      carrier: 'Avis', title: 'Avis \u2013 Cat. B Compacte', bookingRef: 'AVIS-84729',
      driverName: 'Stella Smith', voucherPdf: 'voucher-hotel.pdf', docAvailable: true,
    };
    headerTitle = dateIcon('Mardi 17 F\u00e9vrier') + '<span>Avis \u2014 Voiture</span>';
    content = buildCarSheet(me);
    panelLabel = 'Voiture \u2014 PDF voucher';
  } else if (st.type === 'flight') {
    // Avion — toujours PDF confirmation, un par leg, pas de QR/wallet
    const me = { ...base, type: 'flight', carrier: 'Air France', num: 'AF 1234', pnr: 'ABC123',
      ticket: { available: true, hasQR: false, wallet: false },
      departure: flightDep, arrival: flightArr, voucherPdf: 'voucher-flight.pdf' };
    headerTitle = dateIcon('Ven. 09 F\u00e9v') + '<span>CDG \u2192 NCE</span>';
    content = buildTransportSheet(me, 'desktop');
    panelLabel = 'Confirmation de r\u00e9servation \u00b7 Air France AF 1234';
  } else {
    // Train
    const dep = trainDep, arr = trainArr;
    const depL = dep.name, arrL = arr.name;
    const platform = showPlatform ? st.platform : 'desktop';

    if (isDiffere) {
      // Différé — billet pas encore émis
      const me = { ...base, type: 'train', carrier: 'SNCF', num: 'TGV 9012', pnr: 'UVWX90',
        ticket: { available: false, availableDate: '15 mars 2026' },
        departure: dep, arrival: arr };
      headerTitle = dateIcon('Ven. 09 F\u00e9v') + '<span>' + depL + ' \u2192 ' + arrL + '</span>';
      content = buildTransportSheet(me, 'desktop');
      panelLabel = 'Diff\u00e9r\u00e9 \u00b7 SNCF TGV 9012';
    } else if (st.multi) {
      // Multi-billets carousel
      const hasQR = st.ticket !== 'pdf';
      const hasWallet = st.ticket === 'qr-wallet';
      const me = { ...base, type: 'train', departure: dep, arrival: arr,
        carrier: 'SNCF', pnr: 'XYZW89',
        ticket: { available: true, hasQR: hasQR, wallet: false },
        dep: trainDep, arr: trainArr,
        segments: [
          { dep: { time: '08:30', name: 'Paris Montparnasse' }, arr: { time: '10:32', name: 'Lyon Part-Dieu' }, dur: '2h02', num: '6211', carrier: 'inOUI',
            ticket: { available: true, hasQR: hasQR, wallet: hasWallet }, ...(hasQR ? {} : { voucherPdf: 'voucher-train.pdf' }) },
          { dep: { time: '11:15', name: 'Lyon Part-Dieu' }, arr: { time: '14:28', name: 'Bordeaux Saint-Jean' }, dur: '3h13', num: '7641', carrier: 'OUIGO',
            ticket: { available: true, hasQR: hasQR, wallet: false }, ...(hasQR ? {} : { voucherPdf: 'voucher-train.pdf' }) },
        ],
        connections: [{ loc: 'Lyon Part-Dieu', dur: '43 min' }],
      };
      headerTitle = dateIcon('Ven. 09 F\u00e9v') + '<span>' + depL + ' \u2192 ' + arrL + '</span>';
      content = buildTransportSheet(me, hasWallet ? (st.platform || 'ios') : 'desktop');
      const billetType = st.ticket === 'qr-wallet' ? 'QR+Wallet' : (st.ticket === 'qr' ? 'QR' : 'PDF');
      panelLabel = 'Multi-billets ' + billetType + ' \u00b7 inOUI + OUIGO';
    } else {
      // Direct — un seul billet
      const carrier = st.ticket === 'qr' ? 'OUIGO' : 'SNCF';
      const num = st.ticket === 'qr' ? '7641' : 'TGV 6234';
      let ticket = {}, voucherPdf;
      if (st.ticket === 'qr-wallet') {
        ticket = { available: true, hasQR: true, wallet: true };
        panelLabel = 'QR + ' + (platform === 'ios' ? 'Apple' : 'Google') + ' Wallet \u00b7 ' + carrier + ' ' + num;
      } else if (st.ticket === 'qr') {
        ticket = { available: true, hasQR: true, wallet: false };
        panelLabel = 'QR seul \u00b7 ' + carrier + ' ' + num;
      } else {
        ticket = { available: true, hasQR: false, wallet: false };
        voucherPdf = 'voucher-train.pdf';
        panelLabel = 'PDF \u00b7 ' + carrier + ' ' + num;
      }
      const me = { ...base, type: 'train', carrier, num, pnr: 'HJKL42', ticket, departure: dep, arrival: arr, ...(voucherPdf ? { voucherPdf } : {}) };
      headerTitle = dateIcon('Ven. 09 F\u00e9v') + '<span>' + depL + ' \u2192 ' + arrL + '</span>';
      content = buildTransportSheet(me, platform);
    }
  }

  // Store mock etape for mobile sheet trigger
  window._scMockEtape = _scBuildMockEtape();

  // Render preview (desktop) + CTA button (mobile)
  const headerH = '<div class="sheet-header"><div class="sheet-title">' + headerTitle + '</div><button class="sheet-close" disabled>&#10005;</button></div>';
  html += '<div class="sc-preview"><div class="showcase-item"><div class="showcase-label">' + panelLabel + '</div><div class="showcase-panel">' + headerH + '<div class="sheet-body">' + content + '</div></div></div></div>';
  html += '<div class="sc-mobile-cta"><button onclick="openShowcaseSheet()">Voir le billet</button><div class="sc-mobile-hint">' + panelLabel + '</div></div>';
  sc.innerHTML = html;
}

function _scBuildMockEtape() {
  if (!window._scState) return null;
  const st = window._scState;
  const base = { _travelerName: 'Stella Smith', locUrl: '#' };
  const trainDep = { name: 'Paris Montparnasse' };
  const trainArr = { name: 'Bordeaux Saint-Jean' };
  const flightDep = { name: 'Paris', code: 'CDG' };
  const flightArr = { name: 'Nice', code: 'NCE' };
  const isTrain = st.type === 'train';
  const isDiffere = st.ticket === 'differe';
  const showPlatform = isTrain && st.ticket === 'qr-wallet' && !isDiffere;

  if (st.type === 'hotel') {
    return { ...base, type: 'hotel', checkin: { date: 'Vendredi 9 F\u00e9vrier', time: '15:00' }, checkout: { date: 'Dimanche 11 F\u00e9vrier', time: '11:00' }, nights: 3, roomName: 'Chambre Deluxe Double', bookingRef: 'MRR-482910', address: '15 Rue du Temple, 33000 Bordeaux', freeTextConditions: 'R\u00e9cup\u00e9rez votre cl\u00e9 \u00e0 la r\u00e9ception. Check-in \u00e0 partir de 15h.', voucherPdf: 'voucher-hotel.pdf', docAvailable: true, shortLabel: 'H\u00f4tel Renaissance Bordeaux', title: 'H\u00f4tel Renaissance Bordeaux' };
  }
  if (st.type === 'car') {
    return { ...base, type: 'car', pickup: { time: '14:00', date: 'Mardi 17 F\u00e9vrier', location: 'Gare Saint-Jean, Bordeaux' }, dropoff: { time: '18:00', date: 'Mardi 17 F\u00e9vrier', location: 'Gare Saint-Jean, Bordeaux' }, carrier: 'Avis', title: 'Avis \u2013 Cat. B Compacte', bookingRef: 'AVIS-84729', driverName: 'Stella Smith', voucherPdf: 'voucher-hotel.pdf', docAvailable: true };
  }
  if (st.type === 'flight') {
    return { ...base, type: 'flight', carrier: 'Air France', num: 'AF 1234', pnr: 'ABC123', ticket: { available: true, hasQR: false, wallet: false }, departure: flightDep, arrival: flightArr, voucherPdf: 'voucher-flight.pdf' };
  }
  // Train
  if (isDiffere) {
    return { ...base, type: 'train', carrier: 'SNCF', num: 'TGV 9012', pnr: 'UVWX90', ticket: { available: false, availableDate: '15 mars 2026' }, departure: trainDep, arrival: trainArr };
  }
  if (st.multi) {
    const hasQR = st.ticket !== 'pdf', hasWallet = st.ticket === 'qr-wallet';
    return { ...base, type: 'train', departure: trainDep, arrival: trainArr, carrier: 'SNCF', pnr: 'XYZW89', ticket: { available: true, hasQR, wallet: false },
      segments: [
        { dep: { time: '08:30', name: 'Paris Montparnasse' }, arr: { time: '10:32', name: 'Lyon Part-Dieu' }, dur: '2h02', num: '6211', carrier: 'inOUI', ticket: { available: true, hasQR, wallet: hasWallet }, ...(hasQR ? {} : { voucherPdf: 'voucher-train.pdf' }) },
        { dep: { time: '11:15', name: 'Lyon Part-Dieu' }, arr: { time: '14:28', name: 'Bordeaux Saint-Jean' }, dur: '3h13', num: '7641', carrier: 'OUIGO', ticket: { available: true, hasQR, wallet: false }, ...(hasQR ? {} : { voucherPdf: 'voucher-train.pdf' }) },
      ],
      connections: [{ loc: 'Lyon Part-Dieu', dur: '43 min' }],
    };
  }
  // Direct
  const carrier = st.ticket === 'qr' ? 'OUIGO' : 'SNCF';
  const num = st.ticket === 'qr' ? '7641' : 'TGV 6234';
  let ticket = {}, voucherPdf;
  if (st.ticket === 'qr-wallet') ticket = { available: true, hasQR: true, wallet: true };
  else if (st.ticket === 'qr') ticket = { available: true, hasQR: true, wallet: false };
  else { ticket = { available: true, hasQR: false, wallet: false }; voucherPdf = 'voucher-train.pdf'; }
  return { ...base, type: 'train', carrier, num, pnr: 'HJKL42', ticket, departure: trainDep, arrival: trainArr, ...(voucherPdf ? { voucherPdf } : {}) };
}

function openShowcaseSheet() {
  const etape = window._scMockEtape;
  if (!etape) return;
  const st = window._scState || {};
  if (st.platform) currentPlatform = st.platform;
  openSheet(etape);
}

function submitShowcaseFromDrawer() {
  // Close the drawer first
  if (_sidebarOpen && window.innerWidth <= 640) {
    _sidebarOpen = false;
    document.getElementById('proto-sidebar').classList.remove('open');
    document.getElementById('proto-backdrop').classList.remove('open');
    document.body.style.overflow = '';
  }
  // Rebuild mock + open sheet
  renderShowcase();
  openShowcaseSheet();
}

function scSet(key, val) {
  if (!window._scState) window._scState = { type: 'train', ticket: 'qr-wallet', multi: false, platform: 'ios' };
  window._scState[key] = val;
  if (key === 'type' && val === 'train') {
    if (!['qr-wallet','qr','pdf','differe'].includes(window._scState.ticket)) {
      window._scState.ticket = 'qr-wallet';
    }
  }
  if (window._scState.ticket === 'differe') {
    window._scState.multi = false;
  }
  renderPanel();
  renderShowcase();
}

renderPanel();
renderAll();
</script>
</body>
</html>
